<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Osa 4</title>
  <meta name="description" content="">

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="http://localhost:4000/osa4/">
  <link rel="alternate" type="application/rss+xml" title="Ohjelmistotuotanto avoin yliopisto 2020" href="/feed.xml">

  
</head>


  <body>
    
    <header class="site-header" role="banner">

  <div class="wrapper">
    
    
    <a class="site-title" href="/">Ohjelmistotuotanto avoin yliopisto 2020</a>
    
    
      <nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
              <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
              <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger">
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
            <a class="page-link" href="/osa0/">Osa 0</a>
            
          
            
            
            <a class="page-link" href="/osa1/">Osa 1</a>
            
          
            
            
            <a class="page-link" href="/osa2/">Osa 2</a>
            
          
            
            
            <a class="page-link" href="/osa3/">Osa 3</a>
            
          
            
            
            <a class="page-link" href="/osa4/">Osa 4</a>
            
          
            
            
            <a class="page-link" href="/osa5/">Osa 5</a>
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
            <a class="page-link" href="/tehtavat/">Tehtävät</a>
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
          
        </div>
      </nav>
    

    
  </div>
</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post">

  <header class="post-header">
    <h1 class="post-title">Ohjelmistojen suunnittelu</h1>
  </header>

  <div class="post-content">
    <p><a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/">
  <img alt="Creative Commons -lisenssi" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/3.0/88x31.png" />
</a></p>

<p>Olemme nyt käsitelleet ohjelmiston elinkaaren vaiheista vaatimusmäärittelyä ja laadunhallintaa. Tässä osassa aiheena on ohjelmiston suunnittelu ja toteutus.</p>

<p>Tämän osan luvuista ne, joihin on merkitty <span style="color:blue">[viikko 5]</span> tai  <span style="color:blue">[viikko 6]</span> liittyvät myöhempien viikkojen laskareihin, eli voit skipata ne viikolla 4.</p>

<h2 id="typoja-materiaalissa">Typoja materiaalissa</h2>

<p>Tee <a href="/osa0#typoja-materiaalissa">korjausehdotus</a> editoimalla <a href="https://github.com/ohjelmistotuotanto-hy/ohjelmistotuotanto-hy.github.io/blob/master/osa4.md">tätä</a> tiedostoa GitHubissa.</p>

<h2 id="ohjelmiston-suunnittelu">Ohjelmiston suunnittelu</h2>

<p>Ohjelmiston suunnittelun ajatellaan jakautuvan kahteen vaiheeseen: arkkitehtuurisuunnitteluun ja olio- tai komponenttisuunnitteluun.</p>

<p><em>Arkkitehtuurisuunnittelussa</em> hahmotellaan ohjelman rakenne karkealla tasolla, eli mietitään mistä suuremmista rakennekomponenteista ohjelma koostuu? Miten komponentit kommunikoivat ja minkälaiset niiden väliset rajapinnat ovat.</p>

<p><em>Olio- tai komponenttisuunnittelussa</em> taas suunnitellaan yksityiskohtaisemmin miten yksittäiset komponentit, luokat ja metodit tulisi toteuttaa.</p>

<p>Näiden teknisten näkökulmien lisäksi ohjelmiston määrittelyn ja suunnittelun välimaastossa on <a href="https://www.itewiki.fi/opas/kayttoliittymasuunnittelu-ux-user-experience-design-eli-kayttajakokemus/">käyttöliittymä- ja käyttökokemussuunnittelu</a>, joihin kurssin materiaalissa ei valitettavasti pystytä syventymään. Laitoksella on muutamia syventäviä kursseja aihepiiristä, mm. <a href="https://courses.helsinki.fi/fi/csm13401">Human computer interaction</a>.</p>

<p>Ohjelmiston suunnittelun ajoittuminen riippuu käytettävästä tuotantoprosessista.
Vesiputousmallissa suunnittelu tapahtuu vaatimusmäärittelyn jälkeen ja ohjelmointi aloitetaan vasta kun suunnittelu on valmiina ja dokumentoitu. Ketterissä menetelmissä taas suunnittelua tehdään tarvittava määrä jokaisessa sprintissä ja tarkkaa suunnitteludokumenttia ei yleensä ole.</p>

<p>Vesiputousmallin mukainen suunnitteluprosessi tuskin on enää juuri missään käytössä, ja ainakin vaatimusmäärittely ja arkkitehtuurisuunnittelu limittyvät.</p>

<p>Tarkkaa ja raskasta ennen ohjelmointia tapahtuvaa suunnittelua, josta käytetään joskus nimitystä <a href="https://en.wikipedia.org/wiki/Big_Design_Up_Front">Big Design Up Front</a> eli BDUF, toki edelleen tapahtuu ja tietynlaisiin järjestelmiin (hyvin tunnettu sovellusalue, muuttumattomat vaatimukset) se osittain sopiikin.</p>

<h2 id="ohjelmiston-arkkitehtuuri">Ohjelmiston arkkitehtuuri</h2>

<p>Käsite <em>ohjelmiston arkkitehtuuri</em> (engl. software architecture) on ollut olemassa jo vuosikymmeniä. Termi on vakiintunut yleiseen käyttöön 2000-luvun aikana ja on siirtynyt mm. riviohjelmoijaa kokeneempaa työntekijää tarkoittavaksi nimikkeeksi <em>ohjelmistoarkkitehti</em> engl. software architech.</p>

<p>Useimmilla alan ihmisillä on jonkinlainen kuva siitä, mitä ohjelmiston arkkitehtuurilla tarkoitetaan. Termiä ei ole kuitenkaan yrityksistä huolimatta onnistuttu määrittelemään siten, että kaikki olisivat määritelmästä yksimielisiä.</p>

<p>IEEE:n standardi <a href="https://ieeexplore.ieee.org/document/875998">Recommended practices for Architectural descriptions of Software intensive systems</a> määrittelee käsitteen seuraavasti:</p>

<blockquote>
  <p>Ohjelmiston arkkitehtuuri on järjestelmän perusorganisaatio, joka sisältää järjestelmän osat, osien keskinäiset suhteet, osien suhteet ympäristöön sekä periaatteet, jotka ohjaavat järjestelmän suunnittelua ja evoluutiota.</p>
</blockquote>

<p>Otetaan esimerkiksi pari muutakin määritelmää.</p>

<p><a href="https://www.semanticscholar.org/paper/The-Rational-Unified-Process-An-Introduction%2C-3rd-Kruchten/3239cd654d82aa775cf9382a4d2ad834a3ea1014">Philippe Krutchten</a> määrittelee arkkitehtuurin seuraavasti</p>

<blockquote>
  <p>An architecture is the <em>set of significant decisions about the organization of a software system</em>, the selection of structural elements and their interfaces by which the system is composed, together with their behavior as specified in the collaborations among those elements, the composition of these elements into progressively larger subsystems, and the <em>architectural style</em> that guides this organization - these elements and their interfaces, their collaborations, and their composition.</p>
</blockquote>

<p><a href="http://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.467.1174&amp;rep=rep1&amp;type=pdf">McGovern ym.</a> taas sanovat</p>

<blockquote>
  <p>The software architecture of a system or a collection of systems consists of all the important design decisions about the software structures and the interactions between those structures that comprise the systems. <em>The design decisions support a desired set of qualities that the system should support to be successful</em>. The design decisions provide a conceptual basis for system development, support, and maintenance.</p>
</blockquote>

<p>Vaikka arkkitehtuurin määritelmät hieman vaihtelevat, löytyy määritelmistä joukko samoja teemoja. Jokaisen määritelmän mukaan arkkitehtuuri määrittelee ohjelmiston rakenteen, eli jakautumisen erillisiin osiin sekä osien väliset rajapinnat. Arkkitehtuuri ottaa kantaa rakenteen lisäksi myös käyttäytymiseen, se määrittelee arkkitehtuuritason rakenneosien vastuut ja niiden keskinäisen kommunikoinnin muodot.</p>

<p>Arkkitehtuuri keskittyy järjestelmän rakenteen tärkeisiin tai keskeisiin periaatteisiin. Se ei siis kuvaa järjestelmää tarkalla detaljitasolla, vaan on isoihin linjoihin keskittyvä <em>abstraktio</em>.</p>

<p>Artikkelissa <a href="https://martinfowler.com/ieeeSoftware/whoNeedsArchitect.pdf">Who needs architect</a> Martin Fowler toteaa seuraavasti <em>you might end up defining architecture as things that people perceive as hard to change</em>, eli arkkitehtuurin voisi määritellä niiksi asioiksi, jotka ovat ohjelmistossa vaikeita muuttaa. Järjestelmän tärkeät rakenneperiaatteet voivat myös muuttua ajan myötä, eli arkkitehtuuri <a href="http://www.ibm.com/developerworks/rational/library/feb06/eeles/">ei ole muuttumaton</a> mutta sen radikaali muuttaminen voi olla haastavaa.</p>

<p>Melkein sama hieman toisin ilmaistuna oli Krutchtenin määritelmässä mainittu
<em>set of significant decisions about the organization of a software system</em>, eli arkkitehtuuri muodostuu arkkitehtuuristen päätösten, eli joukon ohjelmiston rakenteen ja toiminnan kannalta tehtävien fundamentaalisten valintoja kautta.</p>

<h3 id="arkkitehtuuriin-vaikuttavia-tekijöitä">Arkkitehtuuriin vaikuttavia tekijöitä</h3>

<p><a href="/osa2">Osassa 2</a> mainittiin järjestelmän vaatimusten jakautuvat kahteen luokkaan, toiminnallisiin ja ei-toiminnallisiin vaatimuksiin.</p>

<p>Järjestelmälle asetetuilla ei-toiminnallisilla <a href="/osa2#ei-toiminnalliset-vaatimukset">laatuvaatimuksilla</a> (engl. -ilities) on suuri vaikutus arkkitehtuuriin. Laatuvaatimuksia ovat esimerkiksi käytettävyys, suorituskyky, skaalautuvuus, vikasietoisuus, tiedon ajantasaisuus, tietoturva, ylläpidettävyys, laajennettavuus, testattavuus, hinta, time-to-market, …</p>

<p>Jotkut laatuvaatimuksista ovat keskenään ristiriidassa, joten arkkitehdin tulee hakea niiden suhteen kaikkia sidosryhmiä tyydyttävä kompromissi. Esimerkiksi time-to-market, eli kuinka nopeasti sovellus saadaan loppukäyttäjille ja alhainen hinta, lienevät ristiriidassa lähes kaikkien laatuvaatimusten kanssa.</p>

<p>Tiedon ajantasaisuus, skaalautuvuus ja vikasietoisuus ovat myös piirteitä, joiden suhteen on pakko tehdä kompromisseja, on jopa todistettu matemaattisesti olevan tilanteita, missä kaikkia ei voida saavuttaa (ks. <a href="http://en.wikipedia.org/wiki/CAP_theorem">CAP-teoreema</a>).</p>

<p>Myös toteutusteknologiat, esimerkiksi toteutuksessa käytettävät sovelluskehykset ja integraatio olemassaoleviin järjestelmiin sekä järjestelmän toimintaympäristö esim. lääketieteen ja ilmailualan säädökset sekä edellytetyt toimintastandardit, vaikuttavat arkkitehtuuriin.</p>

<p>Arkkitehtuurin suurin merkitys on antaa sovelluksen kehitykselle ja ylläpidolle sellaiset raamit, että sovellus pystyy jatkossakin vastaamaan asiakkaan asettamien toiminnallisten vaatimuksien lisäksi järjestelmälle asetettuihin laatuvaatimuksiin.</p>

<p>Joskus käy niin, että sovellukselle alunperin valittu arkkitehtuuri ei enää palvele tavoitettaan. Näin voi esimerkiksi käydä, jos sovelluksen laatuvaatimukset muuttuvat radikaalisti, esim. jos tulee tarve saada sovellus skaalautumaan huomattavasti suuremmalle käyttäjäjoukolle, mitä alkuperäinen arkkitehtuuri kykenee. Arkkitehtuurin muuttaminen on hankalaa ja kallista, mutta joskus muuta vaihtoehtoa ei ole.</p>

<h3 id="arkkitehtuurityyli">Arkkitehtuurityyli</h3>

<p>Ohjelmiston arkkitehtuuri perustuu yleensä yhteen tai useampaan <em>arkkitehtuurityyliin</em> (engl. architectural style), jolla tarkoitetaan hyväksi havaittua tapaa strukturoida tietyntyyppisiä sovelluksia.</p>

<p>Arkkitehtuurityylejä on <a href="https://en.wikipedia.org/wiki/Architectural_pattern">suuri määrä</a>, esim:</p>
<ul>
  <li>kerrosarkkitehtuuri</li>
  <li>model-view-controller</li>
  <li>pipes-and-filters</li>
  <li>repository</li>
  <li>client-server</li>
  <li>publish-subscribe</li>
  <li>event driven</li>
  <li>REST</li>
  <li>mikropalveluarkkitehtuuri</li>
  <li>palveluperustainen arkkitehtuuri</li>
</ul>

<p>Useimmiten sovelluksen rakenteesta löytyy monien arkkitehtuuristen tyylien piirteitä.</p>

<h3 id="kerrosarkkitehtuuri">Kerrosarkkitehtuuri</h3>

<p>Arkkitehtuurityyleistä varmasti tunnetuin ja eniten käytetty on <em>kerrosarkkitehtuuri</em> (engl. layered architecture), jossa pyrkimyksenä on jakaa sovellus käsitteellisiin kerroksiin, joissa kukin kerros suorittaa oman “abstraktiotason” tehtäväänsä käyttäen ainoastaan sen alapuolella olevan kerroksen palveluja.</p>

<p>Kerrosarkkitehtuurissa ylimmät kerrokset ovat lähempänä käyttäjää, ylimpänä kerroksena on yleensä käyttöliittymä ja tämän alapuolella sovelluslogiikasta vastaava kerros. Alimmat kerrokset taas keskittyvät koneläheisiin asioihin, kuten tiedon tallennukseen tai verkon yli tapahtuvaan kommunikaatioon.</p>

<p><img src="http://localhost:4000/images/4-1.png" alt="" height="350px" /></p>

<p>Käytännössä kukin kerros on kokoelma toisiinsa liittyviä olioita tai komponentteja, jotka muodostavat oman abstraktiotasonsa toiminnallisuuden suhteen loogisen kokonaisuuden.</p>

<p>Kerrosarkkitehtuurilla on monia etuja. Kerroksittaisuus helpottaa ylläpitoa, sillä jos tietyn kerroksen palvelurajapintaan eli muille kerroksille näkyvään osaan tehdään muutoksia, aiheuttavat muutokset ylläpitotoimenpiteitä ainoastaan suoraan yläpuolella olevaan kerroksen. Esim. käyttöliittymän muutokset eivät vaikuta muihin kerroksiin ja tiedon tallennuksesta huolehtivaan kerrokseen tehtävät muutokset eivät vaikuta käyttöliittymään.</p>

<p>Sovelluslogiikan riippumattomuus käyttöliittymästä helpottaa ohjelman siirtämistä uusille alustoille, esimerkiksi toimimaan webin lisäksi mobiiliympäristössä. Alimpien kerroksien palveluja, kuten tallennuskerrosta tai ainakin sen osia voidaan mahdollisesti uusiokäyttää myös muissa sovelluksissa.</p>

<p>Kerrosarkkitehtuuri on sovelluskehittäjän kannalta selkeä ja hyvin ymmärretty malli, mutta sen soveltaminen saattaa johtaa massiivisiin monoliittisiin sovelluksiin, joita on lopulta vaikea laajentaa ja joiden skaalaaminen tukemaan suuria yhtäaikaisia käyttäjämääriä voi muodostua ongelmaksi.</p>

<h3 id="todo-sovelluksen-arkkitehtuuri">Todo-sovelluksen arkkitehtuuri</h3>

<p>Eräs konkreettinen, joskin hyvin yksinkertainen esimerkki kerrosarkkitehtuuria noudattavasta sovelluksesta on kurssin <a href="https://courses.helsinki.fi/fi/tkt20002">Ohjelmistotekniikka</a> referenssisovelluksena toimiva <a href="https://github.com/mluukkai/OtmTodoApp">Todo-sovellus</a>.</p>

<p>Koodin tasolla kerrosrakenne näkyy siinä, miten sovelluksen koodi jakautuu pakkauksiin</p>

<p><img src="http://localhost:4000/images/4-2.png" alt="" height="250px" /></p>

<p>Arkkitehtuuria heijasteleva pakkausrakenne voidaan kuvata UML:n <a href="https://github.com/mluukkai/ohjelmistotekniikka-kevat2019/blob/master/web/materiaali.md#pakkauskaavio">pakkauskaaviolla</a>:</p>

<p><img src="http://localhost:4000/images/4-1b.png" alt="" height="200px" /></p>

<p>Pakkauksina kuvattujen kerroksien välille on merkitty riippuvuudet katkoviivalla. Käyttöliittymä <em>todoapp.ui</em> riippuu sovelluslogiikasta <em>todoapp.domain</em>, joka taas riippuu tallennuskerroksesta <em>todoapp.dao</em>.</p>

<p>Käytännössä riippuvuus tarkoittaa sitä, että ylemmän kerroksen koodista kutsutaan jotain alemman kerroksen koodin metodia. Kerrosarkkitehtuurin hengen mukaisesti riippuvuuksia on vain ylhäältä alas, eli esim. sovelluslogiikkakerroksen koodi ei kutsu käyttöliittymäkerroksen koodia.</p>

<h3 id="arkkitehtuurin-kuvaamisesta">Arkkitehtuurin kuvaamisesta</h3>

<p>Kovista yrityksistä huolimatta ohjelmistojen arkkitehtuurien kuvaamiselle ei ole onnistuttu kehittämään mitään yleisesti käytössä olevaa notaatiota. UML:ää käytetään jonkin verran, mutta kovin suosittu ja käyttökelpoinen ei sekään ole. Edellisessä esimerkissä käytettyä  pakkauskaaviota paremmin isompien sovellusten arkkitehtuurien kuvaamiseen sopii <a href="https://en.wikipedia.org/wiki/Component_diagram">komponenttikaavio</a>.</p>

<p>Komponenttikaavio eroaa pakkauskaaviosta lähinnä merkintätavoiltaan ja tuo hieman paremmin esiin eri komponenttien tarjoamat sekä käyttämät rajapinnat. Esimerkiksi alla olevassa kuvassa oleva verkkokaupan sovelluslogiikasta vastaava komponentti <em>web store</em>  tarjoaa rajapinnat tuotteiden haulle, ostosten tekemiselle ja käyttäjän hallinnoinnille. Komponentti itsessään jakautuu kolmeen alikomponenttiin, joista <em>authentication</em> tarjoaa sisäisen rajapinnan <em>shopping chart</em> -komponentin käyttöön.</p>

<p><img src="http://localhost:4000/images/4-4.png" alt="" height="450px" /></p>

<p>UML:n sijaan arkkitehtuurin kuvaamiseen käytetään kuitenkin useimmiten epäformaaleja laatikko/nuoli-kaavioita.</p>

<p>Riippumatta arkkitehtuurin dokumentointitavasta, arkkitehtuurikuvaus kannattaa tehdä useasta <em>eri näkökulmasta</em>, sillä eri näkökulmat palvelevat erilaisia tarpeita. Korkean tason kuvauksen avulla voidaan esim. strukturoida vaatimusmäärittelyn aikana käytäviä keskusteluja eri sidosryhmien kanssa. Detaljoidummat kuvaukset taas toimivat ohjeena järjestelmän tarkemmassa suunnittelussa ja ylläpitovaiheen aikaisessa laajentamisessa.</p>

<p>Kannattaa huomata, että arkkitehtuurikuvaus ei suinkaan ole pelkkä kuva, mm. komponenttien vastuut tulee tarkentaa sekä niiden väliset rajapinnat ja kommunikaation muodot määritellä. Jos näin ei tehdä, kasvaa riski sille että arkkitehtuuria ei noudateta.</p>

<p>Hyödyllinen arkkitehtuurikuvaus myös perustelee tehtyjä <a href="https://adr.github.io/">arkkitehtuurisia valintoja</a>. Ei nimittäin ole ollenkaan harvinaista, että jotain ohjelmistoon tehtyjä arkkitehtuuritason suunnitteluratkaisuja ihmetellään parin vuoden päästä ja kukaan ei enää muista aikoinaan tarkasti mietittyjä perusteita tehdyille päätöksille.</p>

<h3 id="mikropalveluarkkitehtuuri">Mikropalveluarkkitehtuuri</h3>

<p>Kerrosarkkitehtuurin eräänä epäkohtana mainittiin, että sen soveltaminen saattaa johtaa massiivisiin monoliittisiin sovelluksiin, joita on lopulta vaikea laajentaa ja joiden skaalaaminen suurille käyttäjämäärille voi muodostua ongelmaksi.</p>

<p>Viime aikoina nopeasti yleistynyt <em>mikropalveluarkkitehtuuri</em> (engl. microservices) pyrkii vastaamaan näihin haasteisiin koostamalla sovelluksen useista (jopa sadoista) pienistä verkossa toimivista autonomisista palveluista, jotka keskenään verkon yli kommunikoiden toteuttavat järjestelmän toiminnallisuuden.</p>

<p><img src="http://localhost:4000/images/4-6.png" alt="" height="300px" /></p>

<p>Mikropalveluihin perustuvassa sovelluksessa yksittäisistä palveluista pyritään tekemään mahdollisimman <em>riippumattomia</em> ja löyhästi toisiinsa kytkettyjä. Palvelut eivät esimerkiksi käytä yhteistä tietokantaa eivätkä käytä yhteistä koodia. Palvelut eivät kutsu suoraan toistensa metodeja, sen sijaan ne kommunikoivat verkon välityksellä.</p>

<p>Mikropalveluiden on tarkoitus olla suhteellisen pieniä ja huolehtia vain “yhdestä asiasta”. Esimerkiksi verkkokaupassa erillisiä mikropalveluja voisivat olla</p>

<ul>
  <li>käyttäjien hallinta</li>
  <li>tuotteiden suosittelu</li>
  <li>tuotteiden hakutoiminnot</li>
  <li>ostoskorin toiminnallisuus</li>
  <li>ostosten maksusta huolehtiva toiminnallisuus</li>
</ul>

<p>Kun järjestelmään lisätään toiminnallisuutta, se yleensä tarkoittaa uusien palveluiden toteuttamista tai ainoastaan joidenkin palveluiden laajentamista. Sovelluksen laajentaminen voi näin olla helpompaa kuin kerrosarkkitehtuurissa, missä laajennus yleensä edellyttää jokaisessa kerroksessa olevan koodin muokkaamista.</p>

<p>Mikropalveluja hyödyntävää sovellusta voi olla helpompi skaalata, sillä suorituskyvyn pullonkaulan aiheuttavia mikropalveluja voidaan suorittaa useita rinnakkain.</p>

<p>Mikropalveluiden käyttö mahdollistaa sen, että sovellus voidaan helposti koodata monella kielellä tai useita eri sovelluskehyksiä hyödyntämällä, sillä toisin kuin monoliittisissa projekteissa, mikään ei edellytä, että kaikki mikropalvelut olisi toteutettu samalla tekniikalla.</p>

<h4 id="mikropalveluiden-kommunikointi">Mikropalveluiden kommunikointi</h4>

<p>Mikropalvelut siis kommunikoivat keskenään verkon välityksellä. Erilaisia tapoja kommunikointiin on useita.</p>

<p>Yksinkertainen vaihtoehto on käyttää kommunikointiin HTTP- protokollaa, eli samaa mekanismia, jonka avulla web-selaimet keskustelevat palvelimien kanssa. Tällöin sanotaan, että mikropalvelut tarjoavat kommunikointia varten REST-rajapinnan. Viikon 3 laskareissa haettiin NHL-tilastotietoja JSON-muotoista dataa tarjoavasta REST-rajapinnasta.</p>

<p>Vaihtoehtoinen, huomattavasti joustavampi kommunikointikeino on ns. <em>viestinvälityksen</em> (message queue/bus) käyttö.</p>

<p>Palvelut eivät lähetä viestejä suoraan toisilleen, vaan käytössä on verkossa toimiva viestinvälityspalvelu, joka hoitaa viestien välityksen eri palveluiden välillä.</p>

<p><img src="http://localhost:4000/images/4-6b.png" alt="" height="400px" /></p>

<p>Periaatteena viestinvälityksessä on se, että palvelut <em>julkaisevat</em> (publish) viestejä viestinvälityspalveluun. Viesteillä on tyypillisesti joku <em>aihe</em> (topic) ja sen lisäksi <em>datasisältö</em>, esimerkiksi:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
  topic: new_user, 
  data: { 
    username: "Arto Hellas", 
    age: 31, 
    education: "PhD",
    occupation: "Aalto University" 
  }
}

</code></pre></div></div>

<p>Palvelut voivat <em>tilata</em> (subscribe) viestipalvelusta niihin aiheisiin liittyvät viestit joista ne ovat kiinnostuneita. Esimerkiksi käyttäjähallinnasta vastaava palvelu todennäköisesti tilaa viestit, joiden aihe on <em>new_user</em>. Viestinvälityspalvelu välittää vastaanottamansa viestit edelleen kaikille palveluille, jotka ovat kyseisen aiheen tilanneet.</p>

<p>Kaikki viestien välitys tapahtuu siis viestinvälityspalvelun kautta, eli palvelut eivät kommunikoi suoraan toistensa kanssa. Näin mikropalveluista tulee erittäin löyhästi kytkettyjä, ja muutokset yhdessä palvelussa eivät vaikuta mihinkään muualle, niin kauan kuin viestit säilyvät entisen muotoisina.</p>

<p>Viestien lähetys on lähettäjän kannalta <em>asynkronista</em> eli palvelu lähettää viestin, jatkaa se heti koodissaan eteenpäin siitä huolimatta onko viesti välitetty sen tilanneille palveluille.</p>

<p>Asynkronisten viestien (joita kutsutaan usein myös <em>eventeiksi</em>) välitykseen perustuvaa arkkitehtuureja kutsutaan myös <em>event-driven</em>-arkkitehtuureiksi. Kaikki event-driven-arkkitehtuurit eivät suinkaan ole mikropalveluarkkitehtuureja, esim. Java Swing/FX -sovelluksessa käyttöliittymä kommunikoi sovelluksen kanssa asynkronisten eventtien avulla.</p>

<h4 id="mikropalveluiden-haasteita">Mikropalveluiden haasteita</h4>

<p>Monista eduistaan huolimatta mikropalveluarkkitehtuurin soveltaminen tuo mukanaan koko joukon uusia haasteita. Ensinnäkin sovelluksen jakaminen järkeviin mikropalveluihin on haastavaa. Vääränlainen jako palveluihin voi tuottaa sovelluksen, jossa jokainen palvelu joutuu keskustelemaan verkon yli pahimmassa tapauksessa kymmenien palvelujen kesken ja näin sovelluksen suorituskyky kärsii.</p>

<p>Useista palveluista koostetun sovelluksen debuggaaminen ja testaaminen on huomattavasti hankalampaa kuin monoliittisen, erityisesti näin on jos mikropalvelut käyttävät viestinvälitystä.</p>

<p>Kymmenistä tai jopa sadoista mikropalveluista koostuvan ohjelmiston operoiminen eli käynnistäminen ja suorittaminen tuotantopalvelimilla on haastavaa ja vaatii pitkälle menevää automatisointia. Sama koskee sovelluskehitysympäristöä ja jatkuvaa integraatiota.
Mikropalveluiden menestyksekäs soveltaminen edellyttääkin vahvaa DevOps-kulttuuria.</p>

<p>Mikropalveluiden yhteydessä käytetäänkin paljon konttiteknologiaa (engl. container), eli käytännössä <a href="https://www.docker.com/">Docker</a>-ohjelmistoa. Kontit ovat hieman yksinkertaistaen sanottuna kevyitä virtuaalikoneita, joita on mahdollista suorittaa suuret määrät yksittäisellä palvelimella. Jos mikropalvelu on omassa kontissa, vastaa se käytännössä tilannetta, missä mikropalvelua suoritettaisiin omalla koneellaan.</p>

<p>Aihe on tärkeä, mutta emme valitettavasti voi mennä siihen tämän kurssin 
puitteissa ollenkaan, onneksi Avoimessa yliopistossa on tarjolla sopiva kurssi aiheesta: <a href="https://docker-hy.github.io/">DevOps with Docker</a></p>

<h2 id="arkkitehtuuri-ketterissä-menetelmissä">Arkkitehtuuri ketterissä menetelmissä</h2>

<p>Ketterien menetelmien kantava teema on toimivan, asiakkaalle arvoa tuottavan ohjelmiston nopea toimittaminen, tämä on mainittu selkeästi jo ketterän manifestin periaatteissa:</p>

<p><em>Our highest priority is to satisfy the customer through early and continuous delivery of valuable software.</em></p>

<p><em>Deliver working software frequently, from a couple of weeks to a couple of months, with a preference to the shorter timescale.</em></p>

<p>Ketterät menetelmät suosivat suunnitteluratkaisujen yksinkertaisuutta:</p>

<p><em>Simplicity, the art of maximizing the amount of work not done, is essential</em></p>

<p>Arkkitehtuuriin suunnittelu ja dokumentointi taas on perinteisesti ollut melko pitkäkestoinen, ohjelmoinnin aloittamista edeltävä vaihe, eräänlainen <em>big Design Up Front</em>. Ketterät menetelmät ja “arkkitehtuurivetoinen” ohjelmistotuotanto ovat siis jossain määrin keskenään ristiriidassa.</p>

<p>Ketterien menetelmien yhteydessä puhutaan usein <a href="https://www.jamesshore.com/Agile-Book/incremental_design.html">inkrementaalisesta suunnittelusta ja arkkitehtuurista</a>.</p>

<p>Ideana on, että arkkitehtuuri mietitään ja dokumentoidaan riittävällä tasolla projektin alussa. Ohjelmiston “lopullinen” arkkitehtuuri muodostuu iteraatio iteraatiolta samalla kun ohjelmistoon toteutetaan uutta toiminnallisuutta. Esimerkiksi kerrosarkkitehtuurin mukaista sovellusta ei rakenneta “kerros kerrallaan”, vaan sen sijaan jokaisessa iteraatiossa tehdään pieni pala jokaista kerrosta, sen verran kuin iteraation toiminnallisuuksien toteuttaminen edellyttää.</p>

<p>Melko tyypillinen tapa on aloittaa projektit ns. <a href="https://www.infoq.com/news/2008/09/sprint_zero/">nollasprintillä</a> jonka aikana luodaan mm. alustava arkkitehtuuri sekä backlog.</p>

<p>Scrumin varhaisissa artikkeleissa puhuttiin “pre game”-vaiheesta, jonka aikana tehtiin erilaisia kehitystyötä valmistelevia asioita, mm. hahmoteltiin alustava arkkitehtuuri. Sittemmin koko käsite on hävinnyt Scrumista ja toinen Scrumin alkuperäisistä kehittäjistä Ken Schwaber jopa eksplisiittisesti kieltää ja <a href="http://www.scrum.org/assessmentdiscussion/post/1317787">tyrmää</a> koko “nollasprintin” olemassaolon.</p>

<h3 id="kävelevä-luuranko">Kävelevä luuranko</h3>

<p>Yleinen lähestymistapa inkrementaaliseen arkkitehtuuriin on <em>kävelevän luurangon, eli walking skeletonin</em> käyttö. <a href="http://alistair.cockburn.us/Walking+skeleton">Alistair Coburn</a> kuvailee käsitettä seuraavasti:</p>

<blockquote>
  <p>A Walking Skeleton is a tiny implementation of the system that performs a small end-to-end function. It need not use the final architecture, but it should link together the main architectural components.</p>

  <p>The architecture and the functionality can then evolve in parallel.</p>

  <p>What constitutes a walking skeleton varies with the system being designed.</p>

  <p>For a layered architecture system, it is a working connection between all the layers.</p>

  <p>The walking skeleton is not complete or robust and it is missing the flesh of the application functionality. Incrementally, over time, the infrastructure will be completed and full functionality will be added.</p>

  <p>A walking skeleton, is permanent code, built with production coding habits, regression tests, and is intended to grow with the system.</p>
</blockquote>

<p>Eli heti projektin alussa, mielellään jo ensimmäisessä sprintissä on tarkoitus toteuttaa suunnitellun arkkitehtuurin rungon sisältävä <em>walking skeleton</em>, joka sisältää jo kaikkia arkkitehtuurin peruskomponentteja ja kerroksia vastaavat tynkäkomponentit sekä niiden välisen kommunikaation.</p>

<p>Tätä luurankoa sitten kasvatetaan pikkuhiljaa projektin edetessä, kun sovelluksen toiminnallisuus kasvaa.</p>

<p>Walking skeleton ei ole pelkästään poisheitettävää koodia, vaan sovelluksen koodi rakentuu sen ympärille, eli skeletoinia rakennettaessa on jo tarkoituksenmukaisin osin syytä ohjelmoida tuotantokoodin edellyttämällä laadulla, eli projektin definition of donea noudattaen.</p>

<h3 id="inkrementaalisen-arkkitehtuurin-etuja">Inkrementaalisen arkkitehtuurin etuja</h3>

<p>Perinteisesti, esimerkiksi vesiputousmallia käytettäessä arkkitehtuurista on vastannut ohjelmistoarkkitehti ja ohjelmoijat ovat olleet velvoitettuja noudattamaan sovellukselle määriteltyä arkkitehtuuria.</p>

<p>Ketterissä menetelmissä ei suosita erillistä arkkitehdin roolia, esimerkiksi Scrum käyttää kaikista ryhmän jäsenistä nimikettä developer. Ketterien menetelmien ideaalina on, että kehitystiimi luo arkkitehtuurin yhdessä, tämä on myös yksi ketterän manifestin periaatteista:</p>

<blockquote>
  <p>The best architectures, requirements, and designs emerge from self-organizing teams.</p>
</blockquote>

<p>Ketterän ideaalin mukaan ohjelmiston arkkitehtuuri on koodin tapaan <em>tiimin yhteisomistama</em>. Tästä on muutamiakin etuja.</p>

<p>Kehittäjät todennäköisesti sitoutuvat paremmin tiimin luoman ja omistaman arkkitehtuurin noudattamiseen kuin “norsunluutornissa” olevan tiimin ulkopuolisen arkkitehdin määrittelemään arkkitehtuuriin.</p>

<p>Tiimin kesken suunnitteleman arkkitehtuurin dokumentointi voi olla kevyt ja informaali, esim. valkotaululle piirretty, sillä tiimi tuntee joka tapauksessa arkkitehtuurin hengen ja pystyy sitä noudattamaan. Jos arkkitehtuurin suunnittelee joku ulkopuoleinen, sen kommunikointi tiimille edellyttää raskaampaa dokumentaatiota.</p>

<p>Ketterissä menetelmissä oletuksena on, että parasta mahdollista arkkitehtuuria ei pystytä suunnittelemaan projektin alussa, kun vaatimuksia, toimintaympäristöä ja toteutusteknologioita ei vielä tunneta. Jo tehtyjä arkkitehtonisia ratkaisuja on järkevä muuttaa, jos ajan myötä huomataan että aiemmin tehdyt valinnat eivät tue parhaalla tavalla ohjelmiston kehittämistä.</p>

<p>Eli kuten vaatimusmäärittelyn suhteen, myös arkkitehtuurin suunnittelussa ketterät menetelmät pyrkii välttämään liian aikaisin tehtävää ja myöhemmin todennäköisesti turhaksi osoittautuvaa työtä.</p>

<h3 id="inkrementaalisen-arkkitehtuurin-riskit">Inkrementaalisen arkkitehtuurin riskit</h3>

<p>Inkrementaalinen lähestymistapa arkkitehtuurin muodostamiseen edellyttää koodilta hyvää sisäistä laatua ja kehitystiimiltä suurta kurinalaisuutta.</p>

<p><a href="http://martinfowler.com/articles/designDead.html">Martin Fowler</a> toteaa seuraavasti</p>

<blockquote>
  <p>Essentially, incremental design means that the design of the system grows as the system is implemented. Design is part of the programming processes and as the program evolves the design changes.</p>

  <p>In its common usage, incremental design is a disaster. The design ends up being the aggregation of a bunch of ad-hoc tactical decisions, each of which makes the code harder to alter.</p>
</blockquote>

<p>Fowlerin havaintojen mukaan inkrementaalisen arkkitehtuurin ja suunnittelun ihanne toteutuu vain harvoin, useimmiten sovelluskehittäjien huolimattomuus, aikataulupaineet ym. syyt johtavat siihen, että ohjelmiston sisäinen laatu alkaa ajan myötä heikentyä ja lopulta ohjelmisto on muodoton kasa spagettikoodia, eli <a href="http://www.laputan.org/mud/">big ball of mud</a> jonka ylläpitäminen ja jatkokehittäminen muuttuu erittäin haastavaksi.</p>

<h2 id="olio--ja-komponenttisuunnittelu">Olio- ja komponenttisuunnittelu</h2>

<p>Sovelluksen arkkitehtuuri siis antaa raamit, jotka ohjaavat sovelluksen tarkempaa suunnittelua ja toteuttamista. Tätä tarkemman tason suunnittelua kutsutaan olio- tai komponenttisuunnitteluksi ja sen tarkoituksena on tarkentaa arkkitehtuuristen komponenttien väliset rajapinnat sekä hahmotella ohjelman tarkempi luokka- tai moduulirakenne.</p>

<p>Vesiputousmaisessa työskentelyssä komponenttisuunnittelu saattaa olla dokumentoitu hyvinkin tarkkaan esim. UML:n luokka- ja sekvenssikaavioita hyväksikäyttäen. Erityisesti ketterässä ohjelmistotuotannossa tarkka suunnittelu tapahtuu kuitenkin yleensä vasta ohjelmoitaessa.</p>

<p>Ohjelmiston suunnittelussa pyritään ennen kaikkia maksimoimaan <a href="/osa3#yksikkötestaus">koodin sisäinen laatu</a>, eli pitämään sovellus rakenteeltaan helposti ylläpidettävänä ja laajennettavana.</p>

<p>Ylläpidettävyyden ja laajennettavuuden kannalta tärkeitä seikkoja ovat mm. seuraavat</p>

<ul>
  <li>koodin tulee olla luettavuudeltaan selkeää, ja sen tulee kertoa esim. nimeämisellä mahdollisimman selkeästi mitä koodi tekee, ja tuoda esiin koodin alla oleva “design”</li>
  <li>yhtä paikkaa pitää pystyä muuttamaan siten, ettei muutoksesta aiheudu sivuvaikutuksia sellaisiin kohtiin koodia, jota muutoksen tekijä ei pysty ennakoimaan</li>
  <li>jos ohjelmaan tulee tehdä laajennus tai bugikorjaus, tulee olla helposti selvitettävissä mihin kohtaan koodia muutos tulee tehdä</li>
  <li>jos ohjelmasta muutetaan “yhtä asiaa”, tulee kaikkien muutosten tapahtua vain yhteen kohtaan koodia (metodiin, luokkaan tai komponenttiin)</li>
  <li>muutosten ja laajennusten jälkeen tulee olla helposti tarkastettavissa ettei muutos aiheuta sivuvaikutuksia muualle järjestelmään</li>
</ul>

<p>Ohjelmistoalalle vuosien varrella kerääntyneen <a href="https://www.amazon.com/Software-Development-Principles-Practices-Paperback/dp/B011DBKELY">kansanviisauden</a> mukaan ylläpidettävyyden ja laajennettavuuden kannalta hyvällä koodilla on joukko yhteneviä ominaisuuksia, tai <em>laatuattribuutteja</em>, joita ovat esim. seuraavat:</p>

<ul>
  <li>kapselointi</li>
  <li>korkea koheesion aste</li>
  <li>riippuvuuksien vähäisyys</li>
  <li>toisteettomuus</li>
  <li>testattavuus</li>
  <li>selkeys</li>
</ul>

<p>Tutustutaan nyt näihin laatuattribuutteihin sekä periaatteisiin ja suunnitteluratkaisuihin, joita noudattamalla on mahdollista kirjoittaa ylläpidettävyydeltään laadukasta koodia. Monet näistä hyvän suunnittelun periaatteista on nimetty ja dokumentoitu <em>suunnittelumalleina</em> (engl. design patterns).</p>

<p>Olemme jo nähneet kurssin aikana muutamia suunnittelumalleja, ainakin seuraavat: <em>dependency injection</em> eli riippuvuuksien injektointi, <em>singleton</em> sekä <em>data access object</em>. Suurin osa tällä kurssilla käsiteltävistä suunnittelumalleista on syntynyt olio-ohjelmoinnin parissa. Osa suunnittelumalleista on relevantteja myös muita paradigmoja, kuten funktionaalista ohjelmointia käytettäessä. Muilla paradigmoilla on myös omia suunnittelumalleja, mutta niitä emme kurssilla käsittele.</p>

<h3 id="koodin-laatuattribuutti-kapselointi">Koodin laatuattribuutti: kapselointi</h3>

<p>Ohjelmoinnin peruskurssilla <em>kapselointi</em> (engl. encapsulation) määriteltiin muutama vuosi seuraavasti</p>

<blockquote>
  <p>Tapaa ohjelmoida olion toteutuksen yksityiskohdat luokkamäärittelyn sisään – piiloon olion käyttäjältä – kutsutaan kapseloinniksi. Olion käyttäjän ei tarvitse tietää mitään olioiden sisäisestä toiminnasta.</p>
</blockquote>

<p>Määritelmä ei ole nykyisellä kurssilla sanatarkkaan sama, mutta aloitteleva ohjelmoija assosioi kapseloinnin nykyäänkin seuraavaan periaatteeseen: <em>oliomuuttujat tulee määritellä privaateiksi ja niille tulee tehdä tarvittaessa setterit ja getterit</em></p>

<p>Tämä on kuitenkin melko kapea näkökulma kapselointiin. Olion sisäisen tilan lisäksi kapseloinnin kohde voi olla mm. käytettävän olion tyyppi, käytetty algoritmi, olioiden luomisen tapa, käytettävän komponentin rakenne, jne…</p>

<p>Monissa suunnittelumalleissa on kyse juuri eritasoisten asioiden kapseloinnista, ja tulemme pian näkemään esimerkkejä asiasta.</p>

<p>Pyrkimys kapselointiin näkyy myös ohjelmiston arkkitehtuurin tasolla. Esimerkiksi kerrosarkkitehtuurissa ylempi kerros käyttää ainoastaan alapuolellaan olevan kerroksen ulospäin tarjoamaa rajapintaa, kaikki muu on kapseloitu näkymättömiin. Vastaavasti mikropalveluarkkitehtuureissa yksittäinen palvelu kapseloi toiminnallisuutensa sisäisen logiikan ja tarjoaa ulospäin ainoastaan verkon välityksellä käytettävän rajapinnan.</p>

<h3 id="koodin-laatuattribuutti-koheesio">Koodin laatuattribuutti: koheesio</h3>

<p><em>Koheesiolla</em> (engl. cohesion) tarkoitetaan sitä, kuinka pitkälle metodissa, luokassa tai komponentissa oleva ohjelmakoodi keskittyy tietyn yksittäisen toiminnallisuuden toteuttamiseen. Hyvänä asiana pidetään mahdollisimman korkeaa koheesion astetta.</p>

<p>Koheesioon tulee siis pyrkiä kaikilla ohjelman tasoilla, metodeissa, luokissa ja komponenteissa.</p>

<h4 id="koheesio-metoditasolla">Koheesio metoditasolla</h4>

<p>Tarkastellaan esimerkkinä <a href="http://www.ibm.com/developerworks/java/library/j-eaed4/index.html">Neal Fordin artikkelista</a> olevaa tietokannasta tietoa hakevaa metodia. Metodin koodi näyttää seuraavalta:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// SQL_SELECT_PARTS on vakio, joka sisältää SQL-kyselyn</span>

<span class="kd">public</span> <span class="kt">void</span> <span class="nf">populate</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">(</span><span class="n">Connection</span> <span class="n">c</span> <span class="o">=</span> <span class="n">DriverManager</span><span class="o">.</span><span class="na">getConnection</span><span class="o">(</span><span class="n">DB_URL</span><span class="o">,</span> <span class="n">USER</span><span class="o">,</span> <span class="n">PASSWORD</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">Statement</span> <span class="n">stmt</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">createStatement</span><span class="o">();</span>
        <span class="n">ResultSet</span> <span class="n">rs</span> <span class="o">=</span> <span class="n">stmt</span><span class="o">.</span><span class="na">executeQuery</span><span class="o">(</span><span class="n">SQL_SELECT_PARTS</span><span class="o">);</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">next</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">Part</span> <span class="n">p</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Part</span><span class="o">();</span>
            <span class="n">p</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">"name"</span><span class="o">));</span>
            <span class="n">p</span><span class="o">.</span><span class="na">setBrand</span><span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">"brand"</span><span class="o">));</span>
            <span class="n">p</span><span class="o">.</span><span class="na">setRetailPrice</span><span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">getDouble</span><span class="o">(</span><span class="s">"retail_price"</span><span class="o">));</span>
            <span class="n">partList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">p</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Metodissa tehdään montaa asiaa:</p>

<ul>
  <li>luodaan yhteys tietokantaan</li>
  <li>tehdään tietokantakysely</li>
  <li>käydään kyselyn tulosrivit läpi ja luodaan jokaista tulosriviä kohti <em>Part</em>-olio</li>
  <li>suljetaan yhteys</li>
</ul>

<p>Metodi toimii myös monella erilaisella <em>abstraktiotasolla</em>. Toisaalta käsitellään teknisiä tietokantatason asioita kuten tietokantayhteyden avaamista ja kyselyn tekemistä, toisaalta sovelluslogiikan tasolla mielekkäitä <em>Part</em>-olioita.</p>

<p>Metodin koheesion taso on siis erittäin huono.</p>

<p>Metodi on helppo <em>refaktoroida</em> pilkkomalla se pienempiin osiin, joiden kutsumista alkuperäinen metodi koordinoi.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kt">void</span> <span class="nf">populate</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">(</span><span class="n">Connection</span> <span class="n">c</span> <span class="o">=</span> <span class="n">getDatabaseConnection</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">ResultSet</span> <span class="n">rs</span> <span class="o">=</span> <span class="n">createResultSet</span><span class="o">(</span><span class="n">c</span><span class="o">);</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">next</span><span class="o">()){</span>
            <span class="n">addPartToListFromResultSet</span><span class="o">(</span><span class="n">rs</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="n">ResultSet</span> <span class="nf">createResultSet</span><span class="o">(</span><span class="n">Connection</span> <span class="n">c</span><span class="o">)</span><span class="kd">throws</span> <span class="n">SQLException</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">c</span><span class="o">.</span><span class="na">createStatement</span><span class="o">().</span>
            <span class="n">executeQuery</span><span class="o">(</span><span class="n">SQL_SELECT_PARTS</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="n">Connection</span> <span class="nf">getDatabaseConnection</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">ClassNotFoundException</span><span class="o">,</span> <span class="n">SQLException</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">DriverManager</span><span class="o">.</span><span class="na">getConnection</span><span class="o">(</span><span class="n">DB_URL</span><span class="o">,</span><span class="s">"webuser"</span><span class="o">,</span> <span class="s">"webpass"</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kt">void</span> <span class="nf">addPartToListFromResultSet</span><span class="o">(</span><span class="n">ResultSet</span> <span class="n">rs</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">SQLException</span> <span class="o">{</span>
    <span class="n">Part</span> <span class="n">p</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Part</span><span class="o">();</span>
    <span class="n">p</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">"name"</span><span class="o">));</span>
    <span class="n">p</span><span class="o">.</span><span class="na">setBrand</span><span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">"brand"</span><span class="o">));</span>
    <span class="n">p</span><span class="o">.</span><span class="na">setRetailPrice</span><span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">getDouble</span><span class="o">(</span><span class="s">"retail_price"</span><span class="o">));</span>
    <span class="n">partList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">p</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Yksittäiset metodit ovat nyt kaikki samalla abstraktiotasolla toimivia ja kuvaavasti nimettyjä.</p>

<p>Aikaansaatu lopputulos ei ole vielä ideaali koko ohjelman kontekstissa. <a href="http://www.ibm.com/developerworks/java/library/j-eaed4/index.html">Artikkelissa</a> esimerkkiä jatketaan eristäen tietokantaoperaatiot, joita myös muut ohjelman osat tarvitsevat omaan luokkaansa.</p>

<h4 id="koheesio-luokkatasolla">Koheesio luokkatasolla</h4>

<p>Luokkatason koheesiossa pyrkimyksenä on, että luokan <em>vastuulla</em> on vain yksi asia, tämä tunnetaan myös nimellä <a href="https://en.wikipedia.org/wiki/Single_responsibility_principle">single responsibility</a>-periaate (SRP). Robert Martin määrittelee, että luokalla on yksi vastuu <em>jos sillä on vain yksi syy muuttua</em>.</p>

<p>Kurssin ensimmäisissä laskareissa tarkasteltiin yksinkertaista laskinta:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Laskin</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="n">Scanner</span> <span class="n">lukija</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">Laskin</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">lukija</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Scanner</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">in</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">suorita</span><span class="o">(){</span>
        <span class="k">while</span><span class="o">(</span> <span class="kc">true</span> <span class="o">)</span> <span class="o">{</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">"luku 1: "</span><span class="o">);</span>
            <span class="kt">int</span> <span class="n">luku1</span> <span class="o">=</span> <span class="n">lukija</span><span class="o">.</span><span class="na">nextInt</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span> <span class="n">luku1</span><span class="o">==-</span><span class="mi">9999</span>  <span class="o">)</span> <span class="k">return</span><span class="o">;</span>

            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">"luku 2: "</span><span class="o">);</span>
            <span class="kt">int</span> <span class="n">luku2</span> <span class="o">=</span> <span class="n">lukija</span><span class="o">.</span><span class="na">nextInt</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span> <span class="n">luku2</span><span class="o">==-</span><span class="mi">9999</span>  <span class="o">)</span> <span class="k">return</span><span class="o">;</span>

            <span class="kt">int</span> <span class="n">vastaus</span> <span class="o">=</span> <span class="n">laskeSumma</span><span class="o">(</span><span class="n">luku1</span><span class="o">,</span> <span class="n">luku2</span><span class="o">);</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"summa: "</span><span class="o">+</span> <span class="n">vastaus</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">int</span> <span class="nf">laskeSumma</span><span class="o">(</span><span class="kt">int</span> <span class="n">luku1</span><span class="o">,</span> <span class="kt">int</span> <span class="n">luku2</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">luku1</span><span class="o">+</span><span class="n">luku2</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>

<p>Luokka rikkoo single responsibility -periaatetta. Miksi? Periaate sanoo, että luokalla saa olla vain yksi vastuu eli syy muuttua. Nyt luokalla on kuitenkin useita syitä muuttua:</p>

<ul>
  <li>luokalle halutaan toteuttaa uusia laskutoimituksia</li>
  <li>kommunikointi käyttäjän kanssa halutaan hoitaa jotenkin muuten kuin konsolin välityksellä</li>
</ul>

<p>Eriyttämällä käyttäjän kanssa kommunikointi omaan luokkaan ja eristämällä se rajapinnan taakse eli <em>kapseloimalla kommunikoinnin toteutustapa</em>, saadaan luokan Laskin vastuita vähennettyä:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">IO</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="nf">nextInt</span><span class="o">();</span>
    <span class="kt">void</span> <span class="nf">print</span><span class="o">(</span><span class="n">String</span> <span class="n">m</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Laskin</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">IO</span> <span class="n">io</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">Laskin</span><span class="o">(</span><span class="n">IO</span> <span class="n">io</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">io</span> <span class="o">=</span> <span class="n">io</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">suorita</span><span class="o">(){</span>
        <span class="k">while</span><span class="o">(</span> <span class="kc">true</span> <span class="o">)</span> <span class="o">{</span>
            <span class="n">io</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">"luku 1: "</span><span class="o">);</span>
            <span class="kt">int</span> <span class="n">luku1</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="na">nextInt</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span> <span class="n">luku1</span><span class="o">==-</span><span class="mi">9999</span>  <span class="o">)</span> <span class="k">return</span><span class="o">;</span>

            <span class="n">io</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">"luku 2: "</span><span class="o">);</span>
            <span class="kt">int</span> <span class="n">luku2</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="na">nextInt</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span> <span class="n">luku2</span><span class="o">==-</span><span class="mi">9999</span> <span class="o">)</span> <span class="k">return</span><span class="o">;</span>

            <span class="kt">int</span> <span class="n">vastaus</span> <span class="o">=</span> <span class="n">laskeSumma</span><span class="o">(</span><span class="n">luku1</span><span class="o">,</span> <span class="n">luku2</span><span class="o">);</span>
            <span class="n">io</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">"summa: "</span><span class="o">+</span><span class="n">vastaus</span><span class="o">+</span><span class="s">"\n"</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">int</span> <span class="nf">laskeSumma</span><span class="o">(</span><span class="kt">int</span> <span class="n">luku1</span><span class="o">,</span> <span class="kt">int</span> <span class="n">luku2</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">luku1</span><span class="o">+</span><span class="n">luku2</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Nyt kommunikointitavan muutos ei edellytä luokkaan mitään muutoksia edellyttäen että uusikin kommunikointitapa toteuttaa rajapinnan, jonka kautta <em>Laskin</em> hoitaa kommunikoinnin.</p>

<p>Vaikka luokka <em>Laskin</em> siis toteuttaakin edelleen käyttäjänsä näkökulmasta samat asiat kuin aiemmin, ei se hoida kaikkea itse vaan <em>delegoi</em> osan vastuistaan muualle.</p>

<p>Kommunikointirajapinta voidaan toteuttaa esim. seuraavasti:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">KonsoliIO</span> <span class="kd">implements</span> <span class="n">IO</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">Scanner</span> <span class="n">lukija</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">KonsoliIO</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">lukija</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Scanner</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">in</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">nextInt</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">lukija</span><span class="o">.</span><span class="na">nextLine</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">print</span><span class="o">(</span><span class="n">String</span> <span class="n">m</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">m</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Laskin konfiguroidaan injektoimalla <em>IO</em>-rajapinnan toteuttava luokka konstruktorin parametrina:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Main</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Laskin</span> <span class="n">laskin</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Laskin</span><span class="o">(</span> <span class="k">new</span> <span class="n">KonsoliIO</span><span class="o">()</span> <span class="o">);</span>
        <span class="n">laskin</span><span class="o">.</span><span class="na">suorita</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Testausta varten voidaan toteuttaa <em>stub</em> eli valekomponentti, jonka avulla testi voi hallita “käyttäjän” syötteitä ja lukea ohjelman tulostukset:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">IOStub</span> <span class="kd">implements</span> <span class="n">IO</span> <span class="o">{</span>

    <span class="kt">int</span><span class="o">[]</span> <span class="n">inputs</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">mones</span><span class="o">;</span>
    <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">outputs</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">IOStub</span><span class="o">(</span><span class="kt">int</span><span class="o">...</span> <span class="n">inputs</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">inputs</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">outputs</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">nextInt</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">inputs</span><span class="o">[</span><span class="n">mones</span><span class="o">++];</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">print</span><span class="o">(</span><span class="n">String</span> <span class="n">m</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">outputs</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">m</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Parannellun laskimen rakenne luokkakaaviona</p>

<p><img src="https://github.com/mluukkai/ohjelmistotuotanto2017/raw/master/images/os-1.png" alt="" /></p>

<p>Luokka ei ole vielä kaikin osin laajennettavuuden kannalta optimaalinen. Palaamme asiaan hetken kuluttua.</p>

<h4 id="koheesio-komponenttitasolla">Koheesio komponenttitasolla</h4>

<p>Koheesio ja <em>single responsibility</em> -periaate eivät ole pelkästään olio-ohjelmointiin liittyviä käsitteitä vaan universaaleja hyvän koodin periaatteita. Jos ajatellaan kurssilla <a href="https://fullstackopen.com/">Full stack -websovelluskehitys</a> käytettävää React-kirjastoa, on siinäkin periaatteena koostaa käyttöliittymä pienistä komponenteista, joista kukin keskittyy yhteen asiaan, esim. yksittäisen napin HTML-koodin renderöintiin. Web-sovelluksen tilan käsittely taas pyritään kapseloimaan Redux-storeen, jonka ainoa vastuu on tilasta ja sen muutoksista huolehtiminen.</p>

<p>Koheesion periaate näkyy myös sovelluksen arkkitehtuurien tasolla. Kerrosarkkitehtuurissa kukin sovelluksen kerros keskittyy oman abstraktiotason asioihin, esim. sovelluslogiikka ei ota kantaa käyttöliittymään tai tiedon tallentamisen tapaan. Mikropalveluarkkitehtuureissa koheesio taas näkyy hieman eri tavalla, yksittäinen mikropalvelu keskittyy toteuttamaan yksittäisen liiketoiminnan tason toiminnallisuuden, esim. verkkokaupan suosittelualgoritmin tai laskutuksen.</p>

<h3 id="riippuvuuksien-vähäisyys">Riippuvuuksien vähäisyys</h3>

<p>Single responsibility -periaatteen hengessä tehty ohjelma koostuu suuresta määrästä oliota/komponentteja, joilla on suuri määrä pieniä metodeja.</p>

<p>Olioiden on oltava vuorovaikutuksessa toistensa kanssa saadakseen toteutettua ohjelman toiminnallisuuden. <em>Riippuvuuksien vähäisyyden</em> (engl. low coupling) periaate pyrkii eliminoimaan luokkien ja olioiden välisiä riippuvuuksia.</p>

<p>Koska korkean koheesion periaatteen nojalla olioita on paljon, tulee riippuvuuksia pakostakin, miten riippuvuudet sitten saadaan eliminoitua? Ideana on eliminoida tarpeettomat riippuvuudet <em>ja</em> välttää riippuvuuksia konkreettisiin asioihin.</p>

<p>Riippuvuuden kannattaa kohdistua asiaan, joka ei muutu herkästi, eli joko rajapintaan tai abstraktiin luokkaan. Sama idea kulkee parilla eri nimellä</p>
<ul>
  <li>program to an interface, not to an implementation</li>
  <li>depend on abstractions, not on concrete implementation</li>
</ul>

<p>Konkreettisen riippuvuuden eliminointi voidaan tehdä rajapintojen (tai abstraktien luokkien) avulla. Olemme tehneet näin kurssilla usein, mm. Verkkokaupan riippuvuus Varastoon, Pankkiin ja Viitegeneraattoriin korvattiin rajapinnoilla. Riippuvuuksien injektointi -suunnittelumalli toimi usein apuvälineenä konkreettisen riippuvuuksien eliminoinnissa.</p>

<p>Osa luokkien välisistä riippuvuuksista on tarpeettomia ja ne kannattaa eliminoida muuttamalla luokan vastuita.</p>

<h4 id="favour-composition-over-inheritance-eli-milloin-ei-kannata-periä-viikko-5">Favour composition over inheritance eli milloin ei kannata periä <span style="color:blue">[viikko 5]</span></h4>

<p>Perintä muodostaa riippuvuuden perivän ja perittävän luokan välille, ja tämä voi jossain tapauksissa olla ongelmallista. Eräs oliosuunnittelun kulmakivi onkin periaate <a href="https://en.wikipedia.org/wiki/Composition_over_inheritance">Favour composition over inheritance</a> eli suosi yhteistoiminnassa toimivia oliota perinnän sijaan.</p>

<p>Tarkastellaan tilannetta havainnollistavaa esimerkkiä.</p>

<p>Käytössämme luokka, joka mallintaa pankkitiliä:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Tili</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">tiliNumero</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">omistaja</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">double</span> <span class="n">saldo</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">double</span> <span class="n">korkoProsentti</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">Tili</span><span class="o">(</span><span class="n">String</span> <span class="n">tiliNumero</span><span class="o">,</span> <span class="n">String</span> <span class="n">omistaja</span><span class="o">,</span> <span class="kt">double</span> <span class="n">korkoProsentti</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">tiliNumero</span> <span class="o">=</span> <span class="n">tiliNumero</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">omistaja</span> <span class="o">=</span> <span class="n">omistaja</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">korkoProsentti</span> <span class="o">=</span> <span class="n">korkoProsentti</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">siirraRahaaTililta</span><span class="o">(</span><span class="n">Tili</span> <span class="n">tilille</span><span class="o">,</span> <span class="kt">double</span> <span class="n">summa</span><span class="o">){</span>
        <span class="k">if</span> <span class="o">(</span> <span class="k">this</span><span class="o">.</span><span class="na">saldo</span><span class="o">&lt;</span><span class="n">summa</span> <span class="o">)</span> <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>

        <span class="k">this</span><span class="o">.</span><span class="na">saldo</span> <span class="o">-=</span> <span class="n">summa</span><span class="o">;</span>
        <span class="n">tilille</span><span class="o">.</span><span class="na">saldo</span> <span class="o">+=</span> <span class="n">summa</span><span class="o">;</span>

        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">maksaKorko</span><span class="o">(){</span>
        <span class="n">saldo</span> <span class="o">+=</span> <span class="n">saldo</span><span class="o">*</span><span class="n">korkoProsentti</span><span class="o">*</span><span class="mi">100</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Asiakkaan vaatimukset muuttuvat ja tulee tarve tilille, jonka korko perustuu joko 1, 3, 6 tai 12 kuukauden Euribor-korkoon. Päätämme tehdä uuden luokan <em>EuriborTili</em> perimällä luokan <em>Tili</em> ja ylikirjoittamalla metodin <em>maksaKorko</em> siten, että Euribor-koron senhetkinen arvo haetaan verkosta:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">EuriborTili</span> <span class="kd">extends</span> <span class="n">Tili</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">kuukauden</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">EuriborTili</span><span class="o">(</span><span class="n">String</span> <span class="n">tiliNumero</span><span class="o">,</span> <span class="n">String</span> <span class="n">omistaja</span><span class="o">,</span> <span class="kt">int</span> <span class="n">kuukauden</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">tiliNumero</span><span class="o">,</span> <span class="n">omistaja</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">kuukauden</span> <span class="o">=</span> <span class="n">kuukauden</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">maksaKorko</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">saldo</span> <span class="o">+=</span> <span class="n">saldo</span> <span class="o">*</span> <span class="n">korko</span><span class="o">()</span> <span class="o">*</span> <span class="mi">100</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">double</span> <span class="nf">korko</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">Scanner</span> <span class="n">lukija</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Scanner</span><span class="o">(</span><span class="k">new</span> <span class="n">URL</span><span class="o">(</span><span class="s">"http://www.euribor-rates.eu/current-euribor-rates.asp"</span><span class="o">).</span><span class="na">openStream</span><span class="o">());</span>
            <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
            <span class="k">while</span> <span class="o">(</span><span class="n">lukija</span><span class="o">.</span><span class="na">hasNextLine</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">String</span> <span class="n">sisalto</span> <span class="o">=</span> <span class="n">lukija</span><span class="o">.</span><span class="na">nextLine</span><span class="o">();</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">sisalto</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="s">"Euribor - "</span><span class="o">+</span><span class="n">kuukauden</span><span class="o">+</span><span class="s">" month"</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">count</span><span class="o">==</span><span class="mi">0</span><span class="o">){</span>
                    <span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
                <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">sisalto</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="s">"Euribor - "</span><span class="o">+</span><span class="n">kuukauden</span><span class="o">+</span><span class="s">" month"</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">count</span><span class="o">==</span><span class="mi">1</span><span class="o">){</span>
                    <span class="n">lukija</span><span class="o">.</span><span class="na">nextLine</span><span class="o">();</span>
                    <span class="n">lukija</span><span class="o">.</span><span class="na">nextLine</span><span class="o">();</span>
                    <span class="n">sisalto</span> <span class="o">=</span> <span class="n">lukija</span><span class="o">.</span><span class="na">nextLine</span><span class="o">();</span>
                    <span class="k">return</span> <span class="n">Double</span><span class="o">.</span><span class="na">parseDouble</span><span class="o">(</span><span class="n">sisalto</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">sisalto</span><span class="o">.</span><span class="na">length</span><span class="o">()-</span><span class="mi">1</span><span class="o">))/</span><span class="mi">100</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>      
            
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{}</span>
        <span class="k">return</span> <span class="mi">0</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Huomaamme, että <em>EuriborTili</em> rikkoo <em>single responsibility</em> -periaatetta, sillä luokka sisältää normaalin tiliin liittyvän toiminnan lisäksi koodia, joka hakee tavaraa internetistä. Vastuut kannattaa selkeyttää ja korkoprosentin haku eriyttää omaan rajapinnan takana olevaan luokkaan:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">EuriborLukija</span> <span class="o">{</span>
    <span class="kt">double</span> <span class="nf">korko</span><span class="o">();</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EuriborTili</span> <span class="kd">extends</span> <span class="n">Tili</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">EuriborLukija</span> <span class="n">euribor</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">EuriborTili</span><span class="o">(</span><span class="n">String</span> <span class="n">tiliNumero</span><span class="o">,</span> <span class="n">String</span> <span class="n">omistaja</span><span class="o">,</span> <span class="kt">int</span> <span class="n">kuukauden</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">tiliNumero</span><span class="o">,</span> <span class="n">omistaja</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
        <span class="n">euribor</span> <span class="o">=</span> <span class="k">new</span> <span class="n">EuriborLukijaImpl</span><span class="o">(</span><span class="n">kuukauden</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">maksaKorko</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">saldo</span> <span class="o">+=</span> <span class="n">saldo</span> <span class="o">*</span> <span class="n">euribor</span><span class="o">.</span><span class="na">korko</span><span class="o">()</span> <span class="o">*</span> <span class="mi">100</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EuriborLukijaImpl</span> <span class="kd">implements</span> <span class="n">EuriborLukija</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">kuukauden</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">EuriborLukijaImpl</span><span class="o">(</span><span class="kt">int</span> <span class="n">kuukauden</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">kuukauden</span> <span class="o">=</span> <span class="n">kuukauden</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">double</span> <span class="nf">korko</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">Scanner</span> <span class="n">lukija</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Scanner</span><span class="o">(</span><span class="k">new</span> <span class="n">URL</span><span class="o">(</span><span class="s">"http://www.euribor-rates.eu/current-euribor-rates.asp"</span><span class="o">).</span><span class="na">openStream</span><span class="o">());</span>
            <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
            <span class="k">while</span> <span class="o">(</span><span class="n">lukija</span><span class="o">.</span><span class="na">hasNextLine</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">String</span> <span class="n">sisalto</span> <span class="o">=</span> <span class="n">lukija</span><span class="o">.</span><span class="na">nextLine</span><span class="o">();</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">sisalto</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="s">"Euribor - "</span><span class="o">+</span><span class="n">kuukauden</span><span class="o">+</span><span class="s">" month"</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">count</span><span class="o">==</span><span class="mi">0</span><span class="o">){</span>
                    <span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
                <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">sisalto</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="s">"Euribor - "</span><span class="o">+</span><span class="n">kuukauden</span><span class="o">+</span><span class="s">" month"</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">count</span><span class="o">==</span><span class="mi">1</span><span class="o">){</span>
                    <span class="n">lukija</span><span class="o">.</span><span class="na">nextLine</span><span class="o">();</span>
                    <span class="n">lukija</span><span class="o">.</span><span class="na">nextLine</span><span class="o">();</span>
                    <span class="n">sisalto</span> <span class="o">=</span> <span class="n">lukija</span><span class="o">.</span><span class="na">nextLine</span><span class="o">();</span>
                    <span class="k">return</span> <span class="n">Double</span><span class="o">.</span><span class="na">parseDouble</span><span class="o">(</span><span class="n">sisalto</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">sisalto</span><span class="o">.</span><span class="na">length</span><span class="o">()-</span><span class="mi">1</span><span class="o">))/</span><span class="mi">100</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>      
            
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{}</span>
        <span class="k">return</span> <span class="mi">0</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>EuriborTili-luokka alkaa olla nyt melko siisti, EuriborLukijassa olisi paljon parantemisen varaa, mm. sen ainoan metodin <em>koheesio</em> on huono: metodi tekee aivan liian montaa asiaa.</p>

<p>Seuraavaksi huomaamme, että on tarvetta <em>määräaikaistilille</em>, joka on muuten samanlainen kuin <em>Tili</em>, mutta määräaikaistililtä ei voi siirtää rahaa muualle ennen kuin se on tehty tietyn ajan kuluttua mahdolliseksi. Perimme jälleen luokan <em>Tili</em>:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MaaraaikaisTili</span> <span class="kd">extends</span> <span class="n">Tili</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">nostokielto</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">MaaraaikaisTili</span><span class="o">(</span><span class="n">String</span> <span class="n">tiliNumero</span><span class="o">,</span> <span class="n">String</span> <span class="n">omistaja</span><span class="o">,</span> <span class="kt">double</span> <span class="n">korkoProsentti</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">tiliNumero</span><span class="o">,</span> <span class="n">omistaja</span><span class="o">,</span> <span class="n">korkoProsentti</span><span class="o">);</span>
        <span class="n">nostokielto</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">salliNosto</span><span class="o">(){</span>
        <span class="n">nostokielto</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">siirraRahaaTililta</span><span class="o">(</span><span class="n">Tili</span> <span class="n">tilille</span><span class="o">,</span> <span class="kt">double</span> <span class="n">summa</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span> <span class="n">nostokielto</span> <span class="o">)</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>

        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">siirraRahaaTililta</span><span class="o">(</span><span class="n">tilille</span><span class="o">,</span> <span class="n">summa</span><span class="o">);</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>

<p>Ohjelman rakenne näyttää tässä vaiheessa seuraavalta:</p>

<p><img src="http://localhost:4000/images/4-8.png" alt="" height="120px" /></p>

<p>Seuraavaksi tulee idea <em>Euribor-korkoa käyttävistä määräaikaistileistä</em>. Miten nyt kannattaisi tehdä? Osa toiminnallisuudesta on luokassa <em>MaaraaikaisTili</em> ja osa luokassa <em>EuriborTili</em>…</p>

<p>Koronmaksun hoitaminen perinnän avulla ei ollutkaan paras ratkaisu, parempi on noudattaa <em>favor composition over inheritance</em> -periaatetta. Eli erotetaan <em>koronmaksu</em> omaksi luokakseen, tai rajapinnan toteuttaviksi luokiksi:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Korko</span> <span class="o">{</span>
    <span class="kt">double</span> <span class="nf">korko</span><span class="o">();</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Tasakorko</span> <span class="kd">implements</span> <span class="n">Korko</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kt">double</span> <span class="n">korko</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">Tasakorko</span><span class="o">(</span><span class="kt">double</span> <span class="n">korko</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">korko</span> <span class="o">=</span> <span class="n">korko</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">double</span> <span class="nf">korko</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">korko</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EuriborKorko</span> <span class="kd">implements</span> <span class="n">Korko</span> <span class="o">{</span>
    <span class="n">EuriborLukija</span> <span class="n">lukija</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">EuriborKorko</span><span class="o">(</span><span class="kt">int</span> <span class="n">kuukausi</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">lukija</span> <span class="o">=</span> <span class="k">new</span> <span class="n">EuriborlukijaImpl</span><span class="o">(</span><span class="n">kuukausi</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">double</span> <span class="nf">korko</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">korko</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Tarve erilliselle <em>EuriborTili</em>-luokalle katoaa, ja pelkkä <em>Tili</em> hieman muutetussa muodossa riittää:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Tili</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">tiliNumero</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">omistaja</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">double</span> <span class="n">saldo</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">Korko</span> <span class="n">korko</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">Tili</span><span class="o">(</span><span class="n">String</span> <span class="n">tiliNumero</span><span class="o">,</span> <span class="n">String</span> <span class="n">omistaja</span><span class="o">,</span> <span class="n">Korko</span> <span class="n">korko</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">tiliNumero</span> <span class="o">=</span> <span class="n">tiliNumero</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">omistaja</span> <span class="o">=</span> <span class="n">omistaja</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">korko</span> <span class="o">=</span> <span class="n">korko</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">siirraRahaaTililta</span><span class="o">(</span><span class="n">Tili</span> <span class="n">tilille</span><span class="o">,</span> <span class="kt">double</span> <span class="n">summa</span><span class="o">){</span>
        <span class="k">if</span> <span class="o">(</span> <span class="k">this</span><span class="o">.</span><span class="na">saldo</span><span class="o">&lt;</span><span class="n">summa</span> <span class="o">)</span> <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>

        <span class="k">this</span><span class="o">.</span><span class="na">saldo</span> <span class="o">-=</span> <span class="n">summa</span><span class="o">;</span>
        <span class="n">tilille</span><span class="o">.</span><span class="na">saldo</span> <span class="o">+=</span> <span class="n">summa</span><span class="o">;</span>

        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">maksaKorko</span><span class="o">(){</span>
        <span class="n">saldo</span> <span class="o">+=</span> <span class="n">saldo</span> <span class="o">*</span> <span class="n">korko</span><span class="o">.</span><span class="na">korko</span><span class="o">()</span> <span class="o">*</span> <span class="mi">100</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Erilaisia tilejä luodaan seuraavasti:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Tili</span> <span class="n">normaali</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Tili</span><span class="o">(</span><span class="s">"1234-1234"</span><span class="o">,</span> <span class="s">"Jami Kousa"</span><span class="o">,</span> <span class="k">new</span> <span class="n">Tasakorko</span><span class="o">(</span><span class="mi">4</span><span class="o">));</span>
<span class="n">Tili</span> <span class="n">euribor12</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Tili</span><span class="o">(</span><span class="s">"4422-3355"</span><span class="o">,</span> <span class="s">"Lea Kutvonen"</span><span class="o">,</span> <span class="k">new</span> <span class="n">EuriborKorko</span><span class="o">(</span><span class="mi">12</span><span class="o">));</span>
</code></pre></div></div>

<p>Ohjelman rakenne on nyt seuraava</p>

<p><img src="http://localhost:4000/images/4-9.png" alt="" height="120px" /></p>

<p>Muutetaan luokkaa <em>Tili</em> vielä siten, että tilejä voidaan luoda ilman konstruktoria:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Tili</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">tiliNumero</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">omistaja</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">double</span> <span class="n">saldo</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">Korko</span> <span class="n">korko</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">Tili</span> <span class="nf">luoEuriborTili</span><span class="o">(</span><span class="n">String</span> <span class="n">tiliNumero</span><span class="o">,</span> <span class="n">String</span> <span class="n">omistaja</span><span class="o">,</span> <span class="kt">int</span> <span class="n">kuukausia</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">Tili</span><span class="o">(</span><span class="n">tiliNumero</span><span class="o">,</span> <span class="n">omistaja</span><span class="o">,</span> <span class="k">new</span> <span class="n">EuriborKorko</span><span class="o">(</span><span class="n">kuukausia</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">Tili</span> <span class="nf">luoMaaraaikaisTili</span><span class="o">(</span><span class="n">String</span> <span class="n">tiliNumero</span><span class="o">,</span> <span class="n">String</span> <span class="n">omistaja</span><span class="o">,</span> <span class="kt">double</span> <span class="n">korko</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">MaaraaikaisTili</span><span class="o">(</span><span class="n">tiliNumero</span><span class="o">,</span> <span class="n">omistaja</span><span class="o">,</span> <span class="k">new</span> <span class="n">Tasakorko</span><span class="o">(</span><span class="n">korko</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">Tili</span> <span class="nf">luoKayttoTili</span><span class="o">(</span><span class="n">String</span> <span class="n">tiliNumero</span><span class="o">,</span> <span class="n">String</span> <span class="n">omistaja</span><span class="o">,</span> <span class="kt">double</span> <span class="n">korko</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">Tili</span><span class="o">(</span><span class="n">tiliNumero</span><span class="o">,</span> <span class="n">omistaja</span><span class="o">,</span> <span class="k">new</span> <span class="n">Tasakorko</span><span class="o">(</span><span class="n">korko</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="kd">protected</span> <span class="nf">Tili</span><span class="o">(</span><span class="n">String</span> <span class="n">tiliNumero</span><span class="o">,</span> <span class="n">String</span> <span class="n">omistaja</span><span class="o">,</span> <span class="n">Korko</span> <span class="n">korko</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">tiliNumero</span> <span class="o">=</span> <span class="n">tiliNumero</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">omistaja</span> <span class="o">=</span> <span class="n">omistaja</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">korko</span> <span class="o">=</span> <span class="n">korko</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// ...</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">vaihdaKorkoa</span><span class="o">(</span><span class="n">Korko</span> <span class="n">korko</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">korko</span> <span class="o">=</span> <span class="n">korko</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Lisäsimme luokalle kolme <em>staattista apumetodia</em> helpottamaan tilien luomista. Tilejä voidaan nyt luoda seuraavasti:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Tili</span> <span class="n">maaraaikais</span> <span class="o">=</span> <span class="n">Tili</span><span class="o">.</span><span class="na">luoMaaraaikaisTili</span><span class="o">(</span><span class="s">"1234-1234"</span><span class="o">,</span> <span class="s">"Jami Kousa"</span><span class="o">,</span> <span class="mf">2.5</span><span class="o">);</span>
<span class="n">Tili</span> <span class="n">euribor12</span> <span class="o">=</span> <span class="n">Tili</span><span class="o">.</span><span class="na">luoEuriborTili</span><span class="o">(</span><span class="s">"4422-3355"</span><span class="o">,</span> <span class="s">"Lea Kutvonen"</span><span class="o">,</span> <span class="mi">12</span> <span class="o">);</span>
<span class="n">Tili</span> <span class="n">fyrkka</span> <span class="o">=</span> <span class="n">Tili</span><span class="o">.</span><span class="na">luoEuriborTili</span><span class="o">(</span><span class="s">"7895-4571"</span><span class="o">,</span> <span class="s">"Indre Zliobaite"</span><span class="o">,</span> <span class="mi">1</span> <span class="o">);</span>
</code></pre></div></div>

<h4 id="suunnittelumalli-static-factory-method-viikko-5">Suunnittelumalli: static factory method <span style="color:blue">[viikko 5]</span></h4>

<p>Käyttämämme periaate olioiden luomiseen staattisten metodien avulla on hyvin tunnettu suunnittelumalli <em>staattinen tehdasmetodi</em> (engl. static factory method).</p>

<p>Tili-esimerkissä käytetty static factory method on yksinkertaisin monista tehdas-suunnittelumallin varianteista. Periaatteena suunnittelumallissa on se, että luokalle tehdään staattinen tehdasmetodi tai metodeja, jotka käyttävät konstruktoria ja luovat luokan ilmentymät. Konstruktorin suora käyttö usein estetään määrittelemällä konstruktori privateksi.</p>

<p>Tehdasmetodin avulla voidaan piilottaa olion luomiseen liittyviä yksityiskohtia, esimerkissä <em>Korko</em>-rajapinnan toteuttavien olioiden luominen ja jopa olemassaolo oli tehdasmetodin avulla piilotettu tilin käyttäjältä.</p>

<p>Tehdasmetodin avulla voidaan myös piilottaa käyttäjältä luodun olion todellinen luokka, esimerkissä näin tehtiin määräaikaistilin suhteen.</p>

<p>Tehdasmetodi siis auttaa <em>kapseloinnissa</em>, olion luomiseen liittyvät detaljit ja jopa olion todellinen luonne piiloutuu olion käyttäjältä. Tämä taas mahdollistaa erittäin joustavan laajennettavuuden.</p>

<p>Staattinen tehdasmetodi ei ole testauksen kannalta erityisen hyvä ratkaisu, esimerkissämme olisi vaikea luoda tili, jolle annetaan <em>Korko</em>-rajapinnan toteuttama mock-olio. Nyt se tosin onnistuu koska konstruktoria ei ole täysin piilotettu.</p>

<p>Lisätietoa factory-suunnittelumallista esim. <a href="https://sourcemaking.com/design_patterns/factory_method">täältä</a> ja <a href="http://www.oodesign.com/factory-method-pattern.html">täältä</a>.</p>

<p>Tehdasmetodien avulla voimme siis kapseloida luokan todellisen tyypin. Jamin tilihän on määräaikaistili, se kuitenkin pyydetään Tili-luokassa sijaitsevalta factoryltä, olion oikea tyyppi on piilotettu tarkoituksella käyttäjältä. Määräaikaistilin käyttäjällä ei siis ole enää konkreettista riippuvuutta luokkaan MaaraaikaisTili.</p>

<p>Teimme myös metodin jonka avulla tilin korkoa voi muuttaa. Jamin tasakorkoinen määräaikaistili on helppo muuttaa lennossa kolmen kuukauden Euribor-tiliksi:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">maaraaikais</span><span class="o">.</span><span class="na">vaihdaKorkoa</span><span class="o">(</span><span class="k">new</span> <span class="n">EuriborKorko</span><span class="o">(</span><span class="mi">3</span><span class="o">));</span>
</code></pre></div></div>

<p>Eli luopumalla perinnästä oliorakenne selkeytyy huomattavasti ja saavutetaan suoritusaikaista joustavuutta (koronlaskutapa), joka perintää käyttämällä ei onnistu.</p>

<h4 id="suunnittelumalli-strategy-viikko-5">Suunnittelumalli: strategy <span style="color:blue">[viikko 5]</span></h4>

<p>Tekniikka jolla koronmaksu hoidetaan on myöskin suunnittelumalli, nimeltään <em>strategia</em> (engl. strategy).</p>

<p>Strategyn avulla voidaan hoitaa tilanne, jossa eri olioiden käyttäytyminen on muuten sama, mutta tietyissä kohdissa on käytössä eri “algoritmi”. Esimerkissämme tämä algoritmi oli korkoprosentin määrittely. Sama tilanne voidaan hoitaa usein myös perinnän avulla käyttämättä erillisiä olioita, strategy kuitenkin mahdollistaa huomattavasti dynaamisemman ratkaisun, sillä strategia-olioa on mahdollista vaihtaa ajoaikana. Strategyn käyttö ilmentää hienosti “favour composition over inheritance”-periaatetta</p>

<p>Lisätietoa strategia-suunnittelumallista <a href="http://www.oodesign.com/strategy-pattern.html">täällä</a> ja <a href="https://sourcemaking.com/design_patterns/strategy">täällä</a>.</p>

<h4 id="vastuiden-eriyttäminen-tilin-luominen-pankissa-viikko-5">Vastuiden eriyttäminen: tilin luominen pankissa <span style="color:blue">[viikko 5]</span></h4>

<p>Loimme äsken luokalle <em>Tili</em> staattiset apumetodit tilien luomista varten. Voisi kuitenkin olla järkevämpää siirtää vastuu tilien luomisesta erillisen luokan, <em>Pankki</em> vastuulle. Pankki voi helposti hallinnoida myös tilinumeroiden generointia:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Pankki</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">numero</span><span class="o">;</span>
        
    <span class="kd">private</span> <span class="n">String</span> <span class="nf">generoiTilinro</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">numero</span><span class="o">++;</span>
        <span class="k">return</span> <span class="s">"12345-"</span><span class="o">+</span><span class="n">numero</span><span class="o">;</span>
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="n">Tili</span> <span class="nf">kayttotili</span><span class="o">(</span><span class="n">String</span> <span class="n">omistaja</span><span class="o">,</span> <span class="kt">double</span> <span class="n">k</span><span class="o">){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">Tili</span><span class="o">(</span><span class="n">generoiTilinro</span><span class="o">(),</span> <span class="n">omistaja</span><span class="o">,</span> <span class="k">new</span> <span class="n">Tasakorko</span><span class="o">(</span><span class="n">k</span><span class="o">));</span>
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="n">Tili</span> <span class="nf">maaraikaistili</span><span class="o">(</span><span class="n">String</span> <span class="n">omistaja</span><span class="o">,</span> <span class="kt">double</span> <span class="n">k</span><span class="o">){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">MaaraAikaisTili</span><span class="o">(</span><span class="n">generoiTilinro</span><span class="o">(),</span> <span class="n">omistaja</span><span class="o">,</span> <span class="k">new</span> <span class="n">Tasakorko</span><span class="o">(</span><span class="n">k</span><span class="o">));</span>
    <span class="o">}</span>    
    
    <span class="kd">public</span> <span class="n">Tili</span> <span class="nf">euribortili</span><span class="o">(</span><span class="n">String</span> <span class="n">omistaja</span><span class="o">,</span> <span class="kt">int</span> <span class="n">kk</span><span class="o">){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">Tili</span><span class="o">(</span><span class="n">generoiTilinro</span><span class="o">(),</span> <span class="n">omistaja</span><span class="o">,</span> <span class="k">new</span> <span class="n">EuriborKorko</span><span class="o">(</span><span class="n">kk</span><span class="o">));</span>
    <span class="o">}</span>        

    <span class="kd">public</span> <span class="n">Tili</span> <span class="nf">maaraaikaisEuribor</span><span class="o">(</span><span class="n">String</span> <span class="n">omistaja</span><span class="o">,</span> <span class="kt">int</span> <span class="n">kk</span><span class="o">){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">MaaraAikaisTili</span><span class="o">(</span><span class="n">generoiTilinro</span><span class="o">(),</span> <span class="n">omistaja</span><span class="o">,</span> <span class="k">new</span> <span class="n">EuriborKorko</span><span class="o">(</span><span class="n">kk</span><span class="o">));</span>
    <span class="o">}</span> 
<span class="o">}</span>
</code></pre></div></div>

<p>Tilejä luodaan pankin avulla seuraavasti:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Pankki</span> <span class="n">spankki</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Pankki</span><span class="o">();</span>

<span class="n">Tili</span> <span class="n">euriborTili</span> <span class="o">=</span> <span class="n">spankki</span><span class="o">.</span><span class="na">euribortili</span><span class="o">(</span><span class="s">"Lea Kutvonen"</span><span class="o">,</span> <span class="mi">6</span><span class="o">);</span>
<span class="n">Tili</span> <span class="n">maaraaikaistili</span> <span class="o">=</span> <span class="n">spankki</span><span class="o">.</span><span class="na">maaraikaistili</span><span class="o">(</span><span class="s">"Arto Hellas"</span><span class="o">,</span> <span class="mf">0.15</span><span class="o">);</span>
</code></pre></div></div>

<p>eli tilin luojan ei enää tarvitse huolehtia tilinumeroiden generoinnista.</p>

<p>Jokaisesta tehdasmetodista on siis tehty luokan oman staattisen metodin sijaan toiseen luokkaan sijoitettu oliometodi.</p>

<p>Luokkien vastuut ovat selkeytyneet, <em>Tili</em> vastaa yhteen tiliin liittyvistä asioista, kuten saldosta. Tili myös tuntee olion, jonka hallinnassa on tieto tiliin liittyvästä korosta. <em>Pankki</em> taas hallinnoi kaikkia tilejään, sen avulla myös generoidaan tilinumerot tilien luomisen yhteydessä.</p>

<h3 id="toiminnallisuuden-kapselointi-laskin-ja-strategia-viikko-5">Toiminnallisuuden kapselointi: laskin ja strategia <span style="color:blue">[viikko 5]</span></h3>

<p>Olemme laajentaneet Laskin-luokkaa osaamaan myös muita laskuoperaatioita:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Laskin</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="n">IO</span> <span class="n">io</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">Laskin</span><span class="o">(</span><span class="n">IO</span> <span class="n">io</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">io</span> <span class="o">=</span> <span class="n">io</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">suorita</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">io</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">"komento: "</span><span class="o">);</span>
            <span class="n">String</span> <span class="n">komento</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="na">nextLine</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">komento</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"lopetus"</span><span class="o">))</span> <span class="o">{</span>
                <span class="k">return</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="n">io</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">"luku 1: "</span><span class="o">);</span>
            <span class="kt">int</span> <span class="n">luku1</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="na">nextInt</span><span class="o">();</span>

            <span class="n">io</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">"luku 2: "</span><span class="o">);</span>
            <span class="kt">int</span> <span class="n">luku2</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="na">nextInt</span><span class="o">();</span>

            <span class="kt">int</span> <span class="n">vastaus</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

            <span class="k">if</span> <span class="o">(</span> <span class="n">komento</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"summa"</span><span class="o">)</span> <span class="o">){</span>
                <span class="n">vastaus</span> <span class="o">=</span> <span class="n">laskeSumma</span><span class="o">(</span><span class="n">luku1</span><span class="o">,</span> <span class="n">luku2</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span> <span class="n">komento</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"tulo"</span><span class="o">)</span> <span class="o">){</span>
                <span class="n">vastaus</span> <span class="o">=</span> <span class="n">laskeTulo</span><span class="o">(</span><span class="n">luku1</span><span class="o">,</span> <span class="n">luku2</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span> <span class="n">komento</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"erotus"</span><span class="o">)</span> <span class="o">){</span>
                <span class="n">vastaus</span> <span class="o">=</span> <span class="n">laskeErotus</span><span class="o">(</span><span class="n">luku1</span><span class="o">,</span> <span class="n">luku2</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="n">io</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">"tulos: "</span> <span class="o">+</span> <span class="n">vastaus</span> <span class="o">+</span> <span class="s">"\n"</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">int</span> <span class="nf">laskeSumma</span><span class="o">(</span><span class="kt">int</span> <span class="n">luku1</span><span class="o">,</span> <span class="kt">int</span> <span class="n">luku2</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">luku1</span> <span class="o">+</span> <span class="n">luku2</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">int</span> <span class="nf">laskeTulo</span><span class="o">(</span><span class="kt">int</span> <span class="n">luku1</span><span class="o">,</span> <span class="kt">int</span> <span class="n">luku2</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">luku1</span> <span class="o">*</span> <span class="n">luku2</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">int</span> <span class="nf">laskeErotus</span><span class="o">(</span><span class="kt">int</span> <span class="n">luku1</span><span class="o">,</span> <span class="kt">int</span> <span class="n">luku2</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">luku1</span><span class="o">-</span><span class="n">luku2</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Ratkaisu ei ole kaikin puolin tyydyttävä. Entä jos haluamme muitakin operaatioita kuin summan, tulon ja erotuksen? if-hässäkkä tulee kasvamaan.</p>

<p>Päätämme siirtyä <em>strategia-suunnittelumallin</em> käyttöön, eli hoidetaan laskuoperaatio omassa luokassaan. Rajapinnan sijasta käytämme tällä kertaa abstraktia luokkaa:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">Operaatio</span> <span class="o">{</span>
    
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">Operaatio</span> <span class="nf">luo</span><span class="o">(</span><span class="n">String</span> <span class="n">operaatio</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">operaatio</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"summa"</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nf">Summa</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">operaatio</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"tulo"</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nf">Tulo</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">Erotus</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">abstract</span> <span class="kt">int</span> <span class="nf">laske</span><span class="o">(</span><span class="kt">int</span> <span class="n">luku1</span><span class="o">,</span> <span class="kt">int</span> <span class="n">luku2</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Abstrakti <em>Operaatio</em> luokka määrittelee, että sen toteuttavilla luokilla eli yksittäisillä operaatioilla on metodi <em>laske</em>, joka saa kaksi parametria. Tämän lisäksi luokka sisältää staattisen tehdasmetodin <em>luo</em>, jonka avulla voidaan luoda laskuoperaatioita vastaavia olioita.</p>

<p>Laskuoperaatioita vastaavat luokat on määritelty seuraavasti:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Summa</span> <span class="kd">extends</span> <span class="n">Operaatio</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">laske</span><span class="o">(</span><span class="kt">int</span> <span class="n">luku1</span><span class="o">,</span> <span class="kt">int</span> <span class="n">luku2</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">luku1</span> <span class="o">+</span> <span class="n">luku2</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>


<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Tulo</span> <span class="kd">extends</span> <span class="n">Operaatio</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">laske</span><span class="o">(</span><span class="kt">int</span> <span class="n">luku1</span><span class="o">,</span> <span class="kt">int</span> <span class="n">luku2</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">luku1</span> <span class="o">*</span> <span class="n">luku2</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Erotus</span> <span class="kd">extends</span> <span class="n">Operaatio</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">laske</span><span class="o">(</span><span class="kt">int</span> <span class="n">luku1</span><span class="o">,</span> <span class="kt">int</span> <span class="n">luku2</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">luku1</span> <span class="o">-</span> <span class="n">luku2</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Laskin-luokka yksinkertaistuu huomattavasti:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Laskin</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="n">IO</span> <span class="n">io</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">Laskin</span><span class="o">(</span><span class="n">IO</span> <span class="n">io</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">io</span> <span class="o">=</span> <span class="n">io</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">suorita</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">io</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">"komento: "</span><span class="o">);</span>
            <span class="n">String</span> <span class="n">komento</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="na">nextLine</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">komento</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"lopetus"</span><span class="o">))</span> <span class="o">{</span>
                <span class="k">return</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="n">io</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">"luku 1: "</span><span class="o">);</span>
            <span class="kt">int</span> <span class="n">luku1</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="na">nextInt</span><span class="o">();</span>

            <span class="n">io</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">"luku 2: "</span><span class="o">);</span>
            <span class="kt">int</span> <span class="n">luku2</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="na">nextInt</span><span class="o">();</span>

            <span class="n">Operaatio</span> <span class="n">operaatio</span> <span class="o">=</span> <span class="n">Operaatio</span><span class="o">.</span><span class="na">luo</span><span class="o">(</span><span class="n">komento</span><span class="o">);</span>

            <span class="n">io</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="n">komento</span> <span class="o">+</span> <span class="s">": "</span> <span class="o">+</span> <span class="n">operaatio</span><span class="o">.</span><span class="na">laske</span><span class="o">(</span><span class="n">luku1</span><span class="o">,</span> <span class="n">luku2</span><span class="o">)</span> <span class="o">+</span> <span class="s">"\n"</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Hienona puolena laskimessa on nyt se, että voimme lisätä operaatioita ja luokkaa <em>Laskin</em> ei tarvitse muuttaa millään tavalla, ainoa muutosta edellyttävä kohta olemassaolevassa koodissa on luokan <em>Operaatio</em> metodi <em>luo</em>.</p>

<p>Sovelluksen rakenne näyttää seuraavalta</p>

<p><img src="http://localhost:4000/images/4-10.png" alt="" height="250px" /></p>

<h4 id="laskin-ja-komento-olio-viikko-5">Laskin ja komento-olio <span style="color:blue">[viikko 5]</span></h4>

<p>Entä jos haluamme laskimelle muunkinlaisia, kuin 2 parametria ottavia operaatioita, esim. neliöjuuren? Muutetaan luokan <em>Operaatio</em> olemusta siten, että siirretään sen huolehdittavaksi myös käyttäjän kanssa tapahtuva kommunikointi.</p>

<p>Tämän muutoksen myötä siirrymme käyttämään Strategy-suunnittelumallin lähisukulaista <em>command</em>-suunnittelumallia, annetaankin operaatiolle uusi nimi <em>Komento</em>.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">Komento</span> <span class="o">{</span>
    <span class="kd">protected</span> <span class="n">IO</span> <span class="n">io</span><span class="o">;</span>
    <span class="kd">public</span> <span class="nf">Komento</span><span class="o">(</span><span class="n">IO</span> <span class="n">io</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">io</span> <span class="o">=</span> <span class="n">io</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">abstract</span> <span class="kt">void</span> <span class="nf">suorita</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Komennon toteuttavat luokat ovat siis äärimmäisen yksinkertaisia. Komennon voi ainoastaan suorittaa eikä se edes palauta mitään!</p>

<p>Erillisten komento-olioiden luominen siirretään uudelle luokalle <em>Komentotehdas</em>:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Komentotehdas</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="n">IO</span> <span class="n">io</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">Komentotehdas</span><span class="o">(</span><span class="n">IO</span> <span class="n">io</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">io</span> <span class="o">=</span> <span class="n">io</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Komento</span> <span class="nf">hae</span><span class="o">(</span><span class="n">String</span> <span class="n">operaatio</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">operaatio</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"summa"</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nf">Summa</span><span class="o">(</span><span class="n">io</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">operaatio</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"tulo"</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nf">Tulo</span><span class="o">(</span><span class="n">io</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">operaatio</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"nelio"</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nf">Nelio</span><span class="o">(</span><span class="n">io</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">operaatio</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"lopeta"</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nf">Lopeta</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">Tuntematon</span><span class="o">(</span><span class="n">io</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Komentotehdas siis palauttaa <em>hae</em>-metodin merkkijonoparametria vastaavan komennon. Koska vastuu käyttäjän kanssa kommunikoinnista on siirretty <em>Komento</em>-olioille, annetaan niille <em>IO</em>-olio konstruktorin pararametrina.</p>

<p>if-hässäkkä näyttää hieman ikävältä. Siitä pääsee kuitenkin helposti eroon tallentamalla erilliset komennon HashMap:iin:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Komentotehdas</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Komento</span><span class="o">&gt;</span> <span class="n">komennot</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">Komento</span> <span class="n">tuntemaaton</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">Komentotehdas</span><span class="o">(</span><span class="n">IO</span> <span class="n">io</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">komennot</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Komento</span><span class="o">&gt;();</span>
        <span class="n">komennot</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"summa"</span><span class="o">,</span> <span class="k">new</span> <span class="n">Summa</span><span class="o">(</span><span class="n">io</span><span class="o">));</span>
        <span class="n">komennot</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"tulo"</span><span class="o">,</span> <span class="k">new</span> <span class="n">Tulo</span><span class="o">(</span><span class="n">io</span><span class="o">));</span>
        <span class="n">komennot</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"nelio"</span><span class="o">,</span> <span class="k">new</span> <span class="n">Nelio</span><span class="o">(</span><span class="n">io</span><span class="o">));</span>
        <span class="n">tuntematon</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Tuntematon</span><span class="o">(</span><span class="n">io</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Komento</span> <span class="nf">hae</span><span class="o">(</span><span class="n">String</span> <span class="n">operaatio</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">komennot</span><span class="o">.</span><span class="na">getOrDefault</span><span class="o">(</span><span class="n">operaatio</span><span class="o">,</span> <span class="n">tuntemaaton</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Yksittäiset komennot ovat erittäin yksinkertaisia:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Summa</span> <span class="kd">extends</span> <span class="n">Komento</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="nf">Summa</span><span class="o">(</span><span class="n">IO</span> <span class="n">io</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">io</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">suorita</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">io</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">"luku 1: "</span><span class="o">);</span>
        <span class="kt">int</span> <span class="n">luku1</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="na">nextInt</span><span class="o">();</span>

         <span class="n">io</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">"luku 2: "</span><span class="o">);</span>
        <span class="kt">int</span> <span class="n">luku2</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="na">nextInt</span><span class="o">();</span>
        
        <span class="n">io</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">"vastaus: "</span><span class="o">+</span><span class="n">luku1</span> <span class="o">+</span> <span class="n">luku2</span><span class="o">);</span>
    <span class="o">}</span>  
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Nelio</span> <span class="kd">extends</span> <span class="n">Komento</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="nf">Nelio</span><span class="o">(</span><span class="n">IO</span> <span class="n">io</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">io</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">suorita</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">io</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">"luku 1: "</span><span class="o">);</span>
        <span class="kt">int</span> <span class="n">luku</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="na">nextInt</span><span class="o">();</span>

        <span class="n">io</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">"vastaus: "</span><span class="o">+</span><span class="n">luku</span> <span class="o">*</span> <span class="n">luku</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Tuntematon</span> <span class="kd">extends</span> <span class="n">Komento</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="nf">Tuntematon</span><span class="o">(</span><span class="n">IO</span> <span class="n">io</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">io</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">suorita</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">io</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">"sallitut komennot: summa, tulo, nelio, lopeta"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Lopeta</span> <span class="kd">extends</span> <span class="n">Komento</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="nf">Lopeta</span><span class="o">(</span><span class="n">IO</span> <span class="n">io</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">io</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">suorita</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">io</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">"kiitos ja näkemiin"</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Luokka <em>Laskin</em> yksinkertaistuu entisestään, se ei tee enää juuri mitään muuta kuin luo komentotehtaan sekä sisältää ikuisen loopin, minkä sisällä käyttäjän syötettä vastaavia komentoja suoritetaan:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Laskin</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">IO</span> <span class="n">io</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">Komentotehdas</span> <span class="n">komennot</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">Laskin</span><span class="o">(</span><span class="n">IO</span> <span class="n">io</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">io</span> <span class="o">=</span> <span class="n">io</span><span class="o">;</span>
        <span class="n">komennot</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Komentotehdas</span><span class="o">(</span><span class="n">io</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">suorita</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">io</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">"komento: "</span><span class="o">);</span>
            <span class="n">String</span> <span class="n">komento</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="na">nextLine</span><span class="o">();</span>
            <span class="n">komennot</span><span class="o">.</span><span class="na">hae</span><span class="o">(</span><span class="n">komento</span><span class="o">).</span><span class="na">suorita</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>    
<span class="o">}</span>
</code></pre></div></div>

<p>Ohjelman rakenne tässä vaiheessa</p>

<p><img src="http://localhost:4000/images/4-11.png" alt="" height="250px" /></p>

<h4 id="suunnittelumalli-command-viikko-5">Suunnittelumalli: command <span style="color:blue">[viikko 5]</span></h4>

<p>Eristimme siis jokaiseen erilliseen laskuoperaatioon liittyvän toiminnallisuuden omaksi oliokseen command-suunnittelumallin ideaa noudattaen, eli siten, että kaikki operaatiot toteuttavat yksinkertaisen rajapinnan, jolla on ainoastaan metodi public <em>void suorita()</em></p>

<p>Ohjelman edellisessä versiossa sovelsimme strategia-suunnittelumallia, missä erilliset laskuoperaatiot oli toteutettu omina olioinaan. Command-suunnittelumalli eroaa siinä, että olemme nyt kapseloineet koko komennon suorituksen, myös käyttäjän kanssa käytävän kommunikoinnin omiin olioihin. Komento-olioiden rajapinta on yksinkertainen, niillä on ainoastaan yksi metodi <em>suorita</em>. Strategia-suunnittelumallissa taas strategia-olioiden rajapinta vaihtelee tilanteen mukaan.</p>

<p>Esimerkissä komennot luotiin tehdasmetodin tarjoavan olion avulla, if:it piilotettiin tehtaan sisälle. Komento-olioiden suorita-metodi suoritettiin esimerkissä välittömästi, näin ei välttämättä ole, komentoja voitaisiin laittaa esim. jonoon ja suorittaa myöhemmin. Joskus komento-olioilla metodin <em>suorita</em> lisäksi myös metodi <em>peru</em>, mikä kumoaa komennon suorituksen aiheuttaman toimenpiteen. Esim. editorien undo- ja redo-toiminnallisuus toteutetaan säilyttämällä komento-olioita jonossa. Toteutamme viikon 6 laskareissa <em>peru</em>-toiminnallisuuden laskimen komennoille.</p>

<p>Lisää command-suunnittelimallista esim. <a href="http://www.oodesign.com/command-pattern.html">täällä</a> ja <a href="http://sourcemaking.com/design_patterns/command">täällä</a>.</p>

<h4 id="yhteisen-koodin-eriyttäminen-yliluokkaan-viikko-5">Yhteisen koodin eriyttäminen yliluokkaan <span style="color:blue">[viikko 5]</span></h4>

<p>Koska kaksi parametria käyttäjältä kysyvillä komennoilla, kuten summa, tulo ja erotus on paljon yhteistä, luodaan niitä varten yliluokka:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">BinaariOperaatio</span> <span class="kd">extends</span> <span class="n">Komento</span> <span class="o">{</span>
    <span class="kd">protected</span> <span class="kt">int</span> <span class="n">luku1</span><span class="o">;</span>
    <span class="kd">protected</span> <span class="kt">int</span> <span class="n">luku2</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">BinaariOperaatio</span><span class="o">(</span><span class="n">IO</span> <span class="n">io</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">io</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">suorita</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">io</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">"luku 1: "</span><span class="o">);</span>
        <span class="kt">int</span> <span class="n">luku1</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="na">nextInt</span><span class="o">();</span>

        <span class="n">io</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">"luku 2: "</span><span class="o">);</span>
        <span class="kt">int</span> <span class="n">luku2</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="na">nextInt</span><span class="o">();</span>

        <span class="n">io</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">"vastaus: "</span><span class="o">+</span><span class="n">laske</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="kd">protected</span> <span class="kd">abstract</span> <span class="kt">int</span> <span class="nf">laske</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Summaa ja tuloa vastaavat komennot yksinkertaistuvat:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Summa</span> <span class="kd">extends</span> <span class="n">BinaariOperaatio</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="nf">Summa</span><span class="o">(</span><span class="n">IO</span> <span class="n">io</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">io</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">int</span> <span class="nf">laske</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">luku1</span> <span class="o">+</span> <span class="n">luku2</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Tulo</span> <span class="kd">extends</span> <span class="n">BinaariOperaatio</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="nf">Tulo</span><span class="o">(</span><span class="n">IO</span> <span class="n">io</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">io</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">laske</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">luku1</span><span class="o">*</span><span class="n">luku2</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Jos sovellukseen haluttaisiin toteuttaa lisää kaksiparametrisia operaatioita, esimerkiksi erotus, riittäisi erittäin yksinkertainen lisäys:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Erotus</span> <span class="kd">extends</span> <span class="n">BinaariOperaatio</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="nf">Erotus</span><span class="o">(</span><span class="n">IO</span> <span class="n">io</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">io</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">int</span> <span class="nf">laske</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">luku1</span> <span class="o">-</span> <span class="n">luku2</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Ja mikä parasta, ainoa muu luokka, jota on koskettava on komentoja luova <em>Komentotehdas</em>.</p>

<p>Ohjelmasta on näin ollen saatu laajennettavuuden kannalta varsin joustava. Uusia operaatioita on helppo lisätä ja lisäys ei aiheuta muutoksia moneen kohtaan koodia. Laskin-luokallahan ei ole riippuvuuksia muualle kuin rajapintaan IO, abstraktiin luokkaan Komento sekä luokkaan Komentotehdas.</p>

<p><img src="http://localhost:4000/images/4-12.png" alt="" height="300px" /></p>

<p>Hintana joustavuudelle on luokkien määrän kasvu. Nopealla vilkaisulla saattaakin olla vaikea havaita miten ohjelma toimii, varsinkaan jos ei ole vastaavaan tyyliin tottunut, mukaan on nimittäin piilotettu factory- ja command-suunnittelumallien lisäksi suunnittelumalli <em>template method</em> (kaksiparametrisen komennon toteutukseen).</p>

<h4 id="suunnittelumalli-template-method-viikko-5">Suunnittelumalli: template method <span style="color:blue">[viikko 5]</span></h4>

<p>Template method -suunnittelumalli sopii tilanteisiin, missä kahden tai useamman operaation suoritus on hyvin samankaltainen ja poikkeaa ainoastaan yhden tai muutaman operaatioon liittyvän askeleen kohdalla.</p>

<p>Summa- ja Tulo-komentojen suoritus on oleellisesti samanlainen:</p>

<ol>
  <li>lue luku1 käyttäjältä</li>
  <li>lue luku2 käyttäjältä</li>
  <li><em>laske operaation tulos</em></li>
  <li>tulosta operaation tulos</li>
</ol>

<p>Ainoastaan kolmas vaihe eli <em>operaation tuloksen laskeminen</em> eroaa summaa ja tuloa selvitettäessä.</p>

<p>Template methodin hengessä asia hoidetaan tekemällä abstrakti yliluokka, jonka metodi <em>suorita()</em> toteuttaa koko komennon suorituslogiikan:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">BinaariOperaatio</span> <span class="kd">implements</span> <span class="n">Komento</span> <span class="o">{</span>
    <span class="c1">// ...</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">suorita</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">io</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">"luku 1: "</span><span class="o">);</span>
        <span class="kt">int</span> <span class="n">luku1</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="na">nextInt</span><span class="o">();</span>

        <span class="n">io</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">"luku 2: "</span><span class="o">);</span>
        <span class="kt">int</span> <span class="n">luku2</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="na">nextInt</span><span class="o">();</span>

        <span class="n">io</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">"vastaus: "</span><span class="o">+</span><span class="n">laske</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="kd">protected</span> <span class="kd">abstract</span> <span class="kt">int</span> <span class="nf">laske</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Suorituslogiikan vaihtuva osa eli operaation laskun tulos on määritelty abstraktina metodina <em>laske()</em>, jota metodi <em>suorita()</em> kutsuu.</p>

<p>Konkreettiset toteutukset <em>Summa</em> ja <em>Tulo</em> ylikirjoittavat abstraktin metodin <em>laske()</em>, määrittelemällä miten laskenta tietyssä konkreettisessa tilanteessa tapahtuu:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Summa</span> <span class="kd">extends</span> <span class="n">BinaariOperaatio</span> <span class="o">{</span>
    <span class="c1">// ...</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">int</span> <span class="nf">laske</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">luku1</span> <span class="o">+</span> <span class="n">luku2</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Abstraktin luokan metodi <em>suorita()</em> on <em>template-metodi</em>, joka määrittelee suorituksen siten, että suorituksen eroava osa määritellään yliluokan abstraktina metodina, jonka aliluokat ylikirjoittavat. Template-metodin avulla siis saadaan määriteltyä “geneerinen algoritmirunko”, jota voidaan aliluokissa erikoistaa sopivalla tavalla.</p>

<p>Template-metodeita voi olla useampiakin kuin yksi eroava osa, tällöin abstrakteja metodeja määritellään tarpeellinen määrä.</p>

<p>Strategy-suunnittelumalli on osittain samaa sukua template-metodin kanssa, siinä kokonainen algoritmi tai algoritmin osa korvataan erillisessä luokassa toteutetulla toteutuksella. Strategioita voidaan vaihtaa suorituksen aikana, template-metodissa tietty olio toimii samalla tavalla koko elinaikansa.</p>

<p>Lisää template method -suunnittelumallista <a href="http://www.oodesign.com/template-method-pattern.html">täällä</a> ja <a href="http://www.netobjectives.com/PatternRepository/index.php?title=TheTemplateMethodPattern">täällä</a>.</p>

<h3 id="koodin-laatuattribuutti-toisteettomuus">Koodin laatuattribuutti: toisteettomuus</h3>

<p>Olemme käsitelleet koodin laatuattribuuteista <em>kapselointia, koheesiota</em> ja <em>riippuvuuksien vähäisyyttä</em>, seuraavana vuorossa redundanssi eli toisteisuus.</p>

<p>Aloittelevaa ohjelmoijaa pelotellaan toisteisuuden vaaroista uran ensiaskelista alkaen, varmaan jokainen on kuullut varoituksen: <em>älä copypastaa koodia</em>!</p>

<p>Alan piireissä toisteisuudesta varoittava periaate kuuluu <a href="http://c2.com/cgi/wiki?DontRepeatYourself">don’t repeat yourself</a> ja siihen viitataan usein lyhenteellä <em>DRY</em>.</p>

<p>Ilmeisin toiston muoto koodissa on juuri copypaste ja se on usein helppo eliminoida esimerkiksi metodien avulla. Kaikki toisteisuus ei ole yhtä ilmeistä ja monissa suunnittelumalleissa on kyse juuri hienovaraisempien toisteisuuden muotojen eliminoinnista, edellisessä esimerkissä template method -suunnittelumallia käyttävän luokan <em>BinaariOperaatio</em> motivaationa oli oikeastaan se, että sama käyttäjän interaktion hoitava koodi toistui luokissa <em>Summa</em> ja <em>Tulo</em>.</p>

<p>DRY-periaate menee oikeastaan vielä paljon pelkkää koodissa olevaa toistoa eliminointia pidemmälle. Kirjan <a href="https://en.wikipedia.org/wiki/Don%27t_repeat_yourself">Pragmatic programmer</a> määritelmä <em>every piece of knowledge must have a single, unambiguous, authoritative representation within a system</em> viittaa siihen, että koodin lisäksi periaate tulisi ulottaa koskemaan järjestelmän muitakin osia, kuten tietokantaskeemaa, testejä, build-skriptejä ym.</p>

<p>Pragmatic programmerin määritelmän henkeä ei ei välttämättä pysty tavoittamaan täysin ilman konkreettista esimerkkiä. Oletetaan, että kehittämämme verkkokauppa otettaisiin käyttöön myös sellaisissa maissa, joissa ei käytetä rahayksikkönä euroa. Jos sovellus ei noudata DRY-periaatetta valuutan käsittelyn suhteen, on oletettavaa, että muutos vaatisi muutoksia useisiin eri kohtiin sovellusta. Jos taas valuutan käsittelyllä olisi <em>single authoritive representation</em>, esim. se olisi kapseloitu riittävän hyvin luokan <em>Money</em> vastuulle, niin muiden valuuttojen tuen lisääminen ei ehkä edellyttäisi muuta kuin yksittäisen luokan koodin modifiointia.</p>

<h4 id="epätriviaalin-copypasten-poistaminen-strategy-patternin-avulla-viikko-5">Epätriviaalin copypasten poistaminen Strategy-patternin avulla <span style="color:blue">[viikko 5]</span></h4>

<p>Tarkastellaan <a href="http://www.gutenberg.org/">Project Gutenbergistä</a> löytyvien kirjojen sisällön analysointiin tarkoitettua luokkaa <em>GutenbergLukija</em>:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">GutenbergLukija</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">rivit</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">GutenbergLukija</span><span class="o">(</span><span class="n">String</span> <span class="n">osoite</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IllegalArgumentException</span> <span class="o">{</span>
        <span class="n">rivit</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">URL</span> <span class="n">url</span> <span class="o">=</span> <span class="k">new</span> <span class="n">URL</span><span class="o">(</span><span class="n">osoite</span><span class="o">);</span>
            <span class="n">Scanner</span> <span class="n">lukija</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Scanner</span><span class="o">(</span><span class="n">url</span><span class="o">.</span><span class="na">openStream</span><span class="o">());</span>
            <span class="k">while</span> <span class="o">(</span><span class="n">lukija</span><span class="o">.</span><span class="na">hasNextLine</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">rivit</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">lukija</span><span class="o">.</span><span class="na">nextLine</span><span class="o">());</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">rivit</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">palautettavat</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>

        <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">rivi</span> <span class="o">:</span> <span class="n">rivit</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">palautettavat</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">rivi</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">palautettavat</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">rivitJotkaPaattyvatHuutomerkkiin</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">ehdonTayttavat</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>

        <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">rivi</span> <span class="o">:</span> <span class="n">rivit</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">rivi</span><span class="o">.</span><span class="na">endsWith</span><span class="o">(</span><span class="s">"!"</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">ehdonTayttavat</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">rivi</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">ehdonTayttavat</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">rivitJoillaSana</span><span class="o">(</span><span class="n">String</span> <span class="n">sana</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">ehdonTayttavat</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;();</span>

        <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">rivi</span> <span class="o">:</span> <span class="n">rivit</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">rivi</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">sana</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">ehdonTayttavat</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">rivi</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">ehdonTayttavat</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Luokalla on kolme metodia, kaikki kirjan rivit palauttava <em>rivit</em> sekä <em>rivitJotkaPaattyvatHuutomerkkiin</em> ja <em>rivitJoillaSana(String sana)</em> jotka toimivat kuten metodin nimi antaa ymmärtää.</p>

<p>Luokkaa käytetään seuraavasti:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">String</span> <span class="n">osoite</span> <span class="o">=</span> <span class="s">"https://www.gutenberg.org/files/2554/2554-0.txt"</span><span class="o">;</span>
    <span class="n">GutenbergLukija</span> <span class="n">kirja</span> <span class="o">=</span> <span class="k">new</span> <span class="n">GutenbergLukija</span><span class="o">(</span><span class="n">osoite</span><span class="o">);</span>

    <span class="k">for</span><span class="o">(</span> <span class="n">String</span> <span class="n">rivi</span> <span class="o">:</span> <span class="n">kirja</span><span class="o">.</span><span class="na">rivitJoillaSana</span><span class="o">(</span><span class="s">"beer"</span><span class="o">)</span> <span class="o">)</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">rivi</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Luokka on ohjelmoitu “perinteisellä” imperatiivisella tyylillä, kirjan rivejä käydään läpi for-lauseella ja kunkin rivin kohdalla tarkastetaan ehtolauseella onko rivi kyseisen metodin kriteerit täyttävä, esim. huutomerkkiin loppuva.</p>

<p>Tutustutaan seuraavassa hieman <a href="http://docs.oracle.com/javase/8/docs/api/">Java 8:n</a> mukanaan tuomiin funktionaalista ohjelmointitapaa helpottaviin piirteisiin, lambda-lausekkeisiin sekä kokoelmien käsittelyyn streameina. Nämä asiat ovat toki monelle tuttuja jo kursseilta Ohjelmoinnin perusteet ja Ohjelmoinnin jatkokurssi.</p>

<p>Voimme korvata listalla olevien merkkijonojen tulostamisen kutsumalla listoilla (tarkemmin sanottuna rajapinnan <a href="http://docs.oracle.com/javase/8/docs/api/java/lang/Iterable.html">Interable</a>-toteuttavilla luokilla) olevaa metodia <em>forEach</em>, joka mahdollistaa listan alkioiden läpikäynnin “funktionaaliseen” tyyliin. Metodi saa parametrikseen “functional interfacen”, eli rajapinnan, joka määrittelee ainoastaan yhden toteutettavan metodin, toteuttavan olion. Tälläisiä ovat uudemmassa Javassa myös ns. <em>lambda-lausekkeet</em> (engl. lambda expression), joka tarkoittaa käytännössä anonyymia mihinkään luokkaan liittymätöntä metodia.  Seuraavassa metodikutsun <em>rivitJoillaSana(“beer”)</em> palauttavien kirjan rivien tulostus forEachia ja lambdaa käyttäen:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">String</span> <span class="n">osoite</span> <span class="o">=</span> <span class="s">"https://www.gutenberg.org/files/2554/2554-0.txt"</span><span class="o">;</span>
    <span class="n">GutenbergLukija</span> <span class="n">kirja</span> <span class="o">=</span> <span class="k">new</span> <span class="n">GutenbergLukija</span><span class="o">(</span><span class="n">osoite</span><span class="o">);</span>

    <span class="n">kirja</span><span class="o">.</span><span class="na">rivitJoillaSana</span><span class="o">(</span><span class="s">"beer"</span><span class="o">).</span><span class="na">forEach</span><span class="o">(</span><span class="n">s</span> <span class="o">-&gt;</span> <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">s</span><span class="o">));</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Esimerkissä lambdan syntaksi oli seuraava:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">s</span> <span class="o">-&gt;</span> <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">s</span><span class="o">)</span>
</code></pre></div></div>

<p>parametri <em>s</em> saa arvokseen yksi kerrallaan kunkin tiedoston tekstirivin. Riveille suoritetaan “nuolen” oikealla puolella oleva tulostuskomento. Lisää lambdan syntaksista <a href="http://docs.oracle.com/javase/tutorial/java/javaOO/lambdaexpressions.html">täältä</a>. Huomionarvoista on se, että lambdan parametrin eli muuttujan <em>s</em> tyyppiä ei tarvitse määritellä, kääntäjä osaa päätellä sen iteroitavana olevan kokoelman perusteella.</p>

<p>Luokan <em>GutenbergLukija</em> tarjoamat kolme kirjan sisällön hakemiseen tarkoitettua metodia ovat selvästi rakenteeltaan hyvin samantapaisia. Kaikki käyvät jokaisen kirjan rivin läpi ja palauttavat niistä osan (tai kaikki) metodin kutsujalle. Metodit eroavat sen suhteen <em>mitä kirjan riveistä ne palauttavat</em>. Metodit ovat siis lähes copypastea, ne kuitenkin eroavat sen verran toisistaan, että copypasten eliminoiminen ei ole täysin suoraviivaista.</p>

<p>Jos mietitään metodien toimintaa, niin voidaan ajatella, että jokaisessa metodissa on oma <em>strategiansa</em> rivien palauttamiseen, ja strategiaa lukuunottamatta kaikki muu on samaa. Tämä onkin erinomainen paikka strategy-suunnittelumallin soveltamiseen. Jos eriytämme rivien valintastrategia omaksi luokakseen, voidaan selvitä ainoastaan yhdellä rivien läpikäynnin hoitavalla metodilla.</p>

<p>Määritellään rivien valintaa varten rajapinta:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Ehto</span> <span class="o">{</span>
    <span class="kt">boolean</span> <span class="nf">test</span><span class="o">(</span><span class="n">String</span> <span class="n">rivi</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Huom: metodin nimen valinta ei ollut täysin sattumanvarainen. Tulemme myöhemmin määrittelemään, että rajapinta <em>Ehto</em> laajentaa rajapinnan, joka vaatii että rajapinnalla on nimenomaan <em>test</em>-niminen metodi.</p>

<p>Ideana on luoda jokaista kirjojen erilaista <em>hakuehtoa</em> kohti oma rajapinnan <em>Ehto</em> toteuttava luokka.</p>

<p>Seuraavassa ehto-luokka, joka tarkastaa sisältyykö tietty sana riville:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SisaltaaSanan</span> <span class="kd">implements</span> <span class="n">Ehto</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">sana</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">SisaltaaSanan</span><span class="o">(</span><span class="n">String</span> <span class="n">sana</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">sana</span> <span class="o">=</span> <span class="n">sana</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">test</span><span class="o">(</span><span class="n">String</span> <span class="n">rivi</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">rivi</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">sana</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Jos luokasta luodaan ilmentymä</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Ehto</span> <span class="n">ehto</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SisaltaaSanan</span><span class="o">(</span><span class="s">"olut"</span><span class="o">);</span>
</code></pre></div></div>

<p>voidaan luokan avulla tarkastella sisältävätkö merkkijonot sanan <em>olut</em>:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Ehto</span> <span class="n">ehto</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SisaltaaSanan</span><span class="o">(</span><span class="s">"olut"</span><span class="o">);</span>
<span class="n">ehto</span><span class="o">.</span><span class="na">test</span><span class="o">(</span><span class="s">"internetin paras suomenkielinen olutsivusto on olutopas.info"</span><span class="o">);</span>
<span class="n">ehto</span><span class="o">.</span><span class="na">test</span><span class="o">(</span><span class="s">"Java 13 ilmestyi 17.9.2019"</span><span class="o">);</span>
</code></pre></div></div>

<p>Ensimmäinen metodikutsuista palauttaisi <em>true</em> ja jälkimmäinen <em>false</em>.</p>

<p>Kirjasta voidaan palauttaa oikean ehdon täyttävät sanat lisäämällä luokalle <em>GutenbergLukija</em> metodi:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">rivitJotkaTayttavatEhdon</span><span class="o">(</span><span class="n">Ehto</span> <span class="n">ehto</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">palautettavatRivit</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>

    <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">rivi</span> <span class="o">:</span> <span class="n">rivit</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">ehto</span><span class="o">.</span><span class="na">test</span><span class="o">(</span><span class="n">rivi</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">palautettavatRivit</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">rivi</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="k">return</span> <span class="n">palautettavatRivit</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>ja sanan <em>beer</em> sisältävät rivit saadaan tulostettua seuraavasti:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">kirja</span><span class="o">.</span><span class="na">rivitJotkaTayttavatEhdon</span><span class="o">(</span><span class="k">new</span> <span class="n">SisaltaaSanan</span><span class="o">(</span><span class="s">"beer"</span><span class="o">)).</span><span class="na">forEach</span><span class="o">(</span><span class="n">s</span> <span class="o">-&gt;</span> <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">s</span><span class="o">));</span>
</code></pre></div></div>

<p>Pääsemmekin sopivien ehto-luokkien määrittelyllä eroon alkuperäisistä rivien hakumetodeista. Sovellus tulee sikälikin huomattavasti joustavammaksi, että uusia hakuehtoja voidaan helposti lisätä määrittelemällä uusia rajapinnan <em>Ehto</em> määritteleviä luokkia.</p>

<p>Ehto-rajapinta on ns. <em>funktionaalinen rajapinta</em> (engl. functional interface) eli se määrittelee ainoastaan yhden toteutettavan metodin. Javan uusimmilla versioilla voimme määritellä ehtoja myös lambda-lausekkeiden avulla. Eli ei ole välttämätöntä tarvetta määritellä eksplisiittisesti rajapinnan <em>Ehto</em> toteuttavia luokkia. Seuraavassa edellinen esimerkki käyttäen lambda-lauseketta ehdon määrittelemiseen:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">kirja</span><span class="o">.</span><span class="na">rivitJotkaTayttavatEhdon</span><span class="o">(</span><span class="n">s</span> <span class="o">-&gt;</span> <span class="n">s</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="s">"beer"</span><span class="o">)).</span><span class="na">forEach</span><span class="o">(</span><span class="n">s</span> <span class="o">-&gt;</span> <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">s</span><span class="o">));</span>
</code></pre></div></div>

<p>Käytännössä siis määrittelemme “lennossa” rajapinnan <em>Ehto</em> toteuttavan luokan, jonka ainoan metodin toiminnallisuuden määritelmä annetaan lambda-lausekkeen avulla:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">s</span> <span class="o">-&gt;</span> <span class="n">s</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="s">"beer"</span><span class="o">)</span>
</code></pre></div></div>

<p>Lambdojen avulla on helppoa määritellä mielivaltaisia ehtoja. Seuraavassa tulostetaan kaikki rivit, joilla esiintyy jompi kumpi sanoista <em>beer</em> tai <em>vodka</em>. Ehdon ilmaiseva lambda-lauseke on nyt määritelty selvyyden vuoksi omalla rivillään:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Ehto</span> <span class="n">ehto</span> <span class="o">=</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="n">s</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="s">"beer"</span><span class="o">)</span> <span class="o">||</span> <span class="n">s</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="s">"vodka"</span><span class="o">);</span>

<span class="n">kirja</span><span class="o">.</span><span class="na">rivitJotkaTayttavatEhdon</span><span class="o">(</span><span class="n">ehto</span><span class="o">).</span><span class="na">forEach</span><span class="o">(</span><span class="n">s</span> <span class="o">-&gt;</span> <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">s</span><span class="o">));</span>
</code></pre></div></div>

<p>Voimme hyödyntää Javan funktionaalisia piirteitä myös luokan <em>GutenbergLukija</em> metodissa <em>rivitJotkaTayttavatEhdon</em>.</p>

<p>Metodi on tällä hetkellä seuraava:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">rivitJotkaTayttavatEhdon</span><span class="o">(</span><span class="n">Ehto</span> <span class="n">ehto</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">palautettavatRivit</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>

    <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">rivi</span> <span class="o">:</span> <span class="n">rivit</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">ehto</span><span class="o">.</span><span class="na">test</span><span class="o">(</span><span class="n">rivi</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">palautettavatRivit</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">rivi</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="k">return</span> <span class="n">palautettavatRivit</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Uusissa Javan versioissa kaikki rajapinnan <em>Collection</em> toteuttavat luokat mahdollistavat alkioidensa käsittelyn <em>Stream</em>:ina eli “alkiovirtoina”, ks. <a href="http://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html">API-kuvaus</a>. Kokoelmaluokasta saadaan sitä vastaava alkiovirta kutsumalla kokoelmalle metodia <em>stream</em>.</p>

<p>Alkiovirtoja on taas mahdollista käsitellä monin tavoin, nyt meitä kiinnostava metodi on <em>filter</em>, jonka avulla streamista voidaan tehdä uusi streami, josta on poistettu ne alkiot, jotka eivät täytä filtterille annettua boolean-arvoista, funktionaalisen rajapinnan _Predicate<String>_ toteuttavaa ehtoa.</String></p>

<p>Määrittelemämme rajapinta <em>Ehto</em> on oikeastaan juuri tarkoitukseen sopiva. Jotta voisimme käyttää rajapintaa, tulee meidän kuitenkin tyyppitarkastusten takia määritellä että rajapintamme laajentaa rajapintaa _Predicate<String>_:</String></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.util.function.Predicate</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Ehto</span> <span class="kd">extends</span> <span class="n">Predicate</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;{</span>
    <span class="kt">boolean</span> <span class="nf">test</span><span class="o">(</span><span class="n">String</span> <span class="n">rivi</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Nyt saamme muutettua kirjan rivien streamin <em>ehdon</em> täyttävien rivien streamiksi seuraavasti:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">rivitJotkaTayttavatEhdon</span><span class="o">(</span><span class="n">Ehto</span> <span class="n">ehto</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// ei toimi vielä</span>
    <span class="n">rivit</span><span class="o">.</span><span class="na">stream</span><span class="o">().</span><span class="na">filter</span><span class="o">(</span><span class="n">ehto</span><span class="o">)</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Metodin tulee palauttaa filtteröidyn streamin alkioista koostuva lista. Stream saadaan muutettua listaksi “keräämällä” sen sisältämät alkiot kutsumalla streamille metodia <em>collect</em> ja kertomalla sille parametrina, että halutaan streamin sisältämät alkiot niemen omana listana. Näin luotu filtteröity lista voidaan sitten palauttaa metodin kutsujalle.</p>

<p>Metodi on seuraavassa:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">rivitJotkaTayttavatEhdon</span><span class="o">(</span><span class="n">Ehto</span> <span class="n">ehto</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">rivit</span><span class="o">.</span><span class="na">stream</span><span class="o">().</span><span class="na">filter</span><span class="o">(</span><span class="n">ehto</span><span class="o">).</span><span class="na">collect</span><span class="o">(</span><span class="n">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">());</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Voimme oikeastaan luopua itse määrittelemästämme rajapinnasta <em>Ehto</em>, sillä valmis funktionaalinen rajapinta _Predicate<String>_ ajaa saman asian. Yksittäisiä ehtoja määrittelevät luokat voidaan muuttaa seuraavasti:</String></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SisaltaaSanan</span> <span class="kd">implements</span> <span class="n">Predicate</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="c1">// ...</span>
<span class="o">}</span>
</code></pre></div></div>

<p>ja lukija muuttuu muotoon:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">GutenbergLukija</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">rivit</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">GutenbergLukija</span><span class="o">(</span><span class="n">String</span> <span class="n">osoite</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IllegalArgumentException</span> <span class="o">{</span>
        <span class="c1">// ...</span>
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">rivitJotkaTayttavatEhdon</span><span class="o">(</span><span class="n">Predicate</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">ehto</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">rivit</span><span class="o">.</span><span class="na">stream</span><span class="o">().</span><span class="na">filter</span><span class="o">(</span><span class="n">ehto</span><span class="o">).</span><span class="na">collect</span><span class="o">(</span><span class="n">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">());</span>
    <span class="o">}</span>    
<span class="o">}</span>
</code></pre></div></div>

<p>Funktionaalinen rajapinta <em>Predicate</em> sisältää itse asiassa muutamia valmiiksi toteutettuja metodeja, joiden avulla on mahdollista <em>koostaa</em> yksittäisistä ehdoista <em>monimutkaisempia ehtoja</em>. Seuraavassa etsitään ne rivit jotka</p>

<ul>
  <li>sisältävät sanan <em>beer</em> ja ovat yli 50 riviä pitkiä <em>tai</em></li>
  <li>alkavat kirjaimella <em>Z</em></li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Predicate</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">ehto1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SisaltaaSanan</span><span class="o">(</span><span class="s">"beer"</span><span class="o">);</span>
<span class="n">Predicate</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">ehto2</span> <span class="o">=</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="n">s</span><span class="o">.</span><span class="na">length</span><span class="o">()&gt;</span><span class="mi">50</span><span class="o">;</span>
<span class="n">Predicate</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">ehto3</span> <span class="o">=</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="n">s</span><span class="o">.</span><span class="na">length</span><span class="o">()&gt;</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">s</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span> <span class="o">==</span> <span class="sc">'Z'</span><span class="o">;</span>

<span class="n">kirja</span>
    <span class="o">.</span><span class="na">rivitJotkaTayttavatEhdon</span><span class="o">((</span><span class="n">ehto1</span><span class="o">.</span><span class="na">and</span><span class="o">(</span><span class="n">ehto2</span><span class="o">)).</span><span class="na">or</span><span class="o">(</span><span class="n">ehto3</span><span class="o">))</span>
    <span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">s</span><span class="o">));</span>
</code></pre></div></div>

<h4 id="hyvä-vs-paha-copypaste-viikko-5">Hyvä vs. paha copypaste <span style="color:blue">[viikko 5]</span></h4>

<p>Vaikka koodin, konfiguraatioiden, tietokantaskeeman yms. toisteettomuus on yleisesti ottaen hyvä asia, voi ajoittain olla järkevää ainakin ensin tehdä nopea copypasteen perustuva ratkaisu ja <a href="/osa4/refaktorointi">refaktoroida</a> koodi tarvittaessa myöhemmin siistimmäksi.</p>

<p>Monissa tilanteissa nimittäin copypasten poistamisella on pieni hintansa, se saattaa muuttaa sovellusta monimutkaisemmaksi. Gutenberg-lukijan kohdalla alkuperäinen versio saattaisi olla täysin riittävä käyttöön, ja refaktorointi ei välttämättä olisi vaivan arvoinen. Mutta jos sovellukseen tulisi tarve useimpiin ehtoihin, ei sovelluksen alkuperäinen design siihen kunnolla taipuisi ja copypastea tulisi yhä suuremmat määrät.</p>

<p>Melko hyvä periaate onkin <em><a href="https://en.wikipedia.org/wiki/Rule_of_three_(computer_programming)">three strikes and you refactor</a></em>, eli samankaltainen koodilogiikka kahdessa kohtaa on kutakuinkin ok, mutta jos se tulee kopioida vielä kolmanteen kohtaan, on parempi refaktoroida koodia siten, että copypaste saadaan eliminoitua.</p>

<h3 id="koodin-laatuattribuutti-testattavuus">Koodin laatuattribuutti: testattavuus</h3>

<p>Tärkeä piirre hyvällä koodilla on sen testattavuus, eli koodi on helppo testata kattavasti yksikkö- ja integraatiotestein. Helppo testattavuus seuraa yleensä siitä, että koodi koostuu löyhästi kytketyistä, selkeän vastuun omaavista komponenteista.</p>

<p>Kääntäen, jos koodin kattava testaaminen on vaikeaa, on se usein seurausta siitä, että komponenttien vastuut eivät ole selkeät, ja niillä on liikaa riippuvuuksia.</p>

<p>Olemme pyrkineet jo kurssin ensimmäiseltä viikolta asti koodin hyvään testattavuuteen esim. purkamalla turhia riippuvuuksia rajapintojen ja riippuvuuksien injektoinnin avulla.</p>

<h3 id="koodin-laatuattribuutti-selkeys">Koodin laatuattribuutti: selkeys</h3>

<p>Perinteisesti ohjelmakoodin on ajateltu olevan väkisinkin kryptistä ja vaikeasti luettavaa.
Esim. c-kielessä on tapana ollut kirjoittaa todella tiivistä koodia, jossa yhdellä rivillä on ollut tarkoitus tehdä mahdollisimman monta asiaa, metodikutsuja on vältetty tehokkuussyistä, muistinkäyttöä on optimoitu uusiokäyttämällä muuttujia ja “koodaamalla” dataa bittitasolla.</p>

<p>Ajat ovat muuttuneet ja nykyisen trendin mukaista on pyrkiä kirjoittamaan koodia, joka jo nimeämiskäytänteiden sekä rakenteen kautta ilmaisee mahdollisimman hyvin sen, mitä koodi tekee.</p>

<p>Selkeän nimennän lisäksi muita luettavan eli “puhtaan” koodin (engl. clean code) tunnusmerkkejä ovat jo monet meille entuudestaan tutut asiat joita on listattu 
<a href="www.planetgeek.ch/wp-content/uploads/2011/02/Clean-Code-Cheat-Sheet-V1.3.pdf">täällä</a>.</p>

<p>Miksi selkeän koodin kirjoittaminen on niin tärkeää, eikö riitä että koodari ymmärtää itse mistä koodissa on kyse? Tämä ei todellakaan riitä, sillä suurin osa, <a href="https://www.goodreads.com/quotes/835238-indeed-the-ratio-of-time-spent-reading-versus-writing-is">joidenkin arvioiden mukaan jopa 90%</a>  “ohjelmointiin” kuluvasta ajasta menee olemassa olevan koodin lukemiseen. Koodia, joko itsensä tai jonkun muun kirjoittamaa, on luettava debuggauksen yhteydessä sekä sovellusta laajennettaessa. On kovin tyypillistä että se oma aikoinaan niin selkeä koodi, ei sitten olekaan yhtä selkeää parin kuukauden kuluttua:</p>

<p><img src="http://localhost:4000/images/4-13.jpg" alt="" height="350px" /></p>

<h3 id="code-smell">Code smell</h3>

<p>Koodissa olevista epäilyttävistä piirteistä on ruvettu käyttämään nimitystä <em>code smell</em> eli koodihaju.</p>

<p>Martin Fowlerin <a href="https://martinfowler.com/books/refactoring.html">määritelmää mukaillen</a> koodihaju on helpohkosti huomattava merkki siitä että koodissa on jotain pielessä. Vaikka jopa aloitteleva ohjelmoija saattaa pystyä havaitsemaan koodihajun, sen takana oleva todellinen syy voi olla jossain syvemmällä, jopa ohjelman designissa. Koodihaju siis kertoo sen, että syystä tai toisesta koodin sisäinen laatu ei ole parhaalla mahdollisella tasolla.</p>

<p>Koodihajuja on hyvin monenlaisia ja monentasoisia. Muutamia esimerkkejä helposti tunnistettavista hajuista:</p>

<ul>
  <li>toisteinen koodi</li>
  <li>liian pitkät metodit</li>
  <li>luokat joissa on liikaa oliomuuttujia</li>
  <li>luokat joissa on liikaa koodia</li>
  <li>metodien liian pitkät parametrilistat</li>
  <li>epäselkeät muuttujien, metodien tai luokkien nimet</li>
  <li>kommentit</li>
</ul>

<p>Oikeastaan kaikki näistä ovat merkkejä edellä listaamiemme hyvän koodin laatuattribuutteja heikentävistä ilmiöistä, esim. erittäin pitkä metodi todennäköisesti tarkoittaa, että metodin koheesio on huono, samoin luokka jossa on paljon koodia tai oliomuuttujia tarkoittaa suurella todennäköisyydellä että single responsibility -periaatetta ei noudateta. Jos luokan metodeilla on paljon parametreja, voi se kieliä siitä, että osa tiedoista on väärän luokan vastuulla, tai että metodin kuuluisi mielummin olla jossain toisessa luokassa.</p>

<p>Nykyään koodin <a href="https://medium.com/@fagnerbrack/code-comment-is-a-smell-4e8d78b0415b">kommentointia</a> on hieman yllättäen alettu pitämään koodihajuna. Kyse on oikeastaan siitä, että koodi pitäisi lähtökohtaisesti kirjoittaa niin selkeäksi ja nimeämiskäytäntöjen osalta kommunikoivaksi, että kommentteja ei tarvita. Eli kommentit tulee säästää vain sellaisiin kohtiin, jossa samaa asiaa ole mahdollista ilmaista koodin muotoilulla ja paremmalla nimeämisellä.</p>

<p>Otetaan pari esimerkkiä hieman vähemmän ilmeisistä koodihajuista.</p>

<p><a href="https://sourcemaking.com/refactoring/primitive-obsession">Primitive obsession</a> tarkoittaa tilannetta, missä jossa jokin konkreettinen käsite esim. <em>osoite</em> tai <em>rahamäärä</em> esitetään primitiivityyppisten muuttujien (esim. merkkijono tai kokonaisluku) avulla, sen sijaan että määriteltäisiin luokka asian esittämiseen.</p>

<p>Nimellä <a href="https://sourcemaking.com/refactoring/shotgun-surgery">shotgun surgery</a> kuvataan tilannetta, missä yhden loogisen asian muuttaminen, laajentaminen tai siihen tehtävä bugikorjaus aiheuttaakin sarjan muutoksia myös todella moneen muuhun paikkaan koodia. Tämä on oire siitä, että toiminnallisuutta ei ole kapseloitu riittävän hyvin yhteen koodimoduuliin, eli kyseessä on DRY-periaatetta rikkova design.</p>

<p>Internetistä löytyy suuret määrät listoja koodihajuista, esim. seuraavat</p>

<ul>
  <li><a href="https://sourcemaking.com/refactoring/bad-smells-in-code">https://sourcemaking.com/refactoring/bad-smells-in-code</a></li>
  <li><a href="https://www.codinghorror.com/blog/2006/05/code-smells.html">https://www.codinghorror.com/blog/2006/05/code-smells.html</a></li>
</ul>

<h3 id="refaktorointi">Refaktorointi</h3>

<p>Lääke sovelluksen koodin sisäisen laadun ongelmiin on <em>refaktorointi</em> eli muutos koodin, esimerkiksi luokan rakenteeseen, joka kuitenkin pitää sen toiminnallisuuden ennallaan.</p>

<p>Refaktoroinnin systemaattisena koodin sisäisen laadun parannuskeinona toi suurten massojen tietoisuuteen Martin Fowlerin vuonna 2000 julkaisema kirja <a href="https://martinfowler.com/books/refactoring.html">Refactoring</a>. Kirjan toinen, kokonaan uudelleenkirjoitettu painos ilmestyi 2018.</p>

<p>Fowlerin kirja listaa lukuisia koodin rakennetta parantavia, tiettyihin tilanteisiin sopivia refaktorointioperaatioita. Kirjan listaamat refaktoroinnit löytyvät myös <a href="https://refactoring.com/catalog/index.html">internetistä</a>. Seuraavassa muutamia esimerkkejä</p>

<ul>
  <li><em>rename variable/method/class</em> uudelleennimetään huonosti nimetty asia</li>
  <li><em>extract method</em> jaetaan liian pitkä metodi erottamalla siitä pienempiä metodeja</li>
  <li><em>move field/method</em> siirretään oliomuuttuja tai metodi toiseen luokkaan</li>
  <li><em>extract interface</em> luodaan luokan julkisia metodeja vastaava rajapinta, jonka avulla voidaan purkaa olion käyttäjän ja olion väliltä konkreettinen riippuvuus</li>
  <li><em>extract superclass</em> luodaan yliluokka, johon siirretään osa luokan toiminnallisuudesta</li>
</ul>

<p>Suuri osa tässä luetelluista refaktorointioperaatioista on sellaisia, että useimmat ohjelmointiympäristöt (esim. NetBeans, Eclipse ja IntelliJ) pystyvät tekemään ne suurelta osin automaattisesti. Automatisoitu refaktorointi onnistuu huomattavasti helpommin staattisesti tyypitetyille kielille kuten Java, dynaamisesti tyypitettyjen kielten kuten Javascript ja Python kohdalla se on huomattavasti hankalampaa.</p>

<p>Melko monissa ei niin suoraviivaisissa refaktorointioperaatioissa, epäoptimaalinen koodi refaktoroidaan paremmaksi soveltamalla jotain suunnittelumallia. Joshua Kerievsky on kirjoittanut aiheesta mainion kirjan <a href="https://martinfowler.com/books/r2p.html">Refactoring to patterns</a>.</p>

<p>Aiemmissa esimerkeissä näimme tämän kaltaisia  refaktorointeja, esim.</p>

<ul>
  <li>tilien koronmaksustrategia <a href="https://refactoring.com/catalog/replaceConditionalWithPolymorphism.html">replace conditional with polymorfism</a></li>
  <li>tilien luominen <a href="https://refactoring.com/catalog/replaceConstructorWithFactoryFunction.html">replace constructor with factory method</a></li>
  <li>laskimen komennot <a href="https://refactoring.com/catalog/replaceFunctionWithCommand.html">replace method with method object</a></li>
  <li>laskimen binäärioperaatiot <a href="https://sourcemaking.com/refactoring/form-template-method">form template method</a>.</li>
</ul>

<p>Refaktoroinnin melkein ehdoton edellytys (poislukien yksinkertaiset automaattisesti suoritettavat refaktoroinnit, kuten <em>rename variable</em>) on kattavien testien olemassaolo. Refaktoroinnissa on tarkoitus ainoastaan parantaa luokan tai komponentin sisäistä rakennetta, ulospäin näkyvän toiminnallisuuden pitäisi pysyä muuttumattomana, ja tästä varmistuminen ilman testejä on erittäin haastavaa.</p>

<p>Refaktoroinnissa kannattaa ehdottomasti edetä pienin askelin eli yksi hallittu muutos kerrallaan. Testit on syytä suorittaa jokaisen refaktorointioperaation jälkeen, jotta mahdollinen regressio, eli aiemmin toimineen koodin hajoaminen huomataan mahdollisimman nopeasti.</p>

<p>Refaktorointia kannattaa tehdä lähes koko ajan. Kun koodin sisäinen laatu säilyy siistinä, on koodin laajentaminen miellyttävää ja pienien refaktorointioperaatioiden tekeminen suhteellisen vaivatonta. Jos koodin sisäinen laatu pääsee rapistumaan, muuttuu sen laajentaminen hitaaksi ja myös refaktoroinnin suorittaminen muuttuu koko ajan työläämmäksi. Monilla ohjelmistokehitystiimeillä onkin <em>definition of doneen</em> kirjattu, että valmiin määritelmä sisältää sen, että koodi on refaktoroitu riittävän siistiksi. Siisteyttä saatetaan valvoa esim. <a href="osa3#koodin-katselmointi-github-ja-pull-requestit">pull requesteina tehtävänä katselmointina</a>.</p>

<p>Osa refaktoroinneista, esim. metodien tai luokkien uudelleennimeäminen tai pitkien metodien jakaminen pienemmiksi on helppoa. Aina ei näin kuitenkaan ole. Joskus on tarve tehdä suurempien mittaluokkien refaktorointeja, joissa ohjelman rakenne eli arkkitehtuuri muuttuu. Tällaiset refaktoroinnit saattavat kestää päiviä tai jopa viikkoja ja niiden suorittaminen siten, että koodi säilyy koko ajan toimivana on jo kohtuullisen haastavaa.</p>

<h3 id="tekninen-velka">Tekninen velka</h3>

<p>Koodi ei ole aina sisäiseltä laadultaan optimaalista, ja joskus on jopa asiakkaan kannalta tarkoituksenmukaista tehdä vähemmän laadukasta koodia. Huonoa suunnittelua tai/ja ohjelmointia on ruvettu kuvaamaan käsitteellä <em>tekninen velka</em> (engl. technical debt).</p>

<p>Oikoteitä ottamalla tehdyllä ohjelmoinnilla saadaan ehkä nopeasti aikaan jotain toiminnallisuutta, mutta hätäinen ratkaisu tullaan maksamaan korkoineen takaisin myöhemmin <em>jos</em> ohjelmaa on tarkoitus laajentaa. Käytännössä käy siis niin, että koodiin kertyneet sisäisen laadun ongelmat, eli <em>tekninen velka</em> alkaa hidastamaan kehitystyön etenemistä, ja uusien ominaisuuksien toteuttamisesta tulee koko ajan hankalammaksi ja kalliimmaksi.</p>

<p>Toisaalta jos korkojen maksun aikaa ei koskaan tule, eli ohjelma on esimerkiksi pelkkä prototyyppi tai sitä ei koskaan oteta käyttöön, on teknisen velan ottaminen asiakkaan kannalta kannattava ratkaisu.</p>

<p><a href="/osa2/#vaatimusmäärittely-2010-luvulla">Osassa 2</a> käsiteltiin <em>lean startup</em> -ideologian mukaista tapaa ohjelmiston uusien ominaisuuden hyödyllisyyden validointiin rakentamalla ominaisuuden toteuttama <em>minimal viable product (MVP)</em>, eli juuri ja juuri riittävä ratkaisu, jonka avulla ominaisuuden käyttökelpoisuutta voidaan testata. Kuten nimikin jo antaa ymmärtää, MVP on luonteeltaan sellainen rakennelma, että sitä tehdessä otetaan tietoisesti teknistä velkaa. <em>Jos</em> ominaisuus osoittautuu halutuksi, maksetaan tekninen velka pois tekemällä toiminnallisuudelle robustimpi toteutus.</p>

<p>Lyhytaikaisen teknisen velan ottaminen voi joskus olla jopa välttämätöntä. Esimerkiksi markkinatilanteen takia saattaa olla oleellista saada tuote kuluttajille mahdollisimman nopeasti tai muuten tilaisuus saattaa mennä kokonaan ohi. Startup-yrityksillä tilanne voi olla se, että firma joutuu valitsemaan teknisen velan ja varman rahojen loppumisen välillä, eli tekemällä jotain nopeasti huonolla sisäisellä laadulla, firma saattaa pystyä keräämään riittävästi rahoitusta jatkaakseen toimintaansa. Tämänkaltaisissa tilanteissa otetaan tietoisesti teknistä velkaa ja sovelluksen koodin huonosta laadusta ja testauksen puuttumisesta huolehditaan myöhemmin.</p>

<p>Tekninen velka ei siis ole pelkästään paha asia, vaan strategisesti käytettynä hyväkin väline, aivan kuten esim. asuntolaina, ilman lainaa kaikilla ei ole varaa omistusasuntoon. On kuitenkin oleellista mitoittaa lainan määrä oikein, muuten seurauksena saattaa olla luottokelpoisuuden menetys.</p>

<p>Teknisen velan takana voi siis olla monenlaisia syitä, esim. holtittomuus, osaamattomuus, tietämättömyys tai tarkoituksella tehty päätös. Martin Fowler <a href="https://martinfowler.com/bliki/TechnicalDebtQuadrant.html">jakaa</a> teknisen velan neljään eri luokkaan:</p>

<ol>
  <li>reckless and deliberate: “we do not have time for design”</li>
  <li>reckless and inadverent: “what is layering”?</li>
  <li>prudent and inadverent: “now we know how we should have done it”</li>
  <li>prudent and deliberate: “we must ship now and will deal with consequences”</li>
</ol>

<p>Luokkien 1 ja 2, joista Fowler käyttää termiä <em>reckless</em> eli holtiton tai uhkarohkea, voi ajatella olevan huonoa teknistä velkaa. Toinen syntyy tarkoituksella, eli ajatellen että ei ole aikaa laadulle, toinen taas syntyy osaamattomuuden takia.</p>

<p>Luokat 3 ja 4 ovat harkinnan alla (engl. <em>prudent</em>) syntynyttä teknistä velkaa. Luokka 4 on juurikin tilanne, jossa ollaan esim. tekemässä MVP:tä, tai jonkun pakon takia koodi on saatava julkaistua heti ja seuraukset päätetään hoitaa myöhemmin. Luokka 3 on kovin yleinen tilanne, ohjelmistoa suunniteltiin ja rakennettiin parhaiden aikomusten mukaan, mutta vasta paljon myöhemmin, kun arkkitehtuuri ja design on jo lyöty lukkoon vasta opitaan sovelluksen luonteesta sen verran, että tiedetään <em>kuinka sovellus olisi tullut suunnitella</em>. Tälläinen tilanne saatetaan päätyä ratkaisemaan refaktoroimalla sovelluksen arkkitehtuuri paremmin tarpeita vastaavaksi.</p>

<h3 id="lisää-suunnittelumalleja-viikko-6">Lisää suunnittelumalleja <span style="color:blue">[viikko 6]</span></h3>

<p>Tutustutaan osan lopuksi vielä muutama uuteen suunnittelumalliin.</p>

<h4 id="esimerkki-dekoroitu-pino-viikko-6">Esimerkki Dekoroitu pino <span style="color:blue">[viikko 6]</span></h4>

<p>Olemme toteuttaneet asiakkaalle pinon:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Pino</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="n">LinkedList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">alkiot</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">Pino</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">alkiot</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">push</span><span class="o">(</span><span class="n">String</span> <span class="n">alkio</span><span class="o">){</span>
        <span class="n">alkiot</span><span class="o">.</span><span class="na">addFirst</span><span class="o">(</span><span class="n">alkio</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">pop</span><span class="o">(){</span>
        <span class="k">return</span> <span class="n">alkiot</span><span class="o">.</span><span class="na">remove</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">empty</span><span class="o">(){</span>
        <span class="k">return</span> <span class="n">alkiot</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">Scanner</span> <span class="n">lukija</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Scanner</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">in</span><span class="o">);</span>
    <span class="n">Pino</span> <span class="n">pino</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Pino</span><span class="o">();</span>

    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"pinotaan, tyhjä lopettaa:"</span><span class="o">);</span>
    <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">pinoon</span> <span class="o">=</span> <span class="n">lukija</span><span class="o">.</span><span class="na">nextLine</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">pinoon</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">break</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">pino</span><span class="o">.</span><span class="na">push</span><span class="o">(</span><span class="n">pinoon</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"pinossa oli: "</span><span class="o">);</span>
    <span class="k">while</span> <span class="o">(!</span><span class="n">pino</span><span class="o">.</span><span class="na">empty</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span> <span class="n">pino</span><span class="o">.</span><span class="na">pop</span><span class="o">()</span> <span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Asiakkaamme haluaa pinosta muutaman uuden version:</p>

<ul>
  <li><em>KryptattuPino</em> jossa alkiot talletetaan pinoon kryptattuina, alkiot tulevat pinosta ulos normaalisti</li>
  <li><em>LokiPino</em> jossa tieto pinoamisoperaatioista ja niiden parametreista ja paluuarvoista talletetaan lokiin</li>
  <li><em>PrepaidPino</em> joka lakkaa toimimasta kun sillä on suoritettu konstruktoriparametrina määritelty määrä operaatioita</li>
</ul>

<p>On lisäksi toteutettava kaikki mahdolliset kombinaatiot:</p>

<ul>
  <li><em>KryptattuLokiPino</em></li>
  <li><em>LokiKryptattuPino</em> (erona edelliseen se että lokiin ei kirjata parametreja kryptattuna)</li>
  <li><em>KryptattuPrepaidPino</em></li>
  <li><em>KryptattuLokiPrepaidPino</em></li>
  <li><em>LokiPrepaidPino</em></li>
</ul>

<p>Alkaa kuulostaa pahalta varsinkin kun Product Owner vihjaa, että seuraavassa sprintissä tullaan todennäköisesti vaatimaan lisää versioita pinosta, mm. ÄänimerkillinenPino, RajallisenkapasiteetinPino ja tietysti kaikki kombinaatiot tarvitaan myös…</p>

<p>Onneksi suunnittelumalli <em>dekoraattori</em> (engl. decorator) sopii juuri tilanteeseen! Luodaan pinon kolme uutta versiota dekoroituina pinoina. Tarkastellaan ensin PrepaidPinoa:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PrepaidPino</span> <span class="kd">extends</span> <span class="n">Pino</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="n">Pino</span> <span class="n">pino</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">krediitteja</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">PrepaidPino</span><span class="o">(</span><span class="n">Pino</span> <span class="n">pino</span><span class="o">,</span> <span class="kt">int</span> <span class="n">krediitteja</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">pino</span> <span class="o">=</span> <span class="n">pino</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">krediitteja</span> <span class="o">=</span> <span class="n">krediitteja</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">pop</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">krediitteja</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"pinossa ei enää käyttöoikeutta"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">krediitteja</span><span class="o">--;</span>

        <span class="k">return</span> <span class="n">pino</span><span class="o">.</span><span class="na">pop</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">push</span><span class="o">(</span><span class="n">String</span> <span class="n">alkio</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">krediitteja</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"pinossa ei enää käyttöoikeutta"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">krediitteja</span><span class="o">--;</span>
        <span class="n">pino</span><span class="o">.</span><span class="na">push</span><span class="o">(</span><span class="n">alkio</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">empty</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">krediitteja</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"pinossa ei enää käyttöoikeutta"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">krediitteja</span><span class="o">--;</span>
        <span class="k">return</span> <span class="n">pino</span><span class="o">.</span><span class="na">empty</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p><em>PrepaidPino</em> siis perii luokan <em>Pino</em>, mutta se ei käytä “perittyä” pinouttaan, vaan sen sijaan PrepaidPino <strong>sisältää</strong> pinon, jonka se saa konstruktoriparametrina. Tätä sisältämäänsä pinoa PrepaidPino käyttää tallettamaan kaikki alkionsa. Eli jokainen PrepaidPinon operaatio <em>delegoi</em> operaation toiminnallisuuden toteuttamisen sisältämälleen pinolle.</p>

<p>PrepaidPino luodaan seuraavalla tavalla:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Pino</span> <span class="n">pino</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PrepaidPino</span><span class="o">(</span><span class="k">new</span> <span class="n">Pino</span><span class="o">(),</span> <span class="mi">5</span><span class="o">);</span>
</code></pre></div></div>

<p>Eli luodaan normaali Pino ja annetaan se PrepaidPinolle konstruktoriparametrina yhdessä pinon krediittien kanssa.</p>

<p>Muut kaksi:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">KryptattuPino</span> <span class="kd">extends</span> <span class="n">Pino</span><span class="o">{</span>
    <span class="kd">private</span> <span class="n">Pino</span> <span class="n">pino</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">KryptattuPino</span><span class="o">(</span><span class="n">Pino</span> <span class="n">pino</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">pino</span> <span class="o">=</span> <span class="n">pino</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">pop</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">alkio</span> <span class="o">=</span> <span class="n">pino</span><span class="o">.</span><span class="na">pop</span><span class="o">();</span>
        <span class="k">return</span> <span class="nf">dekryptaa</span><span class="o">(</span><span class="n">alkio</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">push</span><span class="o">(</span><span class="n">String</span> <span class="n">alkio</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">pino</span><span class="o">.</span><span class="na">push</span><span class="o">(</span><span class="n">kryptaa</span><span class="o">(</span><span class="n">alkio</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">empty</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">pino</span><span class="o">.</span><span class="na">empty</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="nf">dekryptaa</span><span class="o">(</span><span class="n">String</span> <span class="n">alkio</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">dekryptattu</span> <span class="o">=</span> <span class="s">""</span><span class="o">;</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">alkio</span><span class="o">.</span><span class="na">length</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">dekryptattu</span> <span class="o">+=</span> <span class="o">(</span><span class="kt">char</span><span class="o">)(</span><span class="n">alkio</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="n">i</span><span class="o">)-</span><span class="mi">1</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">dekryptattu</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="nf">kryptaa</span><span class="o">(</span><span class="n">String</span> <span class="n">alkio</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">kryptattu</span> <span class="o">=</span> <span class="s">""</span><span class="o">;</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">alkio</span><span class="o">.</span><span class="na">length</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">kryptattu</span> <span class="o">+=</span> <span class="o">(</span><span class="kt">char</span><span class="o">)(</span><span class="n">alkio</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="n">i</span><span class="o">)+</span><span class="mi">1</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">kryptattu</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LokiPino</span> <span class="kd">extends</span> <span class="n">Pino</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="n">Pino</span> <span class="n">pino</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">PrintWriter</span> <span class="n">loki</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">LokiPino</span><span class="o">(</span><span class="n">Pino</span> <span class="n">pino</span><span class="o">,</span> <span class="n">PrintWriter</span> <span class="n">loki</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">pino</span> <span class="o">=</span> <span class="n">pino</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">loki</span> <span class="o">=</span> <span class="n">loki</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">pop</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">popattu</span> <span class="o">=</span> <span class="n">pino</span><span class="o">.</span><span class="na">pop</span><span class="o">();</span>
        <span class="n">loki</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"pop: "</span><span class="o">+</span><span class="n">popattu</span><span class="o">);</span>

        <span class="k">return</span> <span class="n">popattu</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">push</span><span class="o">(</span><span class="n">String</span> <span class="n">alkio</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">loki</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"push: "</span><span class="o">+</span><span class="n">alkio</span><span class="o">);</span>

        <span class="n">pino</span><span class="o">.</span><span class="na">push</span><span class="o">(</span><span class="n">alkio</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">empty</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">loki</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"empty: "</span><span class="o">+</span><span class="n">pino</span><span class="o">.</span><span class="na">empty</span><span class="o">());</span>

        <span class="k">return</span> <span class="n">pino</span><span class="o">.</span><span class="na">empty</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Periaate on sama, pinodekoraattorit <em>LokiPino</em> ja <em>KryptattuPino</em> delegoivat kaikki operaationsa sisältämilleen Pino-olioille. <em>LokiPino</em> kirjoittaa lokitiedostoon merkinnän jokaisesta pinoon kohdistuvasta operaatiosta. <em>KryptattuPino</em> taas kryptaa alkeellista algoritmia käyttäen jokaisen pinnon laitettavan merkkijonon ja dekryptaa pinosta otettavat merkkijonot takaisin selkokielisiksi.</p>

<p>Koska kaikki dekoraattorit perivät luokan <em>Pino</em>, voidaan dekoraattorille antaa parametriksi toinen dekoraattori. Esim. KryptattuLokiPino luodaan seuraavasti:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">PrintWriter</span> <span class="n">loki</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PrintWriter</span><span class="o">(</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="s">"loki.txt"</span><span class="o">)</span> <span class="o">);</span>
<span class="n">Pino</span> <span class="n">pino</span> <span class="o">=</span> <span class="k">new</span> <span class="n">KryptattuPino</span><span class="o">(</span> <span class="k">new</span> <span class="n">LokiPino</span><span class="o">(</span> <span class="k">new</span> <span class="n">Pino</span><span class="o">(),</span> <span class="n">loki</span> <span class="o">)</span> <span class="o">);</span>
</code></pre></div></div>

<p>Dekoroinnin avulla saamme siis suhteellisen vähällä ohjelmoinnilla pinolle paljon erilaisia ominaisuuskombinaatioita. Jos olisimme yrittäneet hoitaa kaiken normaalilla perinnällä, olisi luokkien määrä kasvanut eksponentiaalisesti eri ominaisuuksien määrän suhteen ja uusiokäytöstäkään ei olisi tullut mitään.</p>

<p>Dekorointi siis ei oleellisesti ole perintää vaan <em>delegointia</em>, jälleen kerran oliosuunnitteun periaate “favour composition over inheritance” on näyttänyt voimansa.</p>

<p>Lisää dekoraattori-suunnittelumallista esim. osoitteessa https://sourcemaking.com/ jadesign_patterns/decorator</p>

<h4 id="pinotehdas-viikko-6">Pinotehdas <span style="color:blue">[viikko 6]</span></h4>

<p>Eri ominaisuuksilla varustettujen pinojen luominen on käyttäjän kannalta hieman ikävää. Tehdään luomista helpottamaan pinotehtaan:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Pinotehdas</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="n">Pino</span> <span class="nf">prepaidPino</span><span class="o">(</span><span class="kt">int</span> <span class="n">krediitit</span><span class="o">){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">PrepaidPino</span><span class="o">(</span><span class="k">new</span> <span class="n">Pino</span><span class="o">(),</span> <span class="n">krediitit</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Pino</span> <span class="nf">lokiPino</span><span class="o">(</span><span class="n">PrintWriter</span> <span class="n">loki</span><span class="o">){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">LokiPino</span><span class="o">(</span><span class="k">new</span> <span class="n">Pino</span><span class="o">(),</span> <span class="n">loki</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Pino</span> <span class="nf">kryptattuPino</span><span class="o">(){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">KryptattuPino</span><span class="o">(</span><span class="k">new</span> <span class="n">Pino</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Pino</span> <span class="nf">kryptattuPrepaidPino</span><span class="o">(</span><span class="kt">int</span> <span class="n">krediitit</span><span class="o">){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">KryptattuPino</span><span class="o">(</span><span class="n">prepaidPino</span><span class="o">(</span><span class="n">krediitit</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Pino</span> <span class="nf">kryptattuLokiPino</span><span class="o">(</span><span class="n">PrintWriter</span> <span class="n">loki</span><span class="o">){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">KryptattuPino</span><span class="o">(</span><span class="n">lokiPino</span><span class="o">(</span><span class="n">loki</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Pino</span> <span class="nf">prepaidKryptattuLokiPino</span><span class="o">(</span><span class="kt">int</span> <span class="n">krediitit</span><span class="o">,</span> <span class="n">PrintWriter</span> <span class="n">loki</span><span class="o">){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">PrepaidPino</span><span class="o">(</span><span class="n">kryptattuLokiPino</span><span class="o">(</span><span class="n">loki</span><span class="o">),</span> <span class="n">krediitit</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// monta monta muuta rakentajaa...</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Tehdasluokka on ikävä ja sisältää hirveän määrän metodeja. Jos pinoon lisätään vielä ominaisuuksia, tulee factory karkaamaan käsistä.</p>

<p>Pinon luominen on kuitenkin tehtaan ansiosta helppoa:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Pinotehdas</span> <span class="n">tehdas</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Pinotehdas</span><span class="o">();</span>

<span class="n">Pino</span> <span class="n">omapino</span> <span class="o">=</span> <span class="n">tehdas</span><span class="o">.</span><span class="na">kryptattuPrepaidPino</span><span class="o">(</span><span class="mi">100</span><span class="o">);</span>
</code></pre></div></div>

<p>Kuten huomaamme, ei factory-suunnittelumalli ole tilanteeseen ideaali. Kokeillaan sen sijaan <em>rakentaja</em> (engl. builder) -suunnittelumallia:</p>

<h4 id="pinorakentaja-viikko-6">Pinorakentaja <span style="color:blue">[viikko 6]</span></h4>

<p>Rakentaja-suunnittelumalli sopii tilanteeseemme erittäin hyvin. Pyrkimyksenämme on mahdollistaa pinon luominen seuraavaan tyyliin:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Pinorakentaja</span> <span class="n">rakenna</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Pinorakentaja</span><span class="o">();</span>

<span class="n">Pino</span> <span class="n">pino</span> <span class="o">=</span> <span class="n">rakenna</span><span class="o">.</span><span class="na">prepaid</span><span class="o">(</span><span class="mi">10</span><span class="o">).</span><span class="na">kryptattu</span><span class="o">().</span><span class="na">pino</span><span class="o">();</span>
</code></pre></div></div>

<p>Rakentajan metodinimet ja rakentajan muuttujan nimi on valittu mielenkiinoisella tavalla. On pyritty mahdollisimman luonnollista kieltä muistuttavaan ilmaisuun pinon luonnissa. Kyseessä onkin oikeastaan <a href="https://martinfowler.com/bliki/DomainSpecificLanguage.html">DSL</a> (enhl. domain specific language) pinojen luomiseen!</p>

<p>Luodaan ensin rakentajasta perusversio, joka soveltuu vasta normaalien pinojen luomiseen:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Pinorakentaja</span> <span class="n">rakenna</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Pinorakentaja</span><span class="o">();</span>

<span class="n">Pino</span> <span class="n">pino</span> <span class="o">=</span> <span class="n">rakenna</span><span class="o">.</span><span class="na">pino</span><span class="o">();</span>
</code></pre></div></div>

<p>Saamme rakentajan ensimmäisen version toimimaan seuraavasti:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Pinorakentaja</span> <span class="o">{</span>
    <span class="n">Pino</span> <span class="n">pino</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">Pinorakentaja</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">pino</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Pino</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Pino</span> <span class="nf">pino</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">pino</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>eli kun <em>Rakentaja</em>-olio luodaan, rakentaja luo pinon. Rakentajan “rakennusvaiheen alla” olevan pinon voi pyytää rakentajalta kutsumalla metodia <em>pino()</em>.</p>

<p>Laajennetaan nyt rakentajaa siten, että voimme luoda prepaidpinoja seuraavasti:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Pinorakentaja</span> <span class="n">rakenna</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Pinorakentaja</span><span class="o">();</span>

<span class="n">Pino</span> <span class="n">pino</span> <span class="o">=</span> <span class="n">rakenna</span><span class="o">.</span><span class="na">prepaid</span><span class="o">(</span><span class="mi">10</span><span class="o">).</span><span class="na">pino</span><span class="o">();</span>
</code></pre></div></div>

<p>Jotta edellinen menisi kääntäjästä läpi, tulee rakentajalle lisätä metodi jonka signatuuri on <em>public Pinorakentaja prepaid(int kreditit)</em>, eli jotta metodin tuloksena olevalle oliolle voitaisiin kutsua metodia <em>pino</em>, on metodin <em>prepaid</em> palautettava rakentaja. Rakentajamme runko laajenee siis seuravasti:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Pinorakentaja</span> <span class="o">{</span>
    <span class="n">Pino</span> <span class="n">pino</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">Pinorakentaja</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">pino</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Pino</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Pinorakentaja</span> <span class="nf">prepaid</span><span class="o">(</span><span class="kt">int</span> <span class="n">kreditit</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// ????</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Pino</span> <span class="nf">pino</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">pino</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Rakentaja siis pitää oliomuuttujassa rakentumassa olevaa pinoa. Kun kutsumme rakentajalle metodia <em>prepaid</em> ideana on, että rakentaja dekoroi rakennuksen alla olevan pinon prepaid-pinoksi. Metodi palauttaa viitteen <em>this</em> eli rakentajan itsensä. Tämä mahdollistaa sen, että metodikutsun jälkeen päästään edelleen käsiksi työn alla olevaan pinoon. Koodi siis seuraavassa:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Pinorakentaja</span> <span class="o">{</span>
    <span class="n">Pino</span> <span class="n">pino</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">Pinorakentaja</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">pino</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Pino</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Pino</span> <span class="nf">pino</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">pino</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Pinorakentaja</span> <span class="nf">prepaid</span><span class="o">(</span><span class="kt">int</span> <span class="n">kreditit</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">pino</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PrepaidPino</span><span class="o">(</span><span class="n">pino</span><span class="o">,</span> <span class="n">kreditit</span><span class="o">);</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Samalla periaatteella lisätään rakentajalle metodit, joiden avulla työn alla oleva pino saadaan dekoroitua lokipinoksi tai kryptaavaksi pinoksi:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Pinorakentaja</span> <span class="o">{</span>
    <span class="n">Pino</span> <span class="n">pino</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">Pinorakentaja</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">pino</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Pino</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Pino</span> <span class="nf">pino</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">pino</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Pinorakentaja</span> <span class="nf">prepaid</span><span class="o">(</span><span class="kt">int</span> <span class="n">kreditit</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">pino</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PrepaidPino</span><span class="o">(</span><span class="n">pino</span><span class="o">,</span> <span class="n">kreditit</span><span class="o">);</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Pinorakentaja</span> <span class="nf">kryptattu</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">pino</span> <span class="o">=</span> <span class="k">new</span> <span class="n">KryptattuPino</span><span class="o">(</span><span class="n">pino</span><span class="o">);</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Pinorakentaja</span> <span class="nf">loggaava</span><span class="o">(</span><span class="n">PrintWriter</span> <span class="n">loki</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">pino</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LokiPino</span><span class="o">(</span><span class="n">pino</span><span class="o">,</span> <span class="n">loki</span><span class="o">);</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Rakentajan koodi voi vaikuttaa aluksi hieman hämmentävältä.</p>

<p>Rakentajaa siis käytetään seuraavasti:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Pinorakentaja</span> <span class="n">rakenna</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Pinorakentaja</span><span class="o">();</span>

<span class="n">Pino</span> <span class="n">pino</span> <span class="o">=</span> <span class="n">rakenna</span><span class="o">.</span><span class="na">kryptattu</span><span class="o">().</span><span class="na">prepaid</span><span class="o">(</span><span class="mi">10</span><span class="o">).</span><span class="na">pino</span><span class="o">();</span>
</code></pre></div></div>
<p>Tässä pyydettiin rakentajalta kryptattu prepaid-pino, jossa krediittejä on 10.</p>

<p>Vastaavalla tavalla voidaan luoda pinoja muillakin ominaisuuksilla:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Pinorakentaja</span> <span class="n">rakenna</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Pinorakentaja</span><span class="o">();</span>

<span class="n">Pino</span> <span class="n">pino1</span> <span class="o">=</span> <span class="n">rakenna</span><span class="o">.</span><span class="na">pino</span><span class="o">();</span>  <span class="c1">// luo normaalin pinon</span>
<span class="n">Pino</span> <span class="n">pino2</span> <span class="o">=</span> <span class="n">rakenna</span><span class="o">.</span><span class="na">kryptattu</span><span class="o">().</span><span class="na">loggaava</span><span class="o">(</span><span class="n">loki</span><span class="o">).</span><span class="na">prepaid</span><span class="o">.</span><span class="na">pino</span><span class="o">();</span>  <span class="c1">// luo sen mitä odottaa saattaa!</span>
</code></pre></div></div>

<p>Rakentajan toteutus perustuu tekniikkaan nimeltään <a href="http://en.wikipedia.org/wiki/Method_chaining">method chaining</a> eli metodikutsujen ketjutukseen. Metodit jotka ovat muuten luonteeltaan void:eja onkin laitettu palauttamaan rakentajaolio. Tämä taas mahdollistaa metodin kutsumisen toisen metodin palauttamalle rakentajalle, ja näin metodikutsuja voidaan ketjuttaa peräkkäin mielivaltainen määrä. Metodiketjutuksen motivaationa on yleensä saada olion rajapinta käytettävyydeltään mahdollisimman luonnollisen kielen kaltaiseksi DSL:ksi.</p>

<p>Tällä tekniikalla toteutetuista rajapinnoista käytetään myös nimitystä
<a href="https://martinfowler.com/bliki/FluentInterface.html">fluent interface</a>.</p>

  </div>

</article>
      </div>
    </main>

     <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading"></h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>
             Ohjelmistotuotanto avoin yliopisto 2020 
          </li>
          <li>
            <a href="mailto:matti.luukkainen@helsinki.fi">matti.luukkainen@helsinki.fi</a>
          </li>
          <li>
            <a href="https://github.com/mluukkai"><span class="icon icon--github"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">mluukkai</span></a>

          </li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
           
        </ul>
      </div>

      <div class="footer-col footer-col-3">
          <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/">
            <img alt="Creative Commons -lisenssi" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/3.0/88x31.png"
            />
          </a>
          <br/> Materiaali on lisensoitu
          <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/">Creative Commons BY-NC-SA 3.0 -lisenssillä</a>.
      </div>
    </div>

  </div>

</footer>
  
  </body>

</html>
