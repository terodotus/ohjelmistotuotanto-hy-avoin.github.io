<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Viikko 3</title>
  <meta name="description" content="">

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="http://localhost:4000/tehtavat3/">
  <link rel="alternate" type="application/rss+xml" title="Ohjelmistotuotanto avoin yliopisto 2020" href="/feed.xml">

  
</head>


  <body>
    
    <header class="site-header" role="banner">

  <div class="wrapper">
    
    
    <a class="site-title" href="/">Ohjelmistotuotanto avoin yliopisto 2020</a>
    
    
      <nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
              <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
              <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger">
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
            <a class="page-link" href="/osa0/">Osa 0</a>
            
          
            
            
            <a class="page-link" href="/osa1/">Osa 1</a>
            
          
            
            
            <a class="page-link" href="/osa2/">Osa 2</a>
            
          
            
            
            <a class="page-link" href="/osa3/">Osa 3</a>
            
          
            
            
            <a class="page-link" href="/osa4/">Osa 4</a>
            
          
            
            
            <a class="page-link" href="/osa5/">Osa 5</a>
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
            <a class="page-link" href="/tehtavat/">Tehtävät</a>
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
          
        </div>
      </nav>
    

    
  </div>
</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post">

  <header class="post-header">
    <h1 class="post-title"></h1>
  </header>

  <div class="post-content">
    <h2 id="viikko-3">Viikko 3</h2>

<p>Tehtävissä 1-3 tutustutaan siihen miten gradle-sovelluksiin lisätään ulkoisia kirjastoja riippuvuudeksi, sekä miten riippuvuuksia sisältävästä koodista saadaan generoitua jar-paketti. Loput tehtävät liittyvät storyjen hyväksymistestauksen automatisointiin tarkoitetun Cucumberin, sekä selainsovellusten testaamiseen käytettävän Selenium-kirjaston soveltamiseen.</p>

<h3 id="typoja-tai-epäselvyyksiä-tehtävissä">Typoja tai epäselvyyksiä tehtävissä?</h3>

<p>Tee <a href="/osa0#typoja-materiaalissa">korjausehdotus</a> editoimalla <a href="https://github.com/ohjelmistotuotanto-hy/ohjelmistotuotanto-hy.github.io/blob/master/tehtavat3.md">tätä</a> tiedostoa GitHubissa.</p>

<h3 id="tehtävien-palauttaminen">Tehtävien palauttaminen</h3>

<p>Tehtävät palautetaan GitHubiin, sekä merkitsemällä tehdyt tehtävät palautussovellukseen <a href="https://study.cs.helsinki.fi/stats/courses/ohtu-avoin-2020">https://study.cs.helsinki.fi/stats/courses/ohtu-avoin-2020</a></p>

<p>Katso tarkempi ohje palautusrepositorioita koskien <a href="/tehtavat1#teht%C3%A4vien-palautusrepositoriot">täältä</a>.</p>

<h3 id="huomio-gradleen-liittyen">Huomio gradleen liittyen</h3>

<p>Käytämme tälläkin viikolla gradle-muotoisia projekteja. Jos gradle-koodi lukee syötteitä komentoriviltä, tulee määrittelytiedostojen loppuun liittää seuraava</p>

<div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">run</span> <span class="o">{</span>
    <span class="n">standardInput</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">in</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Ilman tätä määrittelyä ohjelmaa gradlella suorittaessa, eli komennolla <code class="highlighter-rouge">gradle run</code>, ohjelma ei pääse käsiksi syötevirtaan ja scannerin luominen epäonnistuu.</p>

<p>Tämän viikon tehtäviin liittyviin projekteihin määrittely on jo lisätty.</p>

<p>Jos ohjelma lukee syötteitä käyttäjältä, kannattaa se suorittaa komennolla <code class="highlighter-rouge">gradle -q --console plain run</code>, jolloin gradlen tekemät tulostukset eivät tule konsoliin.</p>

<p><em>HUOM!</em> näyttää siltä, että NetBeans 11.1:llä Scanner ei toimi ollenkaan gradle-projekteissa, eli jos törmäät samaan ongelmaan, suorita ohjelmat komentoriviltä.</p>

<h3 id="1-lisää-gradlea-riippuvuuksien-lisääminen">1. lisää gradlea: riippuvuuksien lisääminen</h3>

<p>Hae kurssirepositorion <a href="https://github.com/ohjelmistotuotanto-hy/syksy2019">https://github.com/ohjelmistotuotanto-hy/syksy2019</a> hakemistossa viikko3/nhlreader lähes tyhjä gradle-projektin runko.</p>

<ul>
  <li>mukana on kohta tarvitsemasi luokka <em>Player</em></li>
</ul>

<p>Tehdään ohjelma, jonka avulla voi hakea <a href="https://nhl.com">https://nhl.com</a>-sivulta kuluvan kauden NHL-liigan tilastotietoja. Jos tarkkoja ollaan, niin tilastot haetaan tämän kurssin tarpeisiin rakennetulta palvelimelta, joka hakee todelliset tilastot NHL:n sivulta kerran vuorokaudessa.</p>

<p>Näet tilastojen <a href="https://en.wikipedia.org/wiki/JSON">json</a>-muotoisen raakadatan web-selaimella osoitteesta <a href="https://nhlstatisticsforohtu.herokuapp.com/players">https://nhlstatisticsforohtu.herokuapp.com/players</a></p>

<p>Tee ohjelma, joka listaa <em>suomalaisten pelaajien</em> tilastot.</p>

<p>Ohjelmassa tarvitaan kahta kirjastoa eli <em>riippuvuutta</em>:</p>

<ul>
  <li>HTTP-pyynnön tekemiseen <a href="https://hc.apache.org/httpcomponents-client-ga/tutorial/html/fluent.html">Apache HttpClient Fluent API</a></li>
  <li>json-muotoisen merkkijonon muuttaminen olioksi <a href="http://code.google.com/p/google-gson/">http://code.google.com/p/google-gson/</a></li>
</ul>

<p>Kertaa nopeasti <a href="/gradle#riippuvuudet">viime viikolta</a>, miten gradle-projektin riippuvuudet määritellään. Tarvittaessa lisää tietoa löytyy <a href="https://docs.gradle.org/current/userguide/artifact_dependencies_tutorial.html">Gradlen manuaalista</a></p>

<p>Liitä projektisi <em>käännösaikaisiksi</em> (compile) riippuvuuksiksi</p>

<ul>
  <li><em>Apache HttpClient Fluent API</em> ja <em>gson</em></li>
  <li>löydät riippuvuuksien tiedot osoitteesta <a href="http://mvnrepository.com/">http://mvnrepository.com/</a></li>
  <li>Ota molemmista uusin versio</li>
</ul>

<p>Voit ottaa projektisi pohjaksi seuraavan tiedoston:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="n">ohtu</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.google.gson.Gson</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.http.client.fluent.Request</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Main</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">url</span> <span class="o">=</span> <span class="s">"https://nhlstatisticsforohtu.herokuapp.com/players"</span><span class="o">;</span>
        
        <span class="n">String</span> <span class="n">bodyText</span> <span class="o">=</span> <span class="n">Request</span><span class="o">.</span><span class="na">Get</span><span class="o">(</span><span class="n">url</span><span class="o">).</span><span class="na">execute</span><span class="o">().</span><span class="na">returnContent</span><span class="o">().</span><span class="na">asString</span><span class="o">();</span>
                
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"json-muotoinen data:"</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span> <span class="n">bodyText</span> <span class="o">);</span>

        <span class="n">Gson</span> <span class="n">mapper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Gson</span><span class="o">();</span>
        <span class="n">Player</span><span class="o">[]</span> <span class="n">players</span> <span class="o">=</span> <span class="n">mapper</span><span class="o">.</span><span class="na">fromJson</span><span class="o">(</span><span class="n">bodyText</span><span class="o">,</span> <span class="n">Player</span><span class="o">[].</span><span class="na">class</span><span class="o">);</span>
        
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Oliot:"</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">Player</span> <span class="n">player</span> <span class="o">:</span> <span class="n">players</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">player</span><span class="o">);</span>
        <span class="o">}</span>   
    <span class="o">}</span>
  
<span class="o">}</span>
</code></pre></div></div>

<p>Tehtäväpohjassa on valmiina luokan <code>Player</code> koodin runko. Gson-kirjaston avulla json-muotoisesta datasta saadaan taulukollinen <code>Player</code>-olioita, joissa jokainen olio vastaa yhden pelaajan tietoja. Tee luokkaan oliomuuttujat (sekä tarvittaessa getterit ja setterit) kaikille json-datassa oleville kentille, joita ohjelmasi tarvitsee.</p>

<p>Ohjelmasi voi toimia esimerkiksi seuraavalla tavalla:</p>

<pre>
Players from FIN Wed Nov 06 23:31:32 EET 2019

Henrik Borgstrom team FLA goals 0 assists 0
Sami Niku team WPG goals 0 assists 0
Mikael Granlund team NSH goals 2 assists 2
Miikka Salomaki team NSH goals 1 assists 0
Roope Hintz team DAL goals 9 assists 2
Sebastian Aho team CAR goals 5 assists 5
Erik Haula team CAR goals 8 assists 3
Miro Heiskanen team DAL goals 4 assists 5
Markus Granlund team EDM goals 0 assists 1
Henri Jokiharju team BUF goals 1 assists 4
Joel Armia team MTL goals 6 assists 4
Artturi Lehkonen team MTL goals 2 assists 4
...
</pre>

<p>Tulostusasu ei tässä tehtävässä ole oleellista, eikä edes se mitä pelaajien tiedoista tulostetaan.</p>

<h3 id="2-siistimpi-pelaajalista">2. siistimpi pelaajalista</h3>

<p>Tulosta suomalaiset pelaajat pisteiden (goals + assists) mukaan järjestettynä. Tarkka tulostusasu ei ole taaskaan oleellinen, mutta se voi esimerkiksi näyttää seuraavalta:</p>

<pre>
Players from FIN Wed Nov 06 23:47:11 EET 2019

Aleksander Barkov   FLA   2 + 15 = 17
Patrik Laine        WPG   3 + 11 = 14
Mikko Rantanen      COL   5 +  7 = 12
Teuvo Teravainen    CAR   4 +  8 = 12
Roope Hintz         DAL   9 +  2 = 11
Erik Haula          CAR   8 +  3 = 11
Joel Armia          MTL   6 +  4 = 10
Sebastian Aho       CAR   5 +  5 = 10
Kasperi Kapanen     TOR   4 +  6 = 10
Miro Heiskanen      DAL   4 +  5 =  9
Joonas Donskoi      COL   5 +  3 =  8
Sami Vatanen        NJD   4 +  4 =  8
Artturi Lehkonen    MTL   2 +  4 =  6
Valtteri Filppula   DET   1 +  5 =  6
Mikko Koivu         MIN   1 +  5 =  6
Kaapo Kakko         NYR   3 +  2 =  5
Henri Jokiharju     BUF   1 +  4 =  5
Ville Heinola       WPG   1 +  4 =  5
Rasmus Ristolainen  BUF   0 +  5 =  5
...
</pre>

<h3 id="3-lisää-gradlea-jar-joka-sisältää-kaikki-riippuvuudet">3. lisää gradlea: jar joka sisältää kaikki riippuvuudet</h3>

<ul>
  <li>tehdään äskeisen tehtävän projektista jar-tiedosto komennolla <code>gradle jar</code></li>
  <li>suoritetaan ohjelma komennolla <code>java -jar build/libs/nhlreader.jar</code></li>
  <li>mutta ohjelma ei toimikaan, tulostuu:</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span> java <span class="nt">-jar</span> build/libs/nhlreader.jar
Exception <span class="k">in </span>thread <span class="s2">"main"</span> java.lang.NoClassDefFoundError: org/apache/http/client/fluent/Request
	at ohtu.Main.main<span class="o">(</span>Main.java:16<span class="o">)</span>
Caused by: java.lang.ClassNotFoundException: org.apache.http.client.fluent.Request
	at java.net.URLClassLoader.findClass<span class="o">(</span>URLClassLoader.java:381<span class="o">)</span>
	at java.lang.ClassLoader.loadClass<span class="o">(</span>ClassLoader.java:424<span class="o">)</span>
	at sun.misc.Launcher<span class="nv">$AppClassLoader</span>.loadClass<span class="o">(</span>Launcher.java:331<span class="o">)</span>
	at java.lang.ClassLoader.loadClass<span class="o">(</span>ClassLoader.java:357<span class="o">)</span>
	... 1 more
</code></pre></div></div>

<p>Mistä on kyse? Ohjelman riippuvuuksia eli projekteja Apache HttpClientin ja gson vastaavat jar-tiedostot eivät ole käytettävissä, joten ohjelma ei toimi.</p>

<p>Saamme generoitua ohjelmasta jar-tiedoston, joka sisältää myös kaikki riippuvuudet gradlen <a href="https://plugins.gradle.org/plugin/com.github.johnrengelman.shadow">shadow</a>-pluginin avulla.</p>

<p>Ota plugin käyttöön lisäämällä seuraava tiedoston <em>build.gradle</em> alkuun:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">plugins</span> <span class="o">{</span>
  <span class="n">id</span> <span class="err">'</span><span class="n">com</span><span class="o">.</span><span class="na">github</span><span class="o">.</span><span class="na">johnrengelman</span><span class="o">.</span><span class="na">shadow</span><span class="err">'</span> <span class="n">version</span> <span class="err">'</span><span class="mf">5.1</span><span class="o">.</span><span class="mi">0</span><span class="err">'</span>
<span class="o">}</span>
</code></pre></div></div>

<p><strong>HUOM:</strong> pluginin määrittely on lisättävä tiedoston <em>build.gradle</em> alkuun, muuten koko konfiguraatio hajoaa.</p>

<p>Tutki komennon <em>gradle tasks</em> avulla, miten saat muodostettua riippuvuudet sisältävän jarrin.</p>

<p>Generoi jar ja varmista, että ohjelma toimii komennolla <code>java -jar shadowilla_tehty_jar.jar</code></p>

<h3 id="4-tutustuminen-cucumberiin">4. Tutustuminen cucumberiin</h3>

<p>Lue <a href="/cucumber/">täällä</a> oleva Cucumber-johdanto ja tee siihen liittyvät tehtävät.</p>

<h3 id="5-kirjautumisen-testit">5. Kirjautumisen testit</h3>

<p>Hae <a href="https://github.com/ohjelmistotuotanto-hy/syksy2019">kurssirepositorion</a> hakemistossa <em>viikko3/LoginCucumber</em> oleva projekti.</p>

<p>Tutustu ohjelman rakenteeseen. Piirrä ohjelman rakenteesta UML-kaavio.</p>

<p>Huomaa, että ohjelman <em>AuthenticationService</em>-olio ei talleta suoraan User-oliota vaan epäsuorasti <em>UserDAO</em>-rajapinnan kautta. Mistä on kysymys?</p>

<blockquote>
  <p>DAO eli Data Access Object on yleisesti käytetty suunnittelumalli jonka avulla abstrahoidaan sovellukselta se, miten oliot on talletettu, ks. esim. <a href="https://www.oracle.com/technetwork/java/dataaccessobject-138824.html">https://www.oracle.com/technetwork/java/dataaccessobject-138824.html</a></p>

  <p>Ideana on, että sovellus “hakee” ja “tallettaa” User-oliot aina UserDAO-rajapinnan metodeja käyttäen. Sovellukselle on injektoitu konkreettinen toteutus, joka tallettaa oliot esim. tietokantaan tai tiedostoon. Se minne ja miten talletus tapahtuu on kuitenkin läpinäkyvää sovelluksen muiden osien kannalta.</p>

  <p>Ohjelmaamme on määritelty testauskäyttöön sopiva InMemoryUserDao, joka tallettaa User-oliot ainoastaan muistiin. Muu ohjelma säilyisi täysin muuttumattomana jos määriteltäisiin esim. SqliteUserDao, joka hoitaa talletuksen tietokantaan ja injektoitaisiin tämä sovellukselle.</p>
</blockquote>

<p>Kokeile ohjelman suorittamista (ohjelman tuntemat komennot ovat <em>login</em> ja <em>new</em>) ja suorita siihen liittyvät testit.</p>

<p><em>Muistutus</em>: saat suoritettua ohjelman ilman gradlen välitulostuksia komennolla <em>gradle run –console=plain</em></p>

<p>Tutki miten testien stepit on määritelty suoritettavaksi tiedostossa <em>src/test/java/ohtu/StepDefs.java</em> 
Huomioi erityisesti, miten testit käyttävät testaamisen mahdollistavaa stub-olioa käyttäjän syötteen ja ohjelman tulosteen käsittelyyn. Periaate on täsmälleen sama kuin viikon 1 tehtävien <a href="/riippuvuuksien_injektointi/">riippuvuuksien injektointiin</a> liittyvässä esimerkissä.</p>

<p>Lisää user storylle <em>User can log in with valid username/password-combination</em> seuraavat skenaariot ja määrittele niihin sopivat <em>When</em> ja <em>Then</em> -stepit:</p>

<pre>
Scenario: user can not login with incorrect password
    Given command login is selected
    When  ...
    Then  ...

Scenario: nonexistent user can not login to 
    Given command login is selected
    When  ...
    Then  ...
</pre>

<p>Tee stepeistä suoritettavat ja varmista että testit menevät läpi.</p>

<h3 id="6-uuden-käyttäjän-rekisteröitymisen-testit">6. Uuden käyttäjän rekisteröitymisen testit</h3>

<p>Tee user storylle <em>A new user account can be created if a proper unused username and a proper password are given</em> seuraavat skenaariot ja niille sopivat stepit:</p>

<pre>
Feature: A new user account can be created if a proper unused username and password are given

    Scenario: creation is successful with valid username and password
        Given command new is selected
        When  ...
        Then  ...
    
    Scenario: creation fails with already taken username and valid password
        Given command new is selected
        When  ...
        Then  ...

    Scenario: creation fails with too short username and valid password
        Given command new is selected
        When  ...
        Then  ...

    Scenario: creation fails with valid username and too short password
        Given command new is selected
        When  ...
        Then  ...

    Scenario: creation fails with valid username and password long enough but consisting of only letters
        Given command new is selected
        When  ...
        Then  ...

    Scenario: can login with successfully generated account
        Given user "eero" with password "salainen1" is created
        And   command login is selected
        When  ...
        Then  ...  
</pre>

<ul>
  <li>käyttäjätunnuksen on oltava merkeistä a-z koostuva vähintään 3 merkin pituinen merkkijono, joka ei ole vielä käytössä</li>
  <li>salasanan on oltava pituudeltaan vähintään 8 merkkiä ja se ei saa koostua pelkästään kirjaimista (<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Character.html">vihje</a>)</li>
</ul>

<p>Tee stepeistä suoritettavia ja <strong>täydennä ohjelmaa siten että testit menevät läpi</strong>. Oikea paikka koodiin tuleville muutoksille on luokan <em>AuthenticationService</em> metodi <em>invalid</em></p>

<p><strong>HUOM</strong> skenaarioita kannattaa toteuttaa yksi kerrallaan, laittaen samalla vastaava ominaisuus ohjelmasta kuntoon. Eli <strong>ÄLÄ</strong> copypastea ylläolevaa kerrallaan <em>feature</em>-tiedostoon, vaan etene pienin askelin. Jos yksi skenaario ei mene läpi, älä aloita uuden tekemistä ennen kuin kaikki ongelmat on selvitetty. Seuraava luku antaa muutaman vihjeen testien debuggaamiseen.</p>

<h3 id="cucumber-testien-debuggaaminen">Cucumber-testien debuggaaminen</h3>

<p>On todennäköistä että testien tekemisen aikana tulee ongelmia, joiden selvittäminen ei ole triviaalia.</p>

<h4 id="suoritettavien-testien-lukumäärän-rajoittaminen">Suoritettavien testien lukumäärän rajoittaminen</h4>

<p>Jos näin käy, kannattaa ongelmaa selvitellessä suorittaa ainoastaan yhtä testiä kerrallaan. Tämä onnistuu merkkaamalla ongelmallinen testi <em>tagilla</em>, eli <em>@</em>-merkillä alkavalla merkkijonolla. Seuraavassa on merkattu eräs testiskenaario tagilla <em>@problem</em>:</p>

<pre>
Feature: User can log in with valid username/password-combination

    // ...

    @problem
    Scenario: user can not login with incorrect password
        Given command login is selected
        When  username "pekka" and password "wrong" are entered
        Then  system will respond with "wrong username or password"

    // ...
</pre>

<p>Määrittelemällä luokkaan <em>RunCucumberTest</em> annotaatiolle <em>@CucumberOptions</em> parametri <em>tags</em>, on mahdollista säädellä mitä testejä Cucumber suorittaa:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RunWith</span><span class="o">(</span><span class="n">Cucumber</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@CucumberOptions</span><span class="o">(</span>
    <span class="n">plugin</span> <span class="o">=</span> <span class="s">"pretty"</span><span class="o">,</span> 
    <span class="n">features</span> <span class="o">=</span> <span class="s">"src/test/resources/ohtu"</span><span class="o">,</span> 
    <span class="n">snippets</span> <span class="o">=</span> <span class="n">SnippetType</span><span class="o">.</span><span class="na">CAMELCASE</span><span class="o">,</span>
    <span class="n">tags</span> <span class="o">=</span> <span class="o">{</span> <span class="s">"@problem"</span> <span class="o">}</span>
<span class="o">)</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RunCucumberTest</span> <span class="o">{}</span>
</code></pre></div></div>

<p>Näin määriteltynä tulee suoritetuksi ainoastaan tagilla <em>@problem</em> merkitty testi.</p>

<p>Sama tagi on mahdollista liittää myös useampaan skenaarioon, tai suoraan featureen, jolloin jokainen featureen liittyvä story tulee tagatyksi.</p>

<h4 id="println-debuggaus">println-debuggaus</h4>

<p>Myös vanha kunnon println-debuggaus toimii Cucumberin yhteydessä. Voit lisäillä println-komentoja testattavassa tai testikoodissa koodissa:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Then</span><span class="o">(</span><span class="s">"system will respond with {string}"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">systemWillRespondWith</span><span class="o">(</span><span class="n">String</span> <span class="n">expectedOutput</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ohjelma tulosti seuraavat rivit "</span><span class="o">+</span><span class="n">io</span><span class="o">.</span><span class="na">getPrints</span><span class="o">());</span>
    <span class="n">assertTrue</span><span class="o">(</span><span class="n">io</span><span class="o">.</span><span class="na">getPrints</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="n">expectedOutput</span><span class="o">));</span>
<span class="o">}</span>    
</code></pre></div></div>

<h3 id="7-weblogin">7. WebLogin</h3>

<p>Tarkastellaan edellisestä tehtävästä tutun toiminnallisuuden tarjoamaa esimerkkiprojektia, joka löytyy <a href="https://github.com/ohjelmistotuotanto-hy/syksy2019">kurssirepositorion</a> hakemistossa <em>viikko3/WebLogin</em> oleva projekti.</p>

<p>Sovellus on toteutettu <a href="http://sparkjava.com">Spark</a>-nimisellä minimalistisella Web-sovelluskehyksellä. Spark on osalle kenties tuttu kurssilta <a href="https://tietokantojen-perusteet.github.io">Tietokantojen perusteet</a>.</p>

<p><strong>Hae projekti ja käynnistä se komennolla</strong> <code>gradle run</code></p>

<p>Pääset käyttämään sovellusta avaamalla selaimella osoitteen <a href="http://localhost:4567">http://localhost:4567</a></p>

<p><img src="http://localhost:4000/images/lh3-2.png" alt="" height="200px" /></p>

<p>Sovellus siis toimii <em>localhostilla</em> eli paikallisella koneellasi <em>portissa</em> 4567.</p>

<p>Sovelluksen rakenne on suunnilleen sama kuin tehtävien 4-6 ohjelmassa. Poikkeuksen muodostaa pääohjelma, joka sisältää selaimen tekemät HTTP-pyynnöt. Tässä vaiheessa ei ole tarpeen tuntea HTTP-pyyntöjä käsittelevää koodia kovin tarkasti. Katsotaan kuitenkin pintapuolisesti mistä on kysymys.</p>

<p>Polulle “/” eli sovelluksen juureen, osoitteeseen <a href="http://localhost:4567">http://localhost:4567</a> tulevat pyynnöt käsittelee mainista seuraava koodinpätkä:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">get</span><span class="o">(</span><span class="s">"/"</span><span class="o">,</span> <span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
  <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">model</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
  <span class="n">model</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"template"</span><span class="o">,</span> <span class="s">"templates/index.html"</span><span class="o">);</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nf">ModelAndView</span><span class="o">(</span><span class="n">model</span><span class="o">,</span> <span class="n">LAYOUT</span><span class="o">);</span>
<span class="o">},</span> <span class="k">new</span> <span class="n">VelocityTemplateEngine</span><span class="o">());</span>             
</code></pre></div></div>

<p>Koodi muodostaa luokan <em>VelocityTemplateEngine</em> avulla hakemistossa <em>templates/index.html</em> olevan “templateen” perustuvan HTML-sivun, ja palauttaa sen käyttäjän selaimelle.</p>

<p>Sivun HTML-koodi on seuraava:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="n">Ohtu</span> <span class="n">App</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">ul</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">li</span><span class="o">&gt;&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s">"login"</span><span class="o">&gt;</span><span class="n">login</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;&lt;/</span><span class="n">li</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">li</span><span class="o">&gt;&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s">"user"</span><span class="o">&gt;</span><span class="n">register</span> <span class="k">new</span> <span class="n">user</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;&lt;/</span><span class="n">li</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">ul</span><span class="o">&gt;</span>
</code></pre></div></div>

<p>Kaikki <em>get</em>-alkuiset määrittelyt ovat samanlaisia, ne ainoastaan muodostavat HTML-sivun (joiden sisällön määrittelevät templatet sijaitsevat hakemistossa <em>templates</em>) ja palauttavat sivun selaimelle.</p>

<p><em>post</em>-alkuiset määrittelyt ovat monimutkaisempia, ne käsittelevät lomakkeiden avulla lähetettyä tietoa. Esimerkiksi käyttäjän kirjautumisyrityksen käsittelee seuraava koodi:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">post</span><span class="o">(</span><span class="s">"/login"</span><span class="o">,</span> <span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
  <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">model</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
  <span class="n">String</span> <span class="n">username</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">queryParams</span><span class="o">(</span><span class="s">"username"</span><span class="o">);</span>
  <span class="n">String</span> <span class="n">password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">queryParams</span><span class="o">(</span><span class="s">"password"</span><span class="o">);</span>
  
  <span class="k">if</span> <span class="o">(</span> <span class="o">!</span><span class="n">authenticationService</span><span class="o">().</span><span class="na">logIn</span><span class="o">(</span><span class="n">username</span><span class="o">,</span> <span class="n">password</span><span class="o">)</span> <span class="o">)</span> <span class="o">{</span>
    <span class="n">model</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"error"</span><span class="o">,</span> <span class="s">"invalid username or password"</span><span class="o">);</span>
    <span class="n">model</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"template"</span><span class="o">,</span> <span class="s">"templates/login.html"</span><span class="o">);</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">ModelAndView</span><span class="o">(</span><span class="n">model</span><span class="o">,</span> <span class="n">LAYOUT</span><span class="o">);</span>
  <span class="o">}</span>
      
  <span class="n">response</span><span class="o">.</span><span class="na">redirect</span><span class="o">(</span><span class="s">"/ohtu"</span><span class="o">);</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nf">ModelAndView</span><span class="o">(</span><span class="n">model</span><span class="o">,</span> <span class="n">LAYOUT</span><span class="o">);</span>
<span class="o">},</span> <span class="k">new</span> <span class="n">VelocityTemplateEngine</span><span class="o">());</span>
</code></pre></div></div>

<p>Koodi pääsee käsiksi käyttäjän <em>lomakkeen</em> avulla lähettämiin tietoihin <em>request</em>-olion kautta:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">String</span> <span class="n">username</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">queryParams</span><span class="o">(</span><span class="s">"username"</span><span class="o">);</span>
<span class="n">String</span> <span class="n">password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">queryParams</span><span class="o">(</span><span class="s">"password"</span><span class="o">);</span>
</code></pre></div></div>

<p>Koodi käyttää metodikutsulla <code>authenticationService()</code> saamaansa <code>AuthenticationService</code>-oliota kirjautumisen onnistumisen varmistamiseen. Jos kirjautuminen ei onnistu, eli mennään <em>if</em>-haaraan, palataan kirjautumislomakkeelle. Lomakkeelle näytettäväksi liitetään virheilmoitus <em>invalid username or password</em>.</p>

<p>Tutustu nyt sovelluksen rakenteeseen ja toiminnallisuuteen. Saat sammutettua sovelluksen painamalla konsolissa ctrl+c tai ctrl+d.</p>

<h3 id="8-selenium-eli-web-selaimen-simulointi-ohjelmakoodista">8. Selenium, eli web-selaimen simulointi ohjelmakoodista</h3>

<p>Jatketaan saman sovelluksen parissa.</p>

<p><strong>Käynnistä websovellus edellisen tehtävän tapaan komentoriviltä.</strong> Varmista selaimella, että sovellus on päällä.</p>

<p><a href="http://docs.seleniumhq.org/projects/webdriver/">Selenium WebDriver</a> -kirjaston avulla on mahdollista simuloida selaimen käyttöä koodista käsin. Sovelluksen luokassa <em>ohtu.Tester.java</em> on “toinen pääohjelma”, jonka koodi on seuraava:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">WebDriver</span> <span class="n">driver</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ChromeDriver</span><span class="o">();</span>

    <span class="n">driver</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"http://localhost:4567"</span><span class="o">);</span>
     
    <span class="n">WebElement</span> <span class="n">element</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="na">findElement</span><span class="o">(</span><span class="n">By</span><span class="o">.</span><span class="na">linkText</span><span class="o">(</span><span class="s">"login"</span><span class="o">));</span>
    <span class="n">element</span><span class="o">.</span><span class="na">click</span><span class="o">();</span>

    <span class="n">element</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="na">findElement</span><span class="o">(</span><span class="n">By</span><span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="s">"username"</span><span class="o">));</span>
    <span class="n">element</span><span class="o">.</span><span class="na">sendKeys</span><span class="o">(</span><span class="s">"pekka"</span><span class="o">);</span>
    <span class="n">element</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="na">findElement</span><span class="o">(</span><span class="n">By</span><span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="s">"password"</span><span class="o">));</span>
    <span class="n">element</span><span class="o">.</span><span class="na">sendKeys</span><span class="o">(</span><span class="s">"akkep"</span><span class="o">);</span>
    <span class="n">element</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="na">findElement</span><span class="o">(</span><span class="n">By</span><span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="s">"login"</span><span class="o">));</span>
    <span class="n">element</span><span class="o">.</span><span class="na">submit</span><span class="o">();</span>

    <span class="n">driver</span><span class="o">.</span><span class="na">quit</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Avaa toinen terminaali ja suorita siellä komento <em>gradle browse</em>, joka on konfiguroitu suorittamaan luokan <em>Tester</em> metodin <em>main</em> koodi.</p>

<p><strong>HUOM:</strong> osalla on ollut ongelmia Seleniumin kanssa. <a href="/selenium_troubleshooting/">Tänne</a> on koottu joitain tapoja, miten ongelmia on saatu ratkaistua. Jos törmäät ongelmaan ja saat sen ratkaistua jollain em. dokumentissa mainitsemattomalla tavalla, lisää ohje dokumenttiin.</p>

<p>Seuraa avautuvasta selaimesta mitä tapahtuu.</p>

<p>Tester-ohjelmassa luodaan alussa selainta koodista käsin käyttävä olio <em>WebDriver driver</em>. Tämän jälkeen mennään selaimella osoitteeseen <em>localhost:4567</em>.</p>

<p>Kahden sekunnin odottelun jälkeen haetaan sivulta elementti, jossa on linkkiteksti <em>login</em> ja linkkiä klikataan:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">WebElement</span> <span class="n">element</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="na">findElement</span><span class="o">(</span><span class="n">By</span><span class="o">.</span><span class="na">linkText</span><span class="o">(</span><span class="s">"login"</span><span class="o">));</span>
<span class="n">element</span><span class="o">.</span><span class="na">click</span><span class="o">();</span>
</code></pre></div></div>

<p>Seuraavaksi etsitään sivulta elementti, jonka nimi on <em>username</em>, kyseessä on lomakkeen input-kenttä, ja ohjelma “kirjoittaa” kenttään metodia <code>sendKeys()</code> käyttäen nimen <em>“pekka”</em></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">element</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="na">findElement</span><span class="o">(</span><span class="n">By</span><span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="s">"username"</span><span class="o">));</span>
<span class="n">element</span><span class="o">.</span><span class="na">sendKeys</span><span class="o">(</span><span class="s">"pekka"</span><span class="o">);</span>
</code></pre></div></div>

<p>Mistä tiedetään, miten lomakkeen elementti tulee etsiä, eli miksi sen nimi oli nyt <em>username</em>?
Elementin nimi on määritelty tiedostossa <em>src/main/resources/templates/login.html</em>:</p>

<p><img src="http://localhost:4000/images/lh3-3.png" alt="" height="250px" /></p>

<p>Tämän jälkeen täytetään vielä salasanakenttä ja painetaan lomakkeessa olevaa nappia.</p>

<p>Ohjelma siis simuloi selaimen käyttöskenaarion, jossa kirjaudutaan sovellukseen.</p>

<p>Koodin seassa on kutsuttu sopivissa paikoin metodia <em>sleep</em>, joka hidastaa selainsimulaation etenemistä siten, että ihminenkin pystyy seuraamaan tapahtumia.</p>

<p><strong>Muuta nyt koodia siten, että läpikäyt seuraavat skenaariot</strong></p>

<ul>
  <li>epäonnistunut kirjautuminen: oikea käyttäjätunnus, väärä salasana</li>
  <li>uuden käyttäjätunnuksen luominen</li>
  <li>uuden käyttäjätunnuksen luomisen jälkeen tapahtuva ulkoskirjautuminen sovelluksesta</li>
</ul>

<p><strong>HUOM1:</strong> voit tehdä skenaariot yksi kerrallaan, kaiken main-metodiin, siten että laitat esim. kommentteihin muiden skenaarioiden koodin kun suoritat yhtä skernaariota</p>

<p><strong>HUOM2:</strong> salasanan varmistuskentän (confirm password) nimi on <em>passwordConfirmation</em></p>

<p><strong>HUOM3:</strong></p>

<p>Uuden käyttäjän luomisen kokeilua hankaloittaa se, että käyttäjänimen on oltava uniikki. Kannattanee generoida koodissa satunnaisia käyttäjänimiä esim. seuraavasti:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Random</span> <span class="n">r</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Random</span><span class="o">();</span>
    
<span class="n">element</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="na">findElement</span><span class="o">(</span><span class="n">By</span><span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="s">"username"</span><span class="o">));</span>
<span class="n">element</span><span class="o">.</span><span class="na">sendKeys</span><span class="o">(</span><span class="s">"arto"</span><span class="o">+</span><span class="n">r</span><span class="o">.</span><span class="na">nextInt</span><span class="o">(</span><span class="mi">100000</span><span class="o">));</span>
</code></pre></div></div>

<p><strong>HUOM3:</strong></p>

<p>Joskus linkin klikkaaminen Seleniumissa aiheuttaa poikkeuksen <em>StaleElementReferenceException</em></p>

<p>Käytännössä syynä on se, että Selenium yrittää klikata linkkiä “liian aikaisin”. Ongelma on mahdollista kiertää klikkaamalla poikkeuksen tapahtuessa linkkiä uudelleen. Jos törmäät ongelmaan, voit ottaa koodiisi seuraavassa olevan apumetodin <em>clickLinkWithText</em>, joka suorittaa sopivan määrän uudelleenklikkauksia:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Tester</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">WebDriver</span> <span class="n">driver</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ChromeDriver</span><span class="o">();</span>

        <span class="n">driver</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"http://localhost:4567"</span><span class="o">);</span>
        
        <span class="n">clickLinkWithText</span><span class="o">(</span><span class="s">"register new user"</span><span class="o">,</span> <span class="n">driver</span><span class="o">);</span>

        <span class="c1">// ...</span>
    <span class="o">}</span>


    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">clickLinkWithText</span><span class="o">(</span><span class="n">String</span> <span class="n">text</span><span class="o">,</span> <span class="n">WebDriver</span> <span class="n">driver</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">trials</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="k">while</span><span class="o">(</span> <span class="n">trials</span><span class="o">++&lt;</span><span class="mi">5</span> <span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span><span class="o">{</span>
                <span class="n">WebElement</span> <span class="n">element</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="na">findElement</span><span class="o">(</span><span class="n">By</span><span class="o">.</span><span class="na">linkText</span><span class="o">(</span><span class="n">text</span><span class="o">));</span>
                <span class="n">element</span><span class="o">.</span><span class="na">click</span><span class="o">();</span>
                <span class="k">break</span><span class="o">;</span>           
            <span class="o">}</span> <span class="k">catch</span><span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getStackTrace</span><span class="o">());</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre></div></div>
<p>Lisää asiasta esimerkiksi <a href="https://stackoverflow.com/questions/12967541/how-to-avoid-staleelementreferenceexception-in-selenium">täällä</a>.</p>

<h3 id="9-web-sovelluksen-testaaminen-cucumberselenium">9. Web-sovelluksen testaaminen: Cucumber+Selenium</h3>

<p>Tehdään nyt sovellukselle hyväksymätestejä <a href="/cucumber/">Cucumberilla</a>.</p>

<p>Projektissa on valmiina User storystä <em>As a registered user can log in with valid username/password-combination</em> kaksi eri <em>feature</em>-määrittelyä:</p>
<ul>
  <li><em>logging_in.feature</em> ja</li>
  <li><em>logging_in_antipattern.feature</em></li>
</ul>

<p>Näistä ensimmäinen, eli <em>logging_in.feature</em> on tehty “hyvien käytäntöjen” mukaan ja jälkimmäinen eli <em>logging_in_antipattern.feature</em> on taas huonompi.</p>

<p>Huonommassa versiossa skenaarioiden stepeistä on tehty monikäyttöisemmät. Sekä onnistuneet että epäonnistuneen skenaariot käyttävät samoja steppejä ja eroavat ainoastaan parametreiltaan:</p>

<div class="language-gherkin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">Feature</span><span class="p">:</span> As a registered user can log in with valid username/password-combination

    <span class="kn">Scenario</span><span class="p">:</span> user can login with correct password
        <span class="nf">Given </span>login is selected
        <span class="nf">When </span>username <span class="s">"jukka"</span> and password <span class="s">"akkuj"</span> are given
        <span class="nf">Then </span>system will respond <span class="s">"Ohtu Application main page"</span>

    <span class="kn">Scenario</span><span class="p">:</span> user can not login with incorrect password
        <span class="nf">Given </span>login is selected
        <span class="nf">When </span>username <span class="s">"jukka"</span> and password <span class="s">"wrong"</span> are given
        <span class="nf">Then </span>system will respond <span class="s">"invalid username or password"</span>
</code></pre></div></div>

<p>Paremmassa versiossa taas stepit ovat erilaiset, paremmin tilannetta kuvaavat:</p>

<div class="language-gherkin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">Feature</span><span class="p">:</span> As a registered user can log in with valid username/password-combination

    <span class="kn">Scenario</span><span class="p">:</span> user can login with correct password
        <span class="nf">Given </span>login is selected
        <span class="nf">When </span>correct username <span class="s">"jukka"</span> and password <span class="s">"akkuj"</span> are given
        <span class="nf">Then </span>user is logged in

    <span class="kn">Scenario</span><span class="p">:</span> user can not login with incorrect password
        <span class="nf">Given </span>login is selected
        <span class="nf">When </span>correct username <span class="s">"jukka"</span> and incorrect password <span class="s">"wrong"</span> are given
        <span class="nf">Then </span>user is not logged in and error message is given
</code></pre></div></div>

<p>Tästä seurauksena on se, että stepit mappaavia metodeja tulee suurempi määrä. Metodit kannattaakin määritellä siten, että ne kutsuvat testejä varten määriteltyjä apumetodeita, jotta koodiin ei tule turhaa toistoa:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nd">@When</span><span class="o">(</span><span class="s">"correct username {string} and password {string} are given"</span><span class="o">)</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">correctUsernameAndPasswordAreGiven</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">,</span> <span class="n">String</span> <span class="n">password</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">logInWith</span><span class="o">(</span><span class="n">username</span><span class="o">,</span> <span class="n">password</span><span class="o">);</span>
  <span class="o">}</span>    

  <span class="nd">@When</span><span class="o">(</span><span class="s">"correct username {string} and incorrect password {string} are given"</span><span class="o">)</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">correctUsernameAndIncorrectPasswordAreGiven</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">,</span> <span class="n">String</span> <span class="n">password</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">logInWith</span><span class="o">(</span><span class="n">username</span><span class="o">,</span> <span class="n">password</span><span class="o">);</span>
  <span class="o">}</span>    

<span class="kd">private</span> <span class="kt">void</span> <span class="nf">logInWith</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">,</span> <span class="n">String</span> <span class="n">password</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">assertTrue</span><span class="o">(</span><span class="n">driver</span><span class="o">.</span><span class="na">getPageSource</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="s">"Give your credentials to login"</span><span class="o">));</span>
    <span class="n">WebElement</span> <span class="n">element</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="na">findElement</span><span class="o">(</span><span class="n">By</span><span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="s">"username"</span><span class="o">));</span>
    <span class="n">element</span><span class="o">.</span><span class="na">sendKeys</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
    <span class="n">element</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="na">findElement</span><span class="o">(</span><span class="n">By</span><span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="s">"password"</span><span class="o">));</span>
    <span class="n">element</span><span class="o">.</span><span class="na">sendKeys</span><span class="o">(</span><span class="n">password</span><span class="o">);</span>
    <span class="n">element</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="na">findElement</span><span class="o">(</span><span class="n">By</span><span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="s">"login"</span><span class="o">));</span>
    <span class="n">element</span><span class="o">.</span><span class="na">submit</span><span class="o">();</span>  
<span class="o">}</span>     
</code></pre></div></div>

<p>Vaikka siis kuvaavammin kirjoitetut stepit johtavatkin hieman suurempaan määrään mappayksestä huolehtivaa koodia, on stepit syytä kirjata mahdollisimman kuvaavasti ja huolehtia detaljeista mappaavan koodin puolella. Stepit mappaavien eri metodien samankaltainen koodi kannattaa ehdottomasti eriyttää omiin apumetodeihin, kuten esimerkissäkin tapahtuu (metodit <em>logInWith</em> ja <em>pageHasContent</em>).</p>

<p>Testien konfiguraatioon liittyy vielä muutama detalji. Testit alustava luokka <code>RunCucumberTest</code> on nyt seuraava:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RunWith</span><span class="o">(</span><span class="n">Cucumber</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@CucumberOptions</span><span class="o">(</span>
    <span class="n">plugin</span> <span class="o">=</span> <span class="s">"pretty"</span><span class="o">,</span> 
    <span class="n">features</span> <span class="o">=</span> <span class="s">"src/test/resources/ohtu"</span><span class="o">,</span> 
    <span class="n">snippets</span> <span class="o">=</span> <span class="n">SnippetType</span><span class="o">.</span><span class="na">CAMELCASE</span> 
<span class="o">)</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RunCucumberTest</span> <span class="o">{</span>
    <span class="nd">@ClassRule</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">ServerRule</span> <span class="n">server</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ServerRule</span><span class="o">(</span><span class="mi">4567</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Luokka määrittelee testeille <a href="https://github.com/junit-team/junit4/wiki/rules#classrule">ClassRule</a>:n, eli joukon toimenpiteitä, jotka suoritetaan ennen kuin testien suoritus aloitetaan ja kun testien suoritus on ohi. Toimenpiteet määrittelevä luokka <code>ServerRule</code> näyttää seuraavalta:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ServerRule</span> <span class="kd">extends</span> <span class="n">ExternalResource</span> <span class="o">{</span>
    
    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">port</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">ServerRule</span><span class="o">(</span><span class="kt">int</span> <span class="n">port</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">port</span> <span class="o">=</span> <span class="n">port</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">before</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
        <span class="n">Spark</span><span class="o">.</span><span class="na">port</span><span class="o">(</span><span class="n">port</span><span class="o">);</span>
        <span class="n">UserDao</span> <span class="n">dao</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UserDaoForTests</span><span class="o">();</span>
        <span class="n">dao</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">User</span><span class="o">(</span><span class="s">"jukka"</span><span class="o">,</span> <span class="s">"akkuj"</span><span class="o">));</span>
        <span class="n">Main</span><span class="o">.</span><span class="na">setDao</span><span class="o">(</span><span class="n">dao</span><span class="o">);</span>
        <span class="n">Main</span><span class="o">.</span><span class="na">main</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">after</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">Spark</span><span class="o">.</span><span class="na">stop</span><span class="o">();</span>
    <span class="o">}</span>
    
<span class="o">}</span>
</code></pre></div></div>

<p>Metodi <code>before</code> käynnistää web-sovelluksen <em>ennen testien suorittamista</em> (komento <em>Main.main(null)</em>). Web-sovellukselle myös injektoidaan testejä varten tehty <em>UserDao</em>-olio, jolle on lisätty yksi käyttäjä- ja salasana.</p>

<p>Metodi <code>after</code> sulkee web-sovelluksen testien päätteeksi.</p>

<p>Suorita nyt testit komennolla <code>gradle test</code></p>

<p>Huomaa, että testit käynnistävät sovelluksen samaan porttiin kuin sovellus käynnistyy komennolla <code>gradle run</code>. Jos saat  virheilmoituksen:</p>

<pre>
FAILURE: Build failed with an exception.

* What went wrong:
Execution failed for task ':test'.
&gt; Process 'Gradle Test Executor 6' finished with non-zero exit value 100
  This problem might be caused by incorrect test process configuration.
  Please refer to the test execution section in the User Manual at https://docs.gradle.org/5.6.3/userguide/java_testing.html#sec:test_execution

* Try:
Run with --stacktrace option to get the stack trace. Run with --debug option to get more log output. Run with --scan to get full insights.
</pre>

<p>syynä on todennäköisesti se, että sovellus on päällä. Joudutkin sulkemaan sovelluksen testien suorittamisen ajaksi.</p>

<p>Jos Seleniumin kanssa oli ongelmia ja käytit HtmlUnitDriveria niin määrittele luokassa Stepdefs driver kentäksi new HtmlUnitDriver();</p>

<p>Jos haluat pitää sovelluksen päällä testatessasi, käynnistä se johonkin muuhun portiin, esim. komento 
<code>PORT=4569 gradle run</code> käynnistää sovelluksen porttiin 4569.</p>

<p>Voit nyt halutessasi poistaa testien huonon version eli tiedoston <em>logging_in_antipattern.feature</em> ja siihen liittyvät Java-stepit.</p>

<p><strong>Lisää</strong> User storylle <em>User can log in with valid username/password-combination</em> seuraava skenaario ja määrittele sille sopivat <em>When</em> ja <em>Then</em> -stepit:</p>

<pre>
Scenario: nonexistent user can not login to 
    Given login is selected
    When  ...
    Then  ...
</pre>

<p>Tee steppien nimistä kuvaavasti nimettyjä.</p>

<p><strong>Protip</strong> jos et saa jotain testiä menemään läpi, kannattaa “pysäyttää” testin suoritus ongelmalliseen paikkaan lisäämällä stepin koodiin esim. rivi</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">try</span><span class="o">{</span> <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">120000</span><span class="o">);</span> <span class="o">}</span> <span class="k">catch</span><span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">){}</span>  <span class="c1">// suoritus pysähtyy 120 sekunniksi</span>
</code></pre></div></div>
<p>ja tarkastella sitten ohjelman tilaa testin käyttämästä selaimesta.</p>

<p><em>HUOM</em>: konsoliin tulostuu seuraava <em>STANDARD_ERROR</em> jota ei tarvitse välittää:</p>

<pre>
ohtu.RunCucumberTest STANDARD_ERROR
    SLF4J: Failed to load class "org.slf4j.impl.StaticLoggerBinder".
    SLF4J: Defaulting to no-operation (NOP) logger implementation
    SLF4J: See http://www.slf4j.org/codes.html#StaticLoggerBinder for further details.
</pre>

<h3 id="10-web-sovelluksen-testaaminen-osa-2">10. Web-sovelluksen testaaminen osa 2</h3>

<p><strong>HUOM:</strong> saat testien suorituksen huomattavasti nopeammaksi käyttämällä ChromeDriverin sijaan <a href="https://github.com/SeleniumHQ/selenium/wiki/HtmlUnitDriver">HtmlUnitDriver</a>:iä joka ns. headless- eli käyttöliittymätön selain.</p>

<p>HtmlUnitDriver vaikeuttaa testien debuggaamista, joten jos jotain ongelmia ilmenee, kannattanee debuggaamiseen käyttää ChromeDriveriä.</p>

<p>Tee User storylle <em>A new user account can be created if a proper unused username and a proper password are given</em> seuraavat skenaariot ja niille sopivat stepit:</p>

<pre>
Feature: A new user account can be created if a proper unused username and password are given

    Scenario: creation is successful with valid username and password
        Given command new user is selected
        When  a valid username "liisa" and password "salainen1" and matching password confirmation are entered
        Then  a new user is created

    Scenario: creation fails with too short username and valid password
        Given command new user is selected
        When  ...
        Then user is not created and error "username should have at least 3 characters" is reported   

    Scenario: creation fails with correct username and too short password
        Given command new user is selected
        When  ...
        Then user is not created and error "password should have at least 8 characters" is reported   

    Scenario: creation fails when password and password confirmation do not match
        Given command new user is selected
        When  ...
        Then user is not created and error "password and password confirmation do not match" is reported   
</pre>

<p>Käyttäjätunnus ja salasana noudattavat samoja sääntöjä kuin <em>tehtävässä 7</em> eli</p>
<ul>
  <li>käyttäjätunnuksen on oltava merkeistä a-z koostuva vähintään 3 merkin pituinen merkkijono, joka ei ole vielä käytössä</li>
  <li>salasanan on oltava pituudeltaan vähintään 8 merkkiä ja se ei saa koostua pelkästään kirjaimista</li>
</ul>

<p><strong>Laajenna koodiasi siten, että testit menevät läpi.</strong></p>

<h3 id="11-web-sovelluksen-testaaminen-osa-3">11. Web-sovelluksen testaaminen osa 3</h3>

<p>Tee User storylle <em>A new user account can be created if a proper unused username and a proper password are given</em> vielä seuraavat skenaariot ja niille sopivat stepit:</p>

<pre>
Scenario: user can login with successfully generated account
    Given user with username "lea" with password "salainen1" is successfully created
    And   login is selected
    When  ...
    Then  ...  

Scenario: user can not login with account that is not successfully created
    Given user with username "aa" and password "bad" is tried to be created
    And   login is selected
    When  ...
    Then  ...  
</pre>

<h3 id="tehtävien-palautus">Tehtävien palautus</h3>

<p>Pushaa kaikki tekemäsi tehtävät GitHubiin ja merkkaa tekemäsi tehtävät palautussovellukseen <a href="https://study.cs.helsinki.fi/stats/courses/ohtu-avoin-2020">https://study.cs.helsinki.fi/stats/courses/ohtu-avoin-2020</a></p>

<p>Huom! Varmista, että salasanat.txt on lisätty .gitignoreen. Jos ei ole, lisää se sinne. Et halua salasanojesi, edes testeissä käytettävien, päätyvän githubiin.</p>

  </div>

</article>
      </div>
    </main>

     <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading"></h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>
             Ohjelmistotuotanto avoin yliopisto 2020 
          </li>
          <li>
            <a href="mailto:matti.luukkainen@helsinki.fi">matti.luukkainen@helsinki.fi</a>
          </li>
          <li>
            <a href="https://github.com/mluukkai"><span class="icon icon--github"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">mluukkai</span></a>

          </li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
           
        </ul>
      </div>

      <div class="footer-col footer-col-3">
          <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/">
            <img alt="Creative Commons -lisenssi" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/3.0/88x31.png"
            />
          </a>
          <br/> Materiaali on lisensoitu
          <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/">Creative Commons BY-NC-SA 3.0 -lisenssillä</a>.
      </div>
    </div>

  </div>

</footer>
  
  </body>

</html>
